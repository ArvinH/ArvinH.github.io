{"componentChunkName":"component---src-templates-post-tsx","path":"/tech/use-context-selector-src-analysis","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>å¥½æ­Œåˆ†äº«ï¼š<a href=\"https://youtu.be/LN4rYKaNV1g\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">LINION - Mountain Dude feat.é›·æ“L8CHING</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/LN4rYKaNV1g\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h2 id=\"å‰è¨€\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"å‰è¨€ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å‰è¨€</h2>\n<p>æœ€è¿‘ç¶“æ‰‹çš„ä¸€å€‹å°ˆæ¡ˆæ¡ç”¨ React Hooks èˆ‡ Context API å¯¦ä½œé¡ä¼¼ Redux çš„ç‹€æ…‹ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨ <code class=\"language-text\">useReducer</code>ã€<code class=\"language-text\">createContext</code> ç­‰ API ä¾†å¯¦ä½œå…¨åŸŸçš„ Store èˆ‡ Dispatch Actionsã€‚</p>\n<p>é€™æ¨£åšå…¶å¯¦æŒºæ–¹ä¾¿çš„ï¼Œåœ¨ç‹€æ…‹ç®¡ç†çš„æµç¨‹ä¸Šè·Ÿ Redux çš„æ€ç¶­ä¸€æ¨£ï¼Œä½†è¨­ç½®ä¸Šæ›´ç‚ºç°¡å–®ã€‚</p>\n<p>ä¸éæœ‰å€‹å•é¡Œæ˜¯ï¼Œ<strong>ã„§ä½†ä»»ä½• context çš„å€¼æ›´æ–°ï¼Œæ‰€æœ‰ä½¿ç”¨ <code class=\"language-text\">useContext</code> çš„ component éƒ½æœƒè¢«é€šçŸ¥åˆ°ï¼Œä¸¦ä¸”é€²è¡Œ renderï¼Œå³ä¾¿è©² component éœ€è¦çš„ state å¯èƒ½æ ¹æœ¬æ²’æœ‰è®Šå‹•\u001dã€‚</strong></p>\n<p>ç°¡å–®çœ‹å€‹ç¯„ä¾‹(modified from <a href=\"https://github.com/dai-shi/use-context-selector/tree/master/examples/01_minimal\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>)ï¼š</p>\n<p><img src=\"/image/context-perf-issue-sample-flamegraph.gif\" alt=\"demo\"></p>\n<p>å¾ä¸Šåœ–ä¸­ devtool ä¸­çš„ flamegraph å¯ä»¥æ˜é¡¯çœ‹å‡ºç•¶é»é¸ Counter æ™‚ï¼ŒTextBox ä¹Ÿæœƒè§¸ç™¼ renderï¼Œå› ç‚ºä»–å€‘å…±äº«åŒä¸€å€‹ Contextã€‚</p>\n<p>é™„ä¸Š codesandbox ä¾›åƒè€ƒï¼ˆå¦å¤–ï¼Œé€™é‚Šæåˆ°çš„ render ä¸»è¦æ˜¯ VDOM çš„ renderï¼Œç¯„ä¾‹ä¸­ç‚ºäº†å‡¸é¡¯æ•ˆæœï¼Œåœ¨å…¶ä¸­æ”¾äº† Math.random() è®“ DOM ä¸€å®šæœƒæ›´æ–°ï¼Œå¦å‰‡å¯¦éš›ä¸Š TextBox åœ¨å€¼éƒ½ä¸è®Šçš„ç‹€æ…‹ä¸‹ï¼ŒDOM æ˜¯ä¸æœƒæ›´æ–°çš„ï¼‰ï¼š</p>\n<iframe src=\"https://codesandbox.io/embed/context-api-perf-issue-14v1r?autoresize=1&fontsize=14&hidenavigation=1&theme=dark\"\n  style=\"width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;\"\n  title=\"context-api-perf-issue\"\n  allow=\"accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking\"\n  sandbox=\"allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts\"\n></iframe>\n<p>å…ˆä¸è«–é é¢è¤‡é›œæ™‚å¯èƒ½æœƒæœ‰çš„æ½›åœ¨æ•ˆèƒ½å•é¡Œï¼Œå…‰æ˜¯æƒ³åˆ°æœƒæœ‰é€™ç¨®ç„¡è¬‚çš„ renderï¼Œæ‡‰è©²å¾ˆå¤šäººå°±æœƒè¦ºå¾—ä¸èˆ’æœã€‚</p>\n<p>è€Œå¯¦éš›ä¸Šï¼Œ<strong>Context API ä¸€é–‹å§‹å°±ä¸æ˜¯æ‹¿ä¾†çµ¦ä½ ä½œç”¨åœ¨æ›´æ–°é »ç‡é«˜çš„ç‹€æ…‹ä¸Šçš„ã€‚</strong></p>\n<p><a href=\"https://reactjs.org/docs/context.html#when-to-use-context\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å®˜æ–¹æ–‡ä»¶</a>é›–ç„¶æ²’æœ‰æ˜è¬›é€™ä»¶äº‹ï¼Œä½†å¾ä»–å€‘çµ¦çš„ç¯„ä¾‹åœç¹åœ¨ <code class=\"language-text\">theme</code> èˆ‡ <code class=\"language-text\">user data</code> å°±å¯ç•¥çŸ¥ä¸€äºŒï¼Œå¦å¤–åœ¨ react-redux v6 ç‰ˆæœ¬æ¨å‡ºæ™‚çš„<a href=\"https://github.com/reduxjs/react-redux/issues/1177#issue-406051556\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">è¨è«–</a>ä¸­ä¹Ÿæœ‰æåˆ°ã€‚</p>\n<p>æ‰€ä»¥æˆ‘å€‘æ‡‰è©²è¦å°±æ­¤æ‰“ä½ï¼Œæ”¹å›ç”¨ react-redux å—ï¼Ÿ</p>\n<p>ä¹Ÿä¸ä¸€å®šï¼Œå‰µé€ å‡ºå•é¡Œç„¶å¾Œè§£æ±ºï¼Œå°±æ˜¯å·¥ç¨‹å¸«çš„è·è²¬å•Šï¼Œæ€éº¼èƒ½é€ƒé¿ï¼</p>\n<p>ç©ç¬‘è©±ï¼Œå¯¦å‹™ä¸Šç•¶ç„¶è‡ªå·±æ–Ÿé…Œï¼Œå¦‚æœæ˜¯å…¬å¸å…§éƒ¨å°ˆæ¡ˆæˆ–æ˜¯ä½ è‡ªå·±çš„ side projectï¼Œç•¶ç„¶æ˜¯èƒ½å¤šå˜—è©¦å°±å˜—è©¦ï¼Œæˆ‘ä¸¦ä¸è¦ºå¾—ä¸€æ˜§éµå®ˆ best practice æ˜¯å¥½çš„ã€‚</p>\n<p>å¦å¤–ï¼Œå®˜æ–¹åœ˜éšŠä¹Ÿæ˜¯æœ‰<a href=\"https://twitter.com/acdlite/status/1250097231568334848\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">æ„è­˜åˆ°é€™ä»¶äº‹æƒ…</a></p>\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">We indeed have observed performance problems when propagating context to large trees. <a href=\"https://twitter.com/joshcstory?ref_src=twsrc%5Etfw\">@joshcstory</a> is doing some great research on how to make it better. We do have a plan, but it will require a significant refactor so it might take a while to land. <a href=\"https://t.co/gtpLEyfgU9\">https://t.co/gtpLEyfgU9</a></p>&mdash; Andrew Clark (@acdlite) <a href=\"https://twitter.com/acdlite/status/1250097231568334848?ref_src=twsrc%5Etfw\">April 14, 2020</a></blockquote> <script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n<p>ä¸¦ä¸”åœ¨ <a href=\"https://github.com/reactjs/rfcs/pull/119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC: Context selectors</a> ä¸­æ›¾æœ‰è »ç†±çµ¡çš„è¨è«–ï¼Œé›–ç„¶ä¾ç…§ç¾æ³ä¾†èªªæ²’æœ‰æ˜ç¢ºçš„è¨ˆåŠƒé‡å°é€™å€‹å•é¡Œå»åšæ”¹å–„ï¼Œä½† RFCs æå‡ºçš„æ¦‚å¿µå·²ç¶“æœ‰é¡ä¼¼å¯¦ä½œäº†ï¼Œè€Œä»Šå¤©æˆ‘å°±æ˜¯æƒ³è¦ä¾†è§£æã„§ä¸‹åˆ°åº•æ˜¯æ€éº¼åœ¨ä¸æ›´å‹•æ¶æ§‹ï¼Œåˆ©ç”¨ç¾æœ‰ API ä¸‹å»è§£æ±ºé€™å€‹å•é¡Œã€‚</p>\n<h2 id=\"è§£æ±ºæ–¹æ³•---usecontextselector\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95---usecontextselector\" aria-label=\"è§£æ±ºæ–¹æ³•   usecontextselector permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è§£æ±ºæ–¹æ³• - useContextSelector</h2>\n<p>é™¤äº†åœ¨é é¢ä¸è¤‡é›œçš„ç‹€æ…‹ä¸‹å¯ä»¥é€éçµ„åˆ<a href=\"https://github.com/reactjs/rfcs/pull/119#issuecomment-649848439\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å¤šå€‹ context</a> ä¾†è§£æ±ºï¼ŒåŒäº‹æ‰¾åˆ°çš„é€™å¥— lib - <a href=\"https://github.com/dai-shi/use-context-selector\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">use-context-selector</a> å¯¦ä½œäº† RFCs ä¸­çš„æ¦‚å¿µï¼Œæä¾›äº† <code class=\"language-text\">selector</code> çµ¦ Context ä½¿ç”¨ã€‚</p>\n<p>ä»¥å…ˆå‰åŒæ¨£çš„ç¯„ä¾‹ä¾†çœ‹çœ‹ä½¿ç”¨å¾Œçš„æ•ˆæœï¼š</p>\n<p><img src=\"/image/context-perf-issue-sample-flamegraph-useContextSelector.gif\" alt=\"Demo with context selector\"></p>\n<a href=\"https://codesandbox.io/s/context-api-perf-issue-usecontextselector-nk0ho?fontsize=14&amp;hidenavigation=1&amp;theme=dark\">\n  <img alt=\"Edit context-api-perf-issue (useContextSelector)\" src=\"https://codesandbox.io/static/img/play-codesandbox.svg\">\n</a>\n<p>å¾åœ–ä¸­çš„ flamegraph å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸€æ¨£çš„æ“ä½œä¸‹ï¼ŒTextBox åœ¨æ‰€æœ‰çš„ commits ä¸­éƒ½æ²’æœ‰è¢«è§¸ç™¼ renderï¼Œåªæœ‰ Counter æœ‰åŸ·è¡Œ renderã€‚</p>\n<p>è‹¥æ˜¯å†ä»”ç´°çœ‹ä¸€é»ï¼Œä½ ä¹Ÿæœƒç™¼ç¾ï¼Œè·ŸåŸæœ¬çš„ç‰ˆæœ¬æ¯”èµ·ä¾†ï¼ŒCommits æ•¸é‡å¤šäº†ä¸€å€ï¼Œä¸¦å¤šäº†ä¸€å€‹ Anonymous (memo) çš„ componentã€‚</p>\n<p>è€Œé€™å¤šå‡ºä¾†çš„éƒ¨åˆ†å°±æ˜¯ <a href=\"https://github.com/dai-shi/use-context-selector\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">use-context-selector</a> èƒ½ <strong>bail out of rendering</strong> çš„åŸå› ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°±å¾ç¨‹å¼ç¢¼ä¾†ç†è§£å¯¦ä½œåŸç†ï¼</p>\n<p>ï¼ˆé¡Œå¤–è©±ï¼Œ<code class=\"language-text\">bail out of rendering</code> æ˜¯æˆ‘åœ¨æŸ¥è©¢ç›¸é—œè³‡è¨Šæ™‚ï¼Œå¸¸å¸¸çœ‹åˆ°çš„å¥å­ï¼Œè¦ºå¾—æ˜¯å¾ˆè²¼åˆ‡çš„æè¿°ï¼Œæ‰€ä»¥ä¿ç•™åŸæ–‡ï¼ŒåŠ ä¸Šæˆ‘ä¹Ÿæ‰¾ä¸åˆ°åˆé©çš„ä¸­æ–‡ç¿»è­¯...ï¼‰</p>\n<h2 id=\"ç¨‹å¼ç¢¼è§£æ\" style=\"position:relative;\"><a href=\"#%E7%A8%8B%E5%BC%8F%E7%A2%BC%E8%A7%A3%E6%9E%90\" aria-label=\"ç¨‹å¼ç¢¼è§£æ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ç¨‹å¼ç¢¼è§£æ</h2>\n<p><code class=\"language-text\">use-context-selector</code> çš„<a href=\"(https://github.com/dai-shi/use-context-selector/blob/master/src/index.js)\">ç¨‹å¼ç¢¼</a>å¾ˆçŸ­ï¼Œå°± 100 å¤šè¡Œè€Œå·²ï¼Œæ‰€ä»¥è¦ç›´æ¥çœ‹ä¹Ÿæ˜¯ okï¼Œä½†æˆ‘ä¸€èˆ¬éƒ½ç¿’æ…£å…ˆå¾ lib çš„ä½¿ç”¨æ–¹å¼ä¸‹æ‰‹ï¼Œè§€å¯Ÿå‡ºæˆ‘å€‘æ‡‰è©²å…ˆé–±è®€å“ªéƒ¨åˆ†çš„ç¨‹å¼ç¢¼ã€‚</p>\n<p>æˆ‘å€‘åªå–ä¸Šé¢ç¯„ä¾‹ä¸­çš„ Counter ä¾†è§€å¯Ÿï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  createContext<span class=\"token punctuation\">,</span>\n  useContextSelector<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./use-context-selector'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Counter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> <span class=\"token function\">useContextSelector</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> dispatch <span class=\"token operator\">=</span> <span class=\"token function\">useContextSelector</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> v<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>span<span class=\"token operator\">></span>Count<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>button type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'increment'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>button type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'decrement'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Provider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>context<span class=\"token punctuation\">.</span>Provider value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>context<span class=\"token punctuation\">.</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>StrictMode<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Provider<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Counter<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Counter <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Counter <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>StrictMode<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>è·Ÿæˆ‘å€‘ä¸€èˆ¬ä½¿ç”¨ Context API çš„æ–¹å¼ç›¸åŒï¼Œéœ€è¦ç”¨ <code class=\"language-text\">createContext</code> ä¾†å‰µå»º contextï¼Œåªä¸éé€™é‚Šç”¨åˆ°çš„ä¸¦ä¸æ˜¯ React åŸç”Ÿçš„ createContextï¼Œè€Œæ˜¯ <code class=\"language-text\">use-context-selector</code> æä¾›çš„ã€‚</p>\n<p>å¦å¤–å°±æ˜¯èˆ‡ä¸€èˆ¬ <code class=\"language-text\">useContext</code> ä¸åŒï¼Œåœ¨ Component ä¸­ä½¿ç”¨ <code class=\"language-text\">useContextSelector</code> ä¾†å–å¾— context ä¸­çš„ state èˆ‡ dispatch å‡½å¼ï¼ˆReact.useReducer() ç”¢ç”Ÿçš„ï¼‰ã€‚</p>\n<p><code class=\"language-text\">useContextSelector</code> å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¤šå‚³ä¸€å€‹ selector åƒæ•¸é€²å»é¸å–æˆ‘å€‘éœ€è¦çš„ context valueï¼Œä½†ç‚ºä»€éº¼é€™é‚Šä»–è¦æˆ‘å€‘ä½¿ç”¨å®ƒæä¾›çš„ <code class=\"language-text\">createContext</code> å‘¢ï¼Ÿ</p>\n<p>çœ‹ä¾†é—œéµå°±åœ¨é€™é‚Šï¼Œæ‰€ä»¥æˆ‘å€‘ç›´æ¥å…ˆå¾ <a href=\"https://github.com/dai-shi/use-context-selector/blob/master/src/index.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">use-context-selector</a> ä¸­çš„ <code class=\"language-text\">createContext</code> å‡½å¼çœ‹èµ·ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createContext</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">defaultValue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// make changedBits always zero</span>\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span>defaultValue<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// shared listeners (not ideal)</span>\n  context<span class=\"token punctuation\">[</span><span class=\"token constant\">CONTEXT_LISTENERS</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// hacked provider</span>\n  context<span class=\"token punctuation\">.</span>Provider <span class=\"token operator\">=</span> <span class=\"token function\">createProvider</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Provider<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">[</span><span class=\"token constant\">CONTEXT_LISTENERS</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// no support for consumer</span>\n  <span class=\"token keyword\">delete</span> context<span class=\"token punctuation\">.</span>Consumer<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å¯ä»¥çœ‹å‡ºä»–å…¶å¯¦ä¹Ÿæ˜¯ä½¿ç”¨ <code class=\"language-text\">React.createContext</code> ä¾†å‰µå»º Contextï¼Œåªæ˜¯ä»–å¤šå‚³äº†ä¸€å€‹åƒæ•¸é€²å»ã€‚</p>\n<p>ğŸ¤” ä»€éº¼æ™‚å€™ <code class=\"language-text\">React.createContext</code> æœ‰ç¬¬äºŒå€‹åƒæ•¸é¸é …äº†ï¼Ÿ</p>\n<p>å¾ä¸Šé¢çš„è¨»è§£ä¾†çœ‹ï¼Œå‚³å…¥çš„ç¬¬äºŒå€‹åƒæ•¸æœƒå›å‚³ä¸€å€‹å«åš <code class=\"language-text\">changedBits</code> çš„å€¼ï¼ŒGoogle ä¸€ä¸‹å¾Œç™¼ç¾åŸä¾†æ˜¯æ²’æœ‰å¯«åœ¨æ–‡ä»¶ä¸Šçš„ APIï¼Œè€Œä¸”å…©å¹´å‰æ–°çš„ Context API å‡ºä¾†æ™‚å°±å·²ç¶“æœ‰ä¸å°‘äººåœ¨è¨è«–äº†ï¼ˆåŸä¾†åªæ˜¯è‡ªå·±å­¸è­˜æ·ºè–„ğŸ˜…ï¼‰</p>\n<p>åœ¨å…ˆå‰æåˆ°çš„ <a href=\"https://github.com/reactjs/rfcs/pull/119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC: Context selectors</a> ä¸­ä¹Ÿæ˜¯æƒ³è¦åˆ©ç”¨é€™å€‹ APIã€‚</p>\n<p>é€™ç¬¬äºŒå€‹åƒæ•¸å«åš <code class=\"language-text\">calculateChangedBits</code>ï¼Œä»–æœƒæ¥å— Context çš„æ–°å€¼èˆ‡èˆŠå€¼ä½œç‚º inputï¼Œæœ€å¾Œ return <code class=\"language-text\">changedBits</code>ï¼Œå¦‚æœ <code class=\"language-text\">changedBits</code> ç‚º 0ï¼ŒContext Provider å°±ä¸æœƒè§¸ç™¼æ›´æ–°ï¼›è€ŒContext Consumer ä¸­ä¹Ÿèƒ½å‚³å…¥ä¸€å€‹å«åš <code class=\"language-text\">unstable_observedBits</code> çš„ propsï¼Œè‹¥æ˜¯ <code class=\"language-text\">unstable_observedBits &amp; changedBits !== 0</code>ï¼ŒConsumer ä¹Ÿä¸æœƒæ›´æ–°ã€‚</p>\n<p>é›–ç„¶ <code class=\"language-text\">observedBits</code> æ˜¯ unstable çš„ï¼Œä½†åœ¨ <a href=\"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/__tests__/ReactNewContext-test.js#L65\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">react-reconciler çš„ NewContext test</a> ä¸­ï¼Œä»–å€‘å°±æ˜¯åˆ©ç”¨ <code class=\"language-text\">changedBits</code> èˆ‡ <code class=\"language-text\">observedBits</code> ä¾†åšæ›´æ–°çš„æ¸¬è©¦ã€‚</p>\n<p>é€™é‚Šå†ç¾…åˆ—å¹¾ç¯‡è¬›è§£å¾—æ¯”è¼ƒè©³ç´°çš„æ–‡ç« ä¾›å¤§å®¶åƒè€ƒï¼š</p>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/42654080\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ä¸ä¸€æ¨£çš„ React context</a></li>\n<li><a href=\"https://medium.com/@koba04/a-secret-parts-of-react-new-context-api-e9506a4578aa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">A Secret parts of React New Context API</a></li>\n<li><a href=\"https://medium.com/@leonardobrunolima/react-tips-context-api-performance-considerations-d964f3ad3087\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">React tips â€” Context API (performance considerations)</a></li>\n</ul>\n<p>ç¸½è€Œè¨€ä¹‹ï¼Œæˆ‘å€‘æ˜¯å¯ä»¥å®¢è£½åŒ–ä¸€å€‹å‡½å¼ä¾†æ±ºå®š Context çš„å€¼æ›´å‹•æ™‚ï¼Œéœ€ä¸éœ€è¦è§¸ç™¼æ›´æ–°ã€‚</p>\n<p>ä½†é€™å€‹å‡½å¼æ˜¯åœ¨ <code class=\"language-text\">createContext</code> æ™‚å°±å¾—å‚³å…¥çš„ï¼Œè€Œä¸æ˜¯ <code class=\"language-text\">useContext</code>ï¼Œæˆ‘å€‘çš„ Component æ²’è¾¦æ³•å‹•æ…‹å»å‚³å„è‡ªçš„ Selectorã€‚</p>\n<p>ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œ<code class=\"language-text\">use-context-selector</code> å°±ç›´æ¥ä»¥ <code class=\"language-text\">() => 0</code> ä½œç‚º <code class=\"language-text\">calculateChangedBits</code> å‡½å¼ï¼Œè®“ React Context Provider æ‹¿åˆ°çš„ <code class=\"language-text\">changedBits</code> æ°¸é ç‚º 0ã€‚</p>\n<p>é€™æ¨£åšæœƒè®“ Provider æ°¸é ä¸æœƒè·Ÿéš¨è‘— Context è®Šå‹•è€Œè§¸ç™¼ renderï¼Œè€Œæ˜¯ç”±æˆ‘å€‘è‡ªå·±ä¾†åˆ¤æ–·ä½•æ™‚è¦åšæ›´æ–°ï¼Œç‚ºæ­¤ï¼Œ<code class=\"language-text\">use-context-selector</code> å¯¦ä½œäº†å¦ä¸€å€‹ <code class=\"language-text\">context.Provider</code>ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">OrigProvider<span class=\"token punctuation\">,</span> listeners</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span><span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> value<span class=\"token punctuation\">,</span> children <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// we use layout effect to eliminate warnings.</span>\n    <span class=\"token comment\">// but, this leads tearing with startTransition.</span>\n    <span class=\"token comment\">// eslint-disable-next-line react-hooks/rules-of-hooks</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">useLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      listeners<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">listener</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">listener</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// we call listeners in render for optimization.</span>\n    <span class=\"token comment\">// although this is not a recommended pattern,</span>\n    <span class=\"token comment\">// so far this is only the way to make it as expected.</span>\n    <span class=\"token comment\">// we are looking for better solutions.</span>\n    <span class=\"token comment\">// https://github.com/dai-shi/use-context-selector/pull/12</span>\n    listeners<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">listener</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">listener</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>OrigProvider<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">createProvider</code> é™¤äº†åŒ…è£¹ React åŸç”Ÿçš„ Context Provide å¤–ï¼Œé¡å¤–æ¥æ”¶ä¸€å€‹ <code class=\"language-text\">listeners</code> åƒæ•¸ï¼Œè€Œé€™å°±æ˜¯ Custom Provider çš„ä¸»è¦ç›®çš„ã€‚</p>\n<p>å‰›å‰›æåˆ°ç”±æ–¼ <code class=\"language-text\">changedBits</code> éƒ½æœƒæ˜¯é›¶ï¼Œæ‰€ä»¥éœ€è¦æˆ‘å€‘ä¸»å‹•è§¸ç™¼æ›´æ–°ï¼Œè€Œè§¸ç™¼çš„æ–¹å¼å°±æ˜¯ç›´æ¥å°‡ listener è¨»å†Šåˆ° Customer Provder ä¸­ï¼Œè€Œ listener å°±æ˜¯æ¯å€‹ Component ç”¨ä¾†<strong>é‡å°ç›®å‰æœ€æ–°çš„ context value åš select ä»¥æ±ºå®šè¦ä¸è¦æ›´æ–°çš„å‡½å¼</strong>ï¼Œè©³ç´°å¯¦ä½œç­‰ç­‰å°±æœƒèªªæ˜ã€‚</p>\n<p>ç¾åœ¨é‡æ–°æ‹¿ç¯„ä¾‹ç¨‹å¼ç¢¼ä¾†æª¢è¦–ä¸€ä¸‹ç›®å‰ç‚ºæ­¢çš„é‚è¼¯ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Provider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>context<span class=\"token punctuation\">.</span>Provider value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>context<span class=\"token punctuation\">.</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>StrictMode<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Provider<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Counter<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Counter <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Counter <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>StrictMode<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å°‡ <code class=\"language-text\">useReducer</code> å›å‚³çš„ <code class=\"language-text\">state</code> èˆ‡ <code class=\"language-text\">dispatch</code> ç•¶ä½œ Context Value å‚³å…¥ Providerï¼Œç•¶ <code class=\"language-text\">Counter</code> è£¡é¢é€é <code class=\"language-text\">dispatch</code> å»æ›´æ–° Context å…§çš„ <code class=\"language-text\">state</code> æ™‚ï¼Œç”±æ–¼æ­¤æ™‚çš„ Provider æ˜¯å®¢è£½åŒ–å¾Œçš„ Providerï¼Œä»–æœƒé€²è¡Œ renderï¼Œä¸¦åœ¨ render çš„éç¨‹ä¸­ï¼Œå‘¼å«æ‰€æœ‰èˆ‡ä»–ç›´æ¥ subscribe çš„ listenerï¼Œç”± listener ä¾†åˆ¤æ–·èˆ‡åŸ·è¡Œ component çš„ re-render èˆ‡å¦ã€‚</p>\n<p>é€™å±¤å®¢è£½åŒ–çš„ Provider ä¹Ÿå°±æ˜¯æˆ‘å€‘å…ˆå‰åœ¨ flamegraph ä¸­çœ‹åˆ°å¤šå‡ºä¾†çš„ä¸€å±¤ Anonymous (memo) componentï¼Œä¹Ÿè§£é‡‹äº†ç‚ºä»€éº¼ commits æ•¸é‡æœƒå¤šäº†ä¸€å€ï¼Œå°±æ˜¯å› ç‚ºé€™å€‹ Anonymous component æ‰€é€²è¡Œçš„ renderã€‚</p>\n<p>æœ€å¾Œæˆ‘å€‘ä¾†çœ‹çœ‹ listener æ˜¯æ€éº¼ç”¢ç”Ÿèˆ‡é‹ä½œçš„ï¼Œæˆ‘å€‘æ‹†ä¸‰å€‹éƒ¨åˆ†ä¾†èªªæ˜ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useContextSelector</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> selector</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> listeners <span class=\"token operator\">=</span> context<span class=\"token punctuation\">[</span><span class=\"token constant\">CONTEXT_LISTENERS</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>listeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'useContextSelector requires special context'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>åœ¨ä¸€é–‹å§‹ <code class=\"language-text\">createContext</code> æ™‚ï¼Œå…¶å¯¦æœ‰åœ¨ context ä¸­å¡ä¸€å€‹ <code class=\"language-text\">Set()</code>ï¼š</p>\n<p><code class=\"language-text\">context[CONTEXT_LISTENERS] = new Set();</code></p>\n<p>è€Œåœ¨ <code class=\"language-text\">useContextSelector</code> ä¸­çš„ä¸€é–‹å§‹ï¼Œæˆ‘å€‘å°±æœƒå–å‡ºé€™å€‹ setï¼Œç›®çš„åœ¨æ–¼<strong>è¦æ”¾å…¥å‘¼å« <code class=\"language-text\">useContextSelector</code> çš„ component çš„ listenerã€‚</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> forceUpdate<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useContext</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> selected <span class=\"token operator\">=</span> <span class=\"token function\">selector</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nReact<span class=\"token punctuation\">.</span><span class=\"token function\">useLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  ref<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    f<span class=\"token operator\">:</span> selector<span class=\"token punctuation\">,</span> <span class=\"token comment\">// last selector \"f\"unction</span>\n    v<span class=\"token operator\">:</span> value<span class=\"token punctuation\">,</span> <span class=\"token comment\">// last \"v\"alue</span>\n    s<span class=\"token operator\">:</span> selected<span class=\"token punctuation\">,</span> <span class=\"token comment\">// last \"s\"elected value</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p>æ¥è‘—æº–å‚™ä¸€äº› listener éœ€è¦çš„æ±è¥¿ï¼š</p>\n<ol>\n<li>ç•¶åŸ·è¡Œå®Œ Selectorï¼Œç¢ºèª Component éœ€è¦æ›´æ–°å¾Œï¼Œæˆ‘å€‘å¾—æœ‰å€‹ <code class=\"language-text\">forceUpdate</code> å‡½å¼ä¾†è§¸ç™¼ renderï¼Œé€™é‚Šçš„å¯¦ä½œæ–¹å¼æ˜¯é¡å¤–ä½¿ç”¨ <code class=\"language-text\">React.useReducer</code> ç”¢ç”Ÿä¸€å€‹ä¸æ–· +1 çš„ reducerï¼Œä¾†é”åˆ°æ•ˆæœã€‚</li>\n<li>æˆ‘å€‘é‚„æ˜¯éœ€è¦ä¸€å€‹çœŸæ­£çš„ <code class=\"language-text\">React.context</code> ä¾†ç´€éŒ„ Globle stateã€‚</li>\n<li>é€é <code class=\"language-text\">React.useRef</code> ç´€éŒ„ç•¶ä¸‹çš„ selector functionã€context value èˆ‡ selector é¸å‡ºçš„å€¼ã€‚</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ...</span>\nReact<span class=\"token punctuation\">.</span><span class=\"token function\">useLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nextValue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>v <span class=\"token operator\">===</span> nextValue\n        <span class=\"token operator\">||</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">is</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>nextValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ignored (stale props or some other reason)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">forceUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  listeners<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    listeners<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>listeners<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> selected<span class=\"token punctuation\">;</span></code></pre></div>\n<p>å†ä¾†å¯¦ä½œ listenerï¼Œlistener function æ¥å—çš„ <code class=\"language-text\">nextValue</code> å°±æ˜¯ Custom Provider å–å¾—çš„æœ€æ–°çš„ Context valueï¼Œlistener function å°±èƒ½å¤ åˆ©ç”¨é€™å€‹ <code class=\"language-text\">nextValue</code> èˆ‡æˆ‘å€‘å…ˆå‰å­˜æ”¾åœ¨ <code class=\"language-text\">ref</code> ä¸­çš„å€¼åšæ¯”è¼ƒï¼Œè‹¥æ˜¯ Context Value å®Œå…¨ç›¸ç­‰ï¼Œæˆ–æ˜¯ Selected çš„å€¼ä¹Ÿæ²’æœ‰è®Šå‹•ï¼ˆç”¨ <code class=\"language-text\">ref</code> ä¸­å­˜å¥½çš„ selector function å° <code class=\"language-text\">nextValue</code> åšé¸å–ï¼‰ï¼Œé‚£å°±ä¸ç”¨ renderã€‚</p>\n<p>åä¹‹ï¼Œè‹¥ç™¼ç¾å€¼ä¸åŒï¼Œéœ€è¦æ›´æ–°ï¼Œå°±æœƒå‘¼å« <code class=\"language-text\">forceUpdate()</code> å¼·åˆ¶è®“é€™å€‹ <code class=\"language-text\">useContextSelector</code> é€²è¡Œ renderï¼Œä¹Ÿå°±æœƒè·Ÿè‘—è§¸ç™¼ä½¿ç”¨ <code class=\"language-text\">useContextSelector</code> çš„ Component é€²è¡Œ renderï¼Œæ›´æ–° <code class=\"language-text\">ref</code> å…§çš„å€¼ï¼Œä¸¦å›å‚³æœ€æ–°çš„ <code class=\"language-text\">selected value</code>ã€‚</p>\n<p>è€Œé€™é‚Šå»ºç«‹çš„ listener æœƒæ”¾å…¥ä¸€é–‹å§‹å¾ Context å–å‡ºçš„ <code class=\"language-text\">Set()</code> ä¸­ï¼ŒCustom Provider åœ¨ render æ™‚ï¼Œå°±èƒ½å–å‡ºé‹è¡Œã€‚</p>\n<h3 id=\"ç¸½çµä¸€éæµç¨‹\" style=\"position:relative;\"><a href=\"#%E7%B8%BD%E7%B5%90%E4%B8%80%E9%81%8D%E6%B5%81%E7%A8%8B\" aria-label=\"ç¸½çµä¸€éæµç¨‹ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ç¸½çµä¸€éæµç¨‹</h3>\n<p><code class=\"language-text\">use-context-selector</code> æ›¿ Context API çš„æ•ˆèƒ½å•é¡Œæ‰€æ‰¾åˆ°çš„ escape hatch æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>åˆ©ç”¨ <strong>Custom Provider</strong> èˆ‡ <strong>Custome createContext</strong> è¿«ä½¿ changedBits ç¸½æ˜¯å›å‚³ 0ï¼Œåœæ­¢æ‰€æœ‰ Context ä½¿ç”¨è€…çš„è‡ªå‹•æ›´æ–°ã€‚</li>\n<li>å»ºç«‹ä¸€å€‹ global listeners çš„ Set åœ¨ Context ä¸­ï¼Œè®“ Components ç›´æ¥ subscribe åˆ° <Provider> (<em>Custom Provider</em>)</li>\n<li>æœ‰ä½¿ç”¨ <code class=\"language-text\">useContextSelector</code> çš„ components æœƒå»ºç«‹ listenerï¼Œæ”¾å…¥ Context Set ä¸­é€²è¡Œ subscribeã€‚</li>\n<li>ç•¶ <Provider> re-renders æ™‚ï¼Œ è§¸ç™¼æ‰€æœ‰ subscribersã€‚</li>\n<li>listener åŸ·è¡Œï¼Œæª¢æŸ¥ Selectorï¼Œæª¢æŸ¥ Context Valueï¼Œåªé‡å°æœ‰éœ€è¦æ›´æ–°çš„ Component åš forceUpdateã€‚</li>\n</ol>\n<p>é€™å°±æ˜¯ <code class=\"language-text\">use-context-selector</code> æ‰€æ‰¾åˆ°çš„å‡ºè·¯ï¼Œè®“ä½ åœ¨ global context update æ™‚ï¼Œ<code class=\"language-text\">bail out of rendering</code>ã€‚</p>\n<h2 id=\"çµè«–\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"çµè«– permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>çµè«–</h2>\n<p><code class=\"language-text\">use-context-selector</code> çš„ä½œè€…è‡ªå·±ä¹Ÿèªªäº†é€™å€‹å¥—ä»¶æœ‰å¾ˆå¤š<a href=\"https://github.com/dai-shi/use-context-selector#limitations\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">é™åˆ¶</a>èˆ‡<a href=\"https://github.com/dai-shi/reactive-react-redux/issues/29#issuecomment-512785639\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ä¸è¶³</a></p>\n<p>å³ä¾¿ä»–æœ‰ <a href=\"https://github.com/dai-shi/use-context-selector/pull/12\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">v2</a> ç‰ˆæœ¬çš„å¯¦ä½œï¼Œæ˜¯å»ºç«‹åœ¨æ¯”è¼ƒæœ‰æ©Ÿæœƒå¯¦ä½œçš„ RFC ä¸Šï¼Œä½†æ•´é«”ä¾†èªªé‚„æ˜¯ä¸èƒ½ç®—ä¸€å€‹ç©©å®šçš„è§£æ±ºæ–¹æ¡ˆã€‚</p>\n<p>ä½†æ˜¯ä½œç‚ºä½¿ç”¨åœ¨å…§éƒ¨æˆ–æ˜¯å€‹äººå°ˆæ¡ˆä¸Šä¾†èªªï¼Œæ˜¯å€‹é‚„ä¸éŒ¯çš„é¸æ“‡ã€‚å°¤å…¶æ˜¯ç°¡å–®æ˜“æ‡‚çš„å¯¦ä½œï¼Œå°±ç®—æ˜¯å‡ºäº†ä»€éº¼å•é¡Œï¼Œåªè¦ç†è§£ä»–çš„åŸç†ï¼Œä¹Ÿæ˜¯èƒ½æ‰¾å¾—å‡ºå•é¡Œæ‰€åœ¨ã€‚</p>\n<p>é€™æ¬¡ä¹Ÿæ˜¯é€éé–±è®€å…¶ç¨‹å¼ç¢¼ï¼Œæ‰å° Context API æœ‰æ›´å¤šäº†è§£ï¼Œå¾ä¸­å»¶ä¼¸é–±è®€äº†å¾ˆå¤šåŒ…å« react-redux v6 ç•¶åˆçš„æ•ˆèƒ½ issueã€RFCs ä¸Šçš„è¨è«–ã€é—œæ–¼ <code class=\"language-text\">calculateChangedBits</code> çš„çŸ¥è­˜ï¼Œæˆ–ç”šè‡³æ˜¯ react scheduling çš„ä¸€äº›å…§éƒ¨å¯¦ä½œã€‚</p>\n<p>é€™ä¹Ÿå›æ‡‰åˆ°æˆ‘æœ€é–‹å§‹æ‰€èªªçš„ï¼Œæœ‰æ™‚å€™å¤ªéæ–¼éµå¾ª best practiceï¼Œæœƒè®“ä½ å¤±å»ç ”ç©¶ä¸€äº›æœ‰è¶£å•é¡Œæˆ–æ˜¯å­¸ç¿’çš„æ©Ÿæœƒï¼Œç”šè‡³é€éèµ°é€™äº›æ—é–€èµ°é“ï¼Œæœƒè®“ä½ å°æ–¼ best practice ä¹‹æ‰€ä»¥ç‚º best practice çš„åŸå› æ›´åŠ æ·±åˆ»ã€‚</p>\n<p>åˆ†æç¨‹å¼ç¢¼çš„æ–‡ç« æœ‰é»å†—é•·é¬†æ•£ï¼Œå¦‚æœä½ æœ‰çœ‹åˆ°é€™é‚Šï¼Œæ„Ÿè¬ä½ çš„é–±è®€ï¼Œè‹¥æœ‰ä»»ä½•å•é¡Œä¹Ÿæ­¡è¿æŒ‡æ•™è¨è«–ï¼</p>\n<h2 id=\"è³‡æ–™ä¾†æº\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"è³‡æ–™ä¾†æº permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è³‡æ–™ä¾†æº</h2>\n<ol>\n<li><a href=\"https://github.com/dai-shi/use-context-selector\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">use-context-selector</a></li>\n<li><a href=\"https://reactjs.org/docs/context.html#when-to-use-context\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">When to use Context</a></li>\n<li><a href=\"https://github.com/reduxjs/react-redux/issues/1177#issue-406051556\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">React-Redux Roadmap: v6, Context, Subscriptions, and Hooks</a></li>\n<li><a href=\"https://github.com/reactjs/rfcs/pull/119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC: Context selectors</a></li>\n<li><a href=\"https://github.com/dai-shi/reactive-react-redux/issues/29\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Why calculateChangedBits = () => 0</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/42654080\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ä¸ä¸€æ¨£çš„ React context</a></li>\n<li><a href=\"https://medium.com/@koba04/a-secret-parts-of-react-new-context-api-e9506a4578aa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">A Secret parts of React New Context API</a></li>\n<li><a href=\"https://medium.com/@leonardobrunolima/react-tips-context-api-performance-considerations-d964f3ad3087\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">React tips â€” Context API (performance considerations)</a></li>\n</ol>","fields":{"slug":"use-context-selector-src-analysis"},"frontmatter":{"title":"Context API æ•ˆèƒ½å•é¡Œ - use-context-selector è§£æ","date":"09-12-2020","tags":["react","context api","selector","state management"]},"timeToRead":13}},"pageContext":{"slug":"use-context-selector-src-analysis","prev":{"excerpt":"ã€Gotta remember we live what we choose; It's not what you say, it's what you do; And the life you want is the life you have to make.ã€- Life is so cool (ä¸€é¦–æˆ‘å¿ƒæ„›çš„äººæ¨è–¦çš„æ­Œ :) )","html":"<blockquote>\n<p>ã€Gotta remember we live what we choose; It's not what you say, it's what you do; And the life you want is the life you have to make.ã€- Life is so cool (ä¸€é¦–æˆ‘å¿ƒæ„›çš„äººæ¨è–¦çš„æ­Œ :) )</p>\n</blockquote>\n<!-- more -->\n<h2 id=\"å‰è¨€\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"å‰è¨€ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å‰è¨€</h2>\n<p>ç¨å¾®å–æ¨£äº†èƒ¡ç«‹å…ˆå‰<a href=\"https://blog.techbridge.cc/2020/07/11/an-interesting-styled-component-bug/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">æ–‡ç« </a>çš„æ¨™é¡Œï¼Œä½†å¯¦éš›ä¸Šé€™ç¯‡æ–‡ç« æƒ³åˆ†äº«çš„é¢å‘ä¸å¤ªã„§æ¨£ï¼Œä¸¦ä¸æ˜¯ styled-components æœ¬èº«çš„ issue æˆ–æ˜¯å…¶æ‰€å¼•ç”¨çš„åº•å±¤å¥—ä»¶çš„ bugï¼Œæ¯”è¼ƒåƒæ˜¯ç‰¹å®šçš„ä½¿ç”¨æƒ…å¢ƒï¼Œä»¥åŠå° styled-components å¯¦éš›é‹ä½œåŸç†ä¸ç†Ÿæ‚‰ç­‰å› ç´ ï¼Œæ‰€å°è‡´çš„ bugã€‚é€™å€‹ bug ä¸æ˜¯å¾ˆå®¹æ˜“è¢«ç™¼ç¾ï¼Œè§£æ±ºçš„æ–¹æ³•ä¹Ÿç®—æ˜¯æœ‰é» hackï¼ˆé‹ç”¨åˆ°èˆ‡å®˜æ–¹æ–‡æª”æè¿°ä¸ç¬¦åˆçš„ APIï¼‰ï¼Œæˆ‘è¦ºå¾—è »æœ‰è¶£çš„ï¼ŒåŠ ä¸Šä¸»è¦çš„è§£æ³•å¯¦ä½œæ˜¯ç”±æˆ‘<a href=\"https://github.com/whatasod\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">åŒäº‹</a>è™•ç†ï¼Œæ‰€ä»¥æƒ³å¯«ä¸‹ä¾†çµ¦è‡ªå·±åšä¸€å€‹ç´€éŒ„ï¼Œçµ¦è‡ªå·±ç•™é»å°è±¡ï¼Œå°å¤§å®¶å¯èƒ½æ²’æœ‰ç›´æ¥å¹«åŠ©ï¼Œå¯ä»¥ç•¶æ•…äº‹çœ‹çœ‹åšå€‹åƒè€ƒã€‚</p>\n<p>TL;DR</p>\n<p>ä¸‹é¢çš„ç¯‡å¹…å¤§éƒ¨åˆ†åœ¨è¬›è§£ç™¼ç¾å•é¡Œçš„æµç¨‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ°<a href=\"#%E9%87%8D%E6%96%B0%E6%A2%B3%E7%90%86%E4%B8%80%E4%B8%8B%E5%95%8F%E9%A1%8C%E8%88%87%E8%A7%A3%E6%B3%95\">æœ€å¾Œ</a>çœ‹é‡é»ã€‚</p>\n<h2 id=\"ä¸€åˆ‡çš„é–‹ç«¯\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E5%88%87%E7%9A%84%E9%96%8B%E7%AB%AF\" aria-label=\"ä¸€åˆ‡çš„é–‹ç«¯ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ä¸€åˆ‡çš„é–‹ç«¯</h2>\n<p>åœ˜éšŠå…§æœ‰å€‹å°ˆæ¡ˆæ˜¯å°ˆé–€æä¾›çµ¦è¡ŒéŠ·äººå“¡è£½ä½œè¡ŒéŠ·é é¢çš„å…§éƒ¨å·¥å…·ï¼Œtech stack ä¸­æœ‰ä½¿ç”¨ React èˆ‡ styled-componentsã€‚åŸæœ¬æœ€æ—©çš„å¯¦ä½œæ–¹å¼æ˜¯ç°¡å–®çš„ Single Page Applicationï¼Œé€é API æ‹‰å–å…§å®¹é€²è¡Œ renderï¼Œè€Œç”±æ–¼é é¢å¤§å¤šæ˜¯åœ¨ App å…§çš„ WebView é–‹å•Ÿï¼Œç‚ºäº†æé«˜ä½¿ç”¨è€…ç¶“é©—ï¼Œæˆ‘å€‘æ±ºå®šå°‡é é¢å…ˆè¡Œåœ¨ server ç«¯é€²è¡Œ prerenderï¼Œå°‡ HTML æ”¾ç½® CDNï¼Œclient ç«¯è¼‰å…¥æ‰€éœ€è³‡æºå¾Œï¼ŒJS å†é€é <code class=\"language-text\">ReactDOM.hydrate</code> é€²è¡Œ hydrationï¼Œè®“æœ‰äº’å‹•åŠŸèƒ½çš„ react component å¯ä»¥é‹ä½œã€‚</p>\n<p>prerender çš„åšæ³•ï¼Œéå¸¸ç›´æ¥ï¼Œæˆ‘å€‘ä½¿ç”¨ puppeteer é–‹å•Ÿ Headless server ç›´æ¥ render åŸæœ¬çš„ SPA é é¢ï¼ŒæŠŠ <code class=\"language-text\">page.content()</code> çµ¦å­˜èµ·ä¾†ã€‚</p>\n<p>æœƒæ¡ç”¨é€™ç¨®åšæ³•çš„ä¸€å€‹åŸå› æ˜¯å› ç‚ºåŸæœ¬ç”¨åœ¨ SPA ä¸Šçš„ component å…¶å¯¦ä¹ŸåŒæ™‚å…±ç”¨åœ¨å…§éƒ¨å·¥å…·ä¸­ï¼Œè€Œæ•´å€‹ SPA é é¢ä¹Ÿé‚„ä¿ç•™è‘—ä½œç‚ºé è¦½ï¼Œè®“ä½¿ç”¨è€…åœ¨ç·¨è¼¯è£½ä½œè¡ŒéŠ·é é¢çš„æ™‚å€™èƒ½å¤ å³æ™‚çœ‹åˆ°é é¢å¤–è§€ï¼Œå› æ­¤èˆ‡å…¶ä¿®æ”¹æˆ <code class=\"language-text\">ReactDOM.renderToString()</code>ï¼Œç›´æ¥å°‡ SPA æ¸²æŸ“å®Œçš„çµæœå­˜ä¸‹ä¾†ï¼Œç›´è¦ºä¸Šç°¡å–®å¾ˆå¤šï¼Œç¨‹å¼ç¢¼çš„æ›´å‹•ä¹Ÿå°‘ã€‚</p>\n<p>prerender å®Œå¾Œï¼Œæ¥è‘—æœƒæŠŠä¸éœ€è¦åœ¨å‰ç«¯ rehydrate çš„ component å¾ JS bundle ä¸­ç§»é™¤ï¼Œinject éœ€è¦çš„ style tagï¼Œæœ€å¾Œé€£åŒ HTML ä¸€èµ·æ”¾åˆ° CDN ä¸Šã€‚</p>\n<p>è¦ inject style tag çš„åŸå› æ˜¯å› ç‚º styled-components å¦‚åŒå¤šæ•¸ CSS-in-JS è§£æ±ºæ–¹æ¡ˆï¼Œæ˜¯ä½¿ç”¨ CSSOM å» insertRuleï¼Œè€Œé€™æ¨£çš„åšæ³•åœ¨ Chrome 85 ä»¥å‰æ˜¯ç„¡æ³•é€é devtool ä¾†èª¿æ•´ styleï¼Œåœ¨é–‹ç™¼éšæ®µé™¤éŒ¯ä¸Šç¨å«Œéº»ç…©ï¼Œæ‰€ä»¥æˆ‘å€‘åˆ©ç”¨ prerender å®Œçš„å„ªåŒ–éšæ®µä¾†æŠŠ styled-components æ”¾åœ¨ CSSOM ä¸­çš„ sheet æŠ“å‡ºä¾†å¡åˆ° style tag ä¸­ï¼ˆè¨»ï¼šç•¶æ™‚ä½¿ç”¨çš„é‚„ä¸æ˜¯ styled-components v5+ å› æ­¤æ²’æœ‰ <code class=\"language-text\">disableCSSOMInjection</code> option å¯ç”¨ã€‚ï¼‰</p>\n<p>ç°¡å–®çš„æ¶æ§‹åœ–ï¼š</p>\n<p><img src=\"/image/mock-structure.png\" alt=\"simple structure\"></p>\n<p>åŸºæœ¬ä¸Šé€™æ¨£ä¸€åˆ‡éƒ½å¾ˆé †åˆ©ï¼Œå¯¦éš›æ¸¬è©¦ä¸Šç·šä¹Ÿéƒ½æ²’ä»€éº¼å¤ªå¤§å•é¡Œã€‚</p>\n<p>ä½†æ˜¯æœ‰å€‹éš±è—çš„ bug æˆ‘å€‘ä¸€ç›´éƒ½æ²’æœ‰ç™¼ç¾ï¼Œå°±æ˜¯ <strong>prerender å®Œçš„é é¢å­˜æœ‰æ¨£å¼è·‘ç‰ˆçš„æ©Ÿæœƒã€‚</strong></p>\n<p>è€Œä¸”é€™å€‹æƒ…æ³ä¸¦ä¸æ˜¯å¾ˆå®¹æ˜“ç™¼ç”Ÿï¼Œå¯¦éš›ä¸Šåœ¨æˆ‘å€‘æ„è­˜åˆ°ä¹‹å‰ï¼ŒPM æ—©å·²å›å ±éä¸€å…©æ¬¡ï¼Œä½†åŸºæ–¼æ…£æ€§ï¼Œç™¼ç¾é é¢æœ‰é»å¥‡æ€ªæ™‚ï¼Œè‡ªç„¶åæ‡‰æ˜¯é‡æ–°æ•´ç†ã€é‡æ–°åŸ·è¡Œï¼Œçœ‹çœ‹èƒ½å¦é‡ç¾ issueï¼Œè€Œé€™å€‹ bug åœ¨é‡æ–° prerender å¾Œæœ‰è »å¤§çš„æ©Ÿç‡æœƒå†æ¬¡éš±è—èµ·ä¾†ï¼Œä¹Ÿå› æ­¤æ²’æœ‰ç²å¾—è¶³å¤ çš„æ³¨æ„åŠ›è®“æˆ‘å€‘æŒçºŒå°ˆç ”ä¸‹å»ã€‚</p>\n<p>ç›´åˆ°æŸå€‹åŒäº‹åœ¨å¯¦ä½œä¸€å€‹é é¢è¼‰å…¥å¾Œæœƒæœ‰è¼ƒå¤šç‹€æ…‹è®ŠåŒ–çš„ component æ™‚ï¼Œä»–ç™¼ç¾åˆ°ï¼Œåœ¨æ²’æœ‰æ›´å‹•ç¨‹å¼ç¢¼çš„æƒ…æ³ä¸‹ï¼Œåœ¨ client ç«¯æ‰å‹•æ…‹å‡ºç¾çš„ component æ¨£å¼å»è·‘æ‰äº†ï¼Œä½†ç€è¦½å™¨ first load HTML æ™‚å»æ˜¯æ­£å¸¸çš„ã€‚</p>\n<h2 id=\"åˆ°åº•æ˜¯ä»€éº¼å•é¡Œ\" style=\"position:relative;\"><a href=\"#%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C\" aria-label=\"åˆ°åº•æ˜¯ä»€éº¼å•é¡Œ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>åˆ°åº•æ˜¯ä»€éº¼å•é¡Œ</h2>\n<p>ç‚ºäº†é™¤éŒ¯ï¼Œæˆ‘åˆ©ç”¨ Devtool æ’å…¥ä¸­æ–·é»ï¼Œç™¼ç¾åˆ°ç¬¬ä¸€æ¬¡ HTML è¼‰å…¥æ™‚ï¼Œä¸€åˆ‡çš„ Style éƒ½æ˜¯æ­£å¸¸çš„ï¼ŒåŒ…å« styled-components æ‰€ç”¢ç”Ÿçš„ class name ä»¥åŠæˆ‘å€‘ inject åˆ° html å…§çš„ style tagï¼›ç„¶è€Œç•¶ JS bundle è¼‰å…¥ï¼Œå‰ç«¯ react component é‡æ–° render å¾Œï¼ŒHTML DOM ä¸Šçš„ styled-components class name èˆ‡åŸå…ˆçš„ä¸åŒï¼Œclass name æ‰€å°æ‡‰çš„ css style rule ä¹Ÿä¸ä¸€æ¨£ã€‚</p>\n<p>æ¥è‘—å†ç´°çœ‹æœ€çµ‚ç€è¦½å™¨æ¸²æŸ“çš„ HTMLï¼Œç™¼ç¾åˆ° <code class=\"language-text\">&lt;head></code> å…§æœ‰å…©å€‹å±¬æ–¼ styled-components çš„ style tagã€‚</p>\n<p><img src=\"/image/two-style-tag.png\" alt=\"two style tag\"></p>\n<p>åˆ°é€™é‚Šå•é¡Œå°±æ¯”è¼ƒæ¸…æ¥šäº†ã€‚</p>\n<p><strong>æˆ‘å€‘å¡äº†å…©æ¬¡ styled-components ç”¢ç”Ÿçš„ style tagï¼Œæ‰€ä»¥å°è‡´ class name çš„ style æœ‰è¡çªã€‚</strong></p>\n<p>ä¸Šé¢ç´…ç·šæ‹¬å¼§çš„éƒ¨åˆ†æ˜¯æˆ‘å€‘åœ¨ server-side inject é€²å»ï¼Œå«æœ‰ css text çš„ style tagï¼›ä¸‹æ–¹é»ƒç·šæ¨™è¨˜çš„å‰‡æ˜¯ client ç«¯ hydrate å¾Œï¼Œæ‰€ç”¢ç”Ÿçš„æ–°çš„ style tagã€‚</p>\n<p>é€ æˆçš„å¾Œæœå°±æ˜¯å…©å€‹æ¯«ç„¡ç›¸å¹²çš„ component æœ‰æ©Ÿæœƒå…±äº«äº†åŒæ¨£çš„ class nameï¼Œå…¶ä¸­ä¸€å€‹ component çš„ style å°±è·‘æ‰äº†ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--Call to action component--></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sc-AxiKw iOTgPf<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token comment\">&lt;!--FQA component--></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sc-AxhUy iOTgPf<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æˆ‘å€‘çš„ case ä¸­ï¼Œç”±æ–¼æˆ‘å€‘é‚„æœƒæŠŠä¸éœ€è¦åœ¨å‰ç«¯ rehydrate çš„ react component code å¾ JS bundle è£¡æ‹¿æ‰ï¼Œæ‰€ä»¥é‚£äº›æˆ‘å€‘æ‰€è¬‚ <em>éœæ…‹çš„ component</em> æ¨£å¼åŸºæœ¬ä¸Šä¸å¤ªæœƒå—å½±éŸ¿ï¼Œæ‰è®“é€™å€‹ bug æ¯”è¼ƒé›£ç™¼ç¾ã€‚</p>\n<h2 id=\"è§£æ±ºæ–¹æ¡ˆ\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88\" aria-label=\"è§£æ±ºæ–¹æ¡ˆ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è§£æ±ºæ–¹æ¡ˆ</h2>\n<p>æ—¢ç„¶ç™¼ç¾å¤šäº†ä¸€å€‹ style tagï¼Œé‚£æˆ‘å€‘æŠŠå¾Œä¾†è“‹ä¸Šå»çš„é‚£å€‹ tag æ‹¿æ‰ä¸å°±å¾—äº†å—ï¼Ÿ</p>\n<p>ä½†äº‹æƒ…æœç„¶ä¸æ˜¯æ†¨äººæƒ³å¾—é€™éº¼ç°¡å–®ã€‚</p>\n<p>æ‹¿æ‰åœ¨ client-side é‡æ–°ç”¢ç”Ÿçš„ style tag æ˜¯å¯ä»¥ç¢ºä¿æ•´å€‹ application åªåƒåˆ°æˆ‘å€‘åŸå…ˆåœ¨ server ç«¯ inject çš„ CSS æ¨£å¼ï¼Œä½†åœ¨ rehydrate çš„éç¨‹ä¸­ï¼Œcomponent çš„ class name ä¹Ÿè®Šäº†ï¼Œæ‰€ä»¥å–®ç´”æ‹¿æ‰ client side style tag åè€Œè®“æ•´å€‹é é¢çš„æ¨£å¼æ›´åŠ æ…˜çƒˆã€‚</p>\n<p>é‚„æ˜¯å¾—å¾æ ¹æœ¬è§£æ±ºå•é¡Œã€‚</p>\n<p>ä¹‹æ‰€ä»¥æœƒç”¢ç”Ÿå…©å€‹ style tagï¼ŒåŸå› åœ¨æ–¼æˆ‘å€‘åœ¨ client ç«¯é€²è¡Œ hydration æ™‚ï¼Œä¸¦<strong>æ²’æœ‰æ­£ç¢ºè™•ç† styled-components çš„ hydration</strong>ï¼Œåªé¡§æ…®åˆ°äº† react component æœ¬èº«çš„ hydrationï¼Œå°æ–¼ styled-compponent ä¾†èªªï¼Œæˆ‘å€‘åœ¨ server-side inject çš„ style tag <strong>ä¸è¶³ä»¥è®“ä»–é€²è¡Œ rehydrateï¼ˆåŸå› å¾Œé¢æœƒèªªæ˜ï¼‰</strong>ï¼Œæ‰€ä»¥ä»–å¯¦éš›ä¸Šåªèƒ½é‡æ–° render æ‰€æœ‰ component çš„ styleï¼Œé‡æ–°ç”¢ç”Ÿ class name èˆ‡ style tagã€‚</p>\n<p>è€Œåœ¨äº†è§£åˆ°æˆ‘å€‘è‡ªå·± inject çš„ style tag ç„¡æ³•è®“ styled-components é€²è¡Œ rehydrate å¾Œï¼Œæˆ‘è©¦è‘—ç”¨å‰é¢æåˆ°éçš„ <code class=\"language-text\">disableCSSOMInjection</code>ï¼Œæ ¹æ“š<a href=\"https://styled-components.com/docs/api#stylesheetmanager\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å®˜ç¶²</a>ï¼Œå¯ä»¥æ­é… <code class=\"language-text\">StyleSheetManager</code>ï¼Œè®“ styled-components è‡ªå·± export å‡ºå«æœ‰ css text çš„ style tagï¼Œä½†çµæœé‚„æ˜¯ä¸€æ¨£æœ‰å•é¡Œï¼ˆå¾Œé¢æœƒè§£é‡‹åŸå› ï¼‰ã€‚</p>\n<p>å› æ­¤ï¼Œé‚„æ˜¯å¾—ä»”ç´°äº†è§£è©²å¦‚ä½•è®“ styled component èƒ½æ­£ç¢º rehydrateï¼Œè®€å–æˆ‘å€‘åœ¨ prerender æ™‚å°±å·²ç¶“è™•ç†éçš„ styleï¼Œæ‰ä¸æœƒé€ æˆ class name è¡çªï¼Œä»¥åŠæœ‰å¤šé¤˜çš„ style tag ç”¢ç”Ÿã€‚</p>\n<h3 id=\"styled-components-çš„-hydration\" style=\"position:relative;\"><a href=\"#styled-components-%E7%9A%84-hydration\" aria-label=\"styled components çš„ hydration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>styled-components çš„ hydration</h3>\n<p>çŸ¥é“ solution çš„æ–¹å‘å¾Œï¼Œé–‹å§‹åˆ°å®˜ç¶²æŸ¥é–±é—œæ–¼ server side hydration çš„è³‡æ–™ï¼Œç™¼ç¾æœ‰é‡å° server-side rendering æ‰€æå‡ºçš„<a href=\"https://styled-components.com/docs/advanced#server-side-rendering\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">è§£æ±ºæ–¹æ¡ˆ</a>ï¼šåˆ©ç”¨ <code class=\"language-text\">ServerStyleSheet</code> å¯ä»¥æ­é… <code class=\"language-text\">StyleSheetManager</code> providerï¼Œè®“ styled-components åœ¨ server-side èƒ½å¤ ç”¢ç”Ÿ css styleï¼Œä¸¦ä¸”æä¾›æ©Ÿåˆ¶è®“è©² style èƒ½åœ¨ client-side è¢« rehydrateï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> sheet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerStyleSheet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">StyleSheetManager</span></span> <span class=\"token attr-name\">sheet</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>sheet<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">YourApp</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">StyleSheetManager</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> styleTags <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span><span class=\"token function\">getStyleTags</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// or sheet.getStyleElement();</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle error</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n  sheet<span class=\"token punctuation\">.</span><span class=\"token function\">seal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>çœ‹èµ·ä¾†å°±æ˜¯è©²é€™æ¨£åšï¼Œä¸éå‘¢ï¼Œå…‰å¾åå­—å°±è·Ÿä½ èªªäº†ä»–æ˜¯çµ¦ä½ åœ¨ Server ç”¨çš„ï¼Œç”šè‡³é‚„åœ¨æ–‡æª”ä¸­å¯«ä¸Šï¼š<em>Just make sure not to use it on the client-side.</em></p>\n<p>ä½†æˆ‘å€‘çš„ prerender å¯¦éš›ä¸Šæ˜¯è·‘åœ¨ client ç«¯ï¼Œé€™æ¨£è‚¯å®šä¸è¡Œå§ï¼Ÿ</p>\n<p>æˆ‘åŸæœ¬ä¹Ÿæ˜¯é€™æ¨£æƒ³ï¼Œæ‰“ç®—æ”¾æ£„çš„æ™‚å€™ï¼Œæˆ‘å„ªç§€çš„<a href=\"https://github.com/whatasoda\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">åŒäº‹</a>è·‘å»è®€äº†è®€ styled-components çš„åŸå§‹ç¢¼ï¼Œç™¼ç¾ <code class=\"language-text\">ServerStyleSheet</code> å…§å…¶å¯¦æ²’æœ‰ç”¨åˆ°ä»»ä½• NodeJS ç¨æœ‰çš„ APIï¼Œä¹Ÿå°±æ˜¯èªªå¯¦éš›ä¸Š <code class=\"language-text\">ServerStyleSheet</code> è·‘åœ¨ client ç«¯ä¹Ÿæ˜¯æ²’å•é¡Œçš„ï¼</p>\n<p><code class=\"language-text\">ServerStyleSheet</code> è·Ÿä¸€èˆ¬ styled-components åœ¨ client ç«¯ä½¿ç”¨çš„ <code class=\"language-text\">StyleSheet</code>ï¼ˆstyled-components è‡ªå·±<a href=\"https://github.com/styled-components/styled-components/blob/b19d17f1d6739d0cc6da826cf701a9ee3c075525/packages/styled-components/src/sheet/Sheet.js#L26\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å¯¦ä½œçš„ç‰ˆæœ¬</a>ï¼Œä¸¦é <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/StyleSheet\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Browser å…§å»ºçš„ StyleSheet</a>ï¼‰å·®åˆ¥åœ¨æ–¼ï¼Œ<code class=\"language-text\">ServerStyleSheet</code> å¤šå‚³äº†ä¸€å€‹ <a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/models/ServerStyleSheet.js#L22\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">isServer = true</code> çš„ option</a> çµ¦ <code class=\"language-text\">StyleSheet</code>ï¼Œè€Œé€™æœƒä½¿å¾— styled-components çš„ <code class=\"language-text\">StyleSheet</code> åœ¨ <code class=\"language-text\">makeTag</code> çš„æ™‚å€™ï¼Œä¸æ˜¯å»ç”Ÿæˆä¸€å€‹å¯¦éš›çš„ style tagï¼Œè€Œæ˜¯ç”¢ç”Ÿä¸€å€‹ <code class=\"language-text\">VirtualTag</code>ï¼š</p>\n<p><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet/Tag.js#L7-L16\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source code</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">/** Create a CSSStyleSheet-like tag depending on the environment */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> makeTag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isServer<span class=\"token punctuation\">,</span> useCSSOMInjection<span class=\"token punctuation\">,</span> target <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> SheetOptions<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Tag <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isServer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VirtualTag</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>useCSSOMInjection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CSSOMTag</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextTag</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>é€™å€‹ <code class=\"language-text\">VirtualTag</code> åŒ…å«æ‰€æœ‰ style çš„è³‡è¨Šï¼Œä½†ä¸éœ€è¦æ“ä½œåˆ°å¯¦éš›çš„ DOMï¼Œé€™å°±æ˜¯è®“ styled-components èƒ½æ”¯æ´ SSR çš„åŸå› ã€‚</p>\n<p>è€Œ <code class=\"language-text\">StyleSheet</code> çš„ <code class=\"language-text\">toString</code> <a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet/Sheet.js#L122\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å‡½å¼</a>ï¼Œèƒ½å¤  serialize <code class=\"language-text\">makeTag</code> ç”¢ç”Ÿçš„ tag çš„å…§å®¹ï¼š</p>\n<p><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet/Rehydration.js#L10-L39\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source code</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">outputSheet</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sheet<span class=\"token operator\">:</span> Sheet<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tag <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span><span class=\"token function\">getTag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> length <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> tag<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> css <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> group <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> group <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> group<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">getIdForGroup</span><span class=\"token punctuation\">(</span>group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> names <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span>names<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> rules <span class=\"token operator\">=</span> tag<span class=\"token punctuation\">.</span><span class=\"token function\">getGroup</span><span class=\"token punctuation\">(</span>group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>names <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> rules<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> selector <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">SC_ATTR</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.g</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>group<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">[id=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"]</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> content <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>names <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      names<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          content <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// NOTE: It's easier to collect rules and have the marker</span>\n    <span class=\"token comment\">// after the actual rules to simplify the rehydration</span>\n    css <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rules<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selector<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">{content:\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>content<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"}</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">SPLITTER</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> css<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å†æ­é… <code class=\"language-text\">ServerStyleSheet</code> æä¾›çš„ <code class=\"language-text\">getStyleTags</code> æ–¹æ³•ï¼Œèƒ½å¤  output å‡ºæ­£ç¢ºçš„ style tag ä¾† inject åˆ°ä½  SSR ç”¢ç”Ÿçš„ HTML å…§ï¼Œè®“ styled-components å¯ä»¥é †åˆ© Rehydrateã€‚</p>\n<p>è€Œä½•è¬‚ â€œæ­£ç¢ºâ€ çš„ style tag å‘¢ï¼Ÿ</p>\n<p>åœ¨æˆ‘å€‘æœ€ä¸€é–‹å§‹çš„å¯¦ä½œä¸­ï¼Œæˆ‘å€‘è‡ªå·±æ˜¯é€éä¸‹é¢é€™èˆ¬æ–¹å¼ç”¢ç”Ÿå‡ºè¦ inject åˆ° HTML ä¸­çš„ style tagï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'style'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">elem</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// styled-components é è¨­ç”¢ç”Ÿçš„ tag æœƒæ˜¯ç©ºçš„ï¼Œå› ç‚ºæ¡ç”¨ CSSOM API insertRule</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">!==</span> <span class=\"token string\">''</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>sheet <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">CSSStyleSheet</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\t\n  elem<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>sheet<span class=\"token punctuation\">.</span>cssRules <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\t\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">rule</span> <span class=\"token operator\">=></span> rule<span class=\"token punctuation\">.</span>cssText<span class=\"token punctuation\">)</span>\t\n    <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ä¹Ÿå°±æ˜¯èªªæˆ‘å€‘æ˜¯å–å‡º styled-components é è¨­ç”¢å‡ºçš„ style tagï¼ŒæŠŠå…¶ä¸­çš„ cssRules è®€å‡ºä¾†å¾Œå¡å›å»ã€‚</p>\n<p>é€™æ¨£çš„åšæ³•éŒ¯åœ¨æœƒä¿ç•™ style tag ä¸Šçš„å…¶ä»–å±¬æ€§ï¼Œåƒæ˜¯ <code class=\"language-text\">data-styled=active</code>ã€‚</p>\n<p>ç•¶ styled-components åœ¨é€²è¡Œ Rehydrate æ™‚ï¼Œä»–æœƒå»æŠ“å– <code class=\"language-text\">data-styled</code> ä¸ç‚º <code class=\"language-text\">active</code> çš„ style tag ä¾† parseï¼Œä¸¦é€²è¡Œ rehydrateï¼š</p>\n<p><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet/Rehydration.js#L89\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source code</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">rehydrateSheet</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sheet<span class=\"token operator\">:</span> Sheet<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> nodes <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SELECTOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> HTMLStyleElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SC_ATTR</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token constant\">SC_ATTR_ACTIVE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">rehydrateSheetFromTag</span><span class=\"token punctuation\">(</span>sheet<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        node<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>é€™ä¹Ÿèªªæ˜äº†ç‚ºä»€éº¼ä¸€é–‹å§‹æˆ‘ä½¿ç”¨ <code class=\"language-text\">disableCSSOMInjection</code> è®“ styled-components å¹«æˆ‘ç”¢ç”Ÿ text node-based çš„ css style tag ä¹Ÿæ²’æœ‰ç”¨ï¼Œå› ç‚ºé‚£æ¨£ç”¢ç”Ÿçš„ style tag ã„§æ¨£æœƒæ˜¯å¸¶æœ‰ <code class=\"language-text\">data-style=active</code> çš„å±¬æ€§ï¼Œä¸¦ä¸æœƒè¢« styled-components æ‹¿å» rehydrateã€‚</p>\n<p>é€™æ™‚æˆ‘å€‘æ›´åŠ é‡æ¸…äº†å•é¡Œã€‚</p>\n<p>é¦–å…ˆï¼Œæœ‰å…©å€‹ styled-components çš„ style tag çš„ç¢ºä¸å°ï¼Œä½†<strong>é‡é»æ˜¯é€™å…©å€‹ style tag åŒæ™‚éƒ½æ“æœ‰ <code class=\"language-text\">data-styled</code> ç‚º <code class=\"language-text\">true</code> çš„å±¬æ€§ï¼Œä»¥è‡´æ–¼ styled-components åœ¨ rehydrate çš„æ™‚å€™æŠ“ä¸åˆ°å¯ç”¨çš„ style tagã€‚</strong></p>\n<p>å¦å¤–ï¼Œä¹Ÿä¸æ˜¯å–®ç´” <code class=\"language-text\">data-styled</code> ä¸ç‚º <code class=\"language-text\">true</code> çš„ style tag å°±å¯ä»¥è¢« rehydrateï¼Œå‰é¢æåˆ° <code class=\"language-text\">StyleSheet</code> çš„ <code class=\"language-text\">toString</code> èƒ½å¤  serialize <code class=\"language-text\">VirtualTag</code> çš„å…§å®¹ï¼Œå…¶ä¸­æœ‰ä¸€æ®µç¨‹å¼ç¢¼èˆ‡è¨»è§£ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// NOTE: It's easier to collect rules and have the marker</span>\n<span class=\"token comment\">// after the actual rules to simplify the rehydration</span>\ncss <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rules<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selector<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">{content:\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>content<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"}</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">SPLITTER</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>é€™é‚ŠæŒ‡ç¤ºå‡ºï¼Œè¦èƒ½å¤ è¢« rehydrate çš„ text node-based çš„ css style tagï¼Œéœ€è¦æœ‰ç‰¹å®šçš„ <code class=\"language-text\">SPLITTER</code>ï¼š</p>\n<p><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/constants.js#L13\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source code</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">SPLITTER</span> <span class=\"token operator\">=</span> <span class=\"token string\">'/*!sc*/\\n'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet/Rehydration.js#L55\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source code</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">rehydrateSheetFromTag</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sheet<span class=\"token operator\">:</span> Sheet<span class=\"token punctuation\">,</span> style<span class=\"token operator\">:</span> HTMLStyleElement<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> parts <span class=\"token operator\">=</span> style<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SPLITTER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> rules<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ... ç•¥</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h2 id=\"é‡æ–°æ¢³ç†ä¸€ä¸‹å•é¡Œèˆ‡è§£æ³•\" style=\"position:relative;\"><a href=\"#%E9%87%8D%E6%96%B0%E6%A2%B3%E7%90%86%E4%B8%80%E4%B8%8B%E5%95%8F%E9%A1%8C%E8%88%87%E8%A7%A3%E6%B3%95\" aria-label=\"é‡æ–°æ¢³ç†ä¸€ä¸‹å•é¡Œèˆ‡è§£æ³• permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>é‡æ–°æ¢³ç†ä¸€ä¸‹å•é¡Œèˆ‡è§£æ³•</h2>\n<h3 id=\"å•é¡Œ\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C\" aria-label=\"å•é¡Œ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å•é¡Œ</h3>\n<p>æˆ‘å€‘é é¢ prerender å®Œçš„çµæœï¼Œåœ¨ client ç«¯ first load èˆ‡ JS bundle rehydrate å¾Œçš„æ¨£å¼ä¸åŒï¼ŒåŸå› æ˜¯åˆ©ç”¨ client side render è£½ä½œ prerender æ™‚ï¼Œç”¢ç”Ÿå…©å€‹åŒæ¨£æ“æœ‰ <code class=\"language-text\">data-styled=true</code> å±¬æ€§çš„ styled-components style tagï¼Œé€ æˆ styled-components ç„¡æ³• rehydrateï¼Œåªå¥½é‡æ–°ç”¢ç”Ÿæ–°çš„ style tagï¼Œå› è€Œç ´å£äº†é é¢æ¨£å¼ã€‚</p>\n<h3 id=\"è§£æ³•\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B3%95\" aria-label=\"è§£æ³• permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è§£æ³•</h3>\n<p>ä½¿ç”¨ <code class=\"language-text\">ServerStyleSheet</code> æ­é… <code class=\"language-text\">StyleSheetManager</code> åœ¨ prerender éšæ®µç”Ÿæˆ <code class=\"language-text\">VirtualTag</code>ï¼ˆé€™é‚Šçš„ä½¿ç”¨æ–¹æ³•ç¨å¾® hack äº†ä¸€é»ï¼Œå› ç‚ºæˆ‘å€‘çš„ prerender æ˜¯ client-side renderï¼Œè€Œå®˜æ–¹ä¸å»ºè­°å°‡ <code class=\"language-text\">ServerStyleSheet</code> ä½¿ç”¨åœ¨ client sideï¼‰ï¼Œæ¥è‘—å†é€é <code class=\"language-text\">ServerStyleSheet</code> çš„ <code class=\"language-text\">getStyleTags</code> å–å¾—å¯è¢« styled-components å­˜å–é€²è¡Œ rehydration çš„ style tagï¼Œä¸¦ inject åˆ° prerendered HTML ä¸­ã€‚</p>\n<p>ä¸»è¦çš„ç¨‹å¼ç¢¼ç‰‡æ®µå¦‚ä¸‹ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> sheet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerStyleSheet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// æ”¾åœ¨æ•´å€‹ Application çš„æœ€ä¸Šå±¤</span>\n<span class=\"token keyword\">const</span> StyleSheetProvider<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>StyleSheetManager sheet<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>sheet<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">}</span> children<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// åœ¨ prerender çµæŸï¼Œç”¢ç”Ÿ HTML å¾ŒåŸ·è¡Œ</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">injectStyleElement</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> style <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'style'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>style<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  style<span class=\"token punctuation\">.</span>outerHTML <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span><span class=\"token function\">getStyleTags</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sheet<span class=\"token punctuation\">.</span><span class=\"token function\">seal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>åˆ°é€™é‚Šç‚ºæ­¢å°±ç®—æ˜¯å°‡å•é¡Œè§£æ±ºäº†ï¼Œä½†æœƒç™¼ç¾é‚„æ˜¯æœ‰å•é¡Œï¼Œé›–ç„¶ style tag æˆåŠŸåªå‰©ä¸‹ä¸€å€‹ï¼Œçœ‹èµ·ä¾† rehydrate ä¹Ÿæœ‰æˆåŠŸï¼Œä½†æ¨£å¼é‚„æ˜¯è·‘æ‰äº†ã€‚</p>\n<p>é‚„å¥½é€™å€‹åŸå› å¾ˆå¥½æ‰¾ï¼Œå®˜ç¶²å°±æœ‰<a href=\"https://styled-components.com/docs/advanced#tooling-setup\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">è§£ç­”</a> ï¼š</p>\n<blockquote>\n<p>In order to reliably perform server side rendering and have the client side bundle pick up without issues, you'll need to use our babel plugin. It prevents checksum mismatches by adding a deterministic ID to each styled component.</p>\n</blockquote>\n<p>å°±æ˜¯ SSR æœ€å¸¸è¦‹çš„ checksum issueï¼Œæˆ‘å€‘éœ€è¦çµ¦æ¯ä¸€å€‹ styled-component ä¸€å€‹åœ¨å‰å¾Œç«¯ä¸€è‡´çš„ IDï¼Œé€™æ¨£æ‰å¯ä»¥ç¢ºä¿ rehydrate å¾Œèƒ½å¤ æ“æœ‰ç›¸åŒçš„ classã€‚</p>\n<p>åŠ ä¸Š <a href=\"https://styled-components.com/docs/tooling#babel-plugin\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">babel-plugin</a> å¾Œå•é¡Œå°±æˆåŠŸè§£æ±ºäº†ï¼</p>\n<h2 id=\"çµè«–\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"çµè«– permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>çµè«–</h2>\n<p>ç¶“éé€™æ¬¡çš„é™¤éŒ¯éç¨‹ï¼Œæˆ‘æ‰ç™¼ç¾è‡ªå·±å°æ–¼ styled-component é€™é¡ React ç”Ÿæ…‹ç³»çš„å¥—ä»¶äº†è§£åº¦ä¸å¤ æ·±ï¼Œæ‰å°è‡´åœ¨ä¸€é–‹å§‹è¨­è¨ˆå¯¦ä½œ prerender æ™‚æ²’æœ‰æ³¨æ„åˆ°é€™ä»¶äº‹æƒ…ï¼Œå¦å¤–ä¹Ÿé€éé€™æ¬¡çš„ç´€éŒ„ç™¼ç¾è¦å°‡ä¸€å€‹ bug çš„åŸå› èˆ‡è§£æ³•å¾é ­åˆ°å°¾æ›¸å¯«å‡ºä¾†æœ‰å¤šå›°é›£ï¼Œç•¢ç«Ÿæ•´å€‹é™¤éŒ¯éç¨‹ä½ å¯èƒ½æ˜¯è·³è€€æ€§çš„åœ¨æ€è€ƒå„ç¨®å¯èƒ½ï¼Œæ–‡ç« ä¸­çš„æ¯å€‹æ­¥é©Ÿå…¶å¯¦ä¹Ÿçµ•å°ä¸æ˜¯é€™æ¨£ä¸€æ­¥æ­¥æ‰¾å‡ºè§£æ³•çš„ï¼Œè¦æœ‰æ¢ç†çš„å°‡å…¶æ¢³ç†å‡ºä¸€å€‹æµæš¢çš„ flow çœŸçš„éœ€è¦ä¸€é»åŠŸåŠ›ï¼Œçœ‹ä¾†æˆ‘é‚„æœ‰å¾ˆå¤§çš„é€²æ­¥ç©ºé–“ï¼</p>\n<p>é›–ç„¶é€™æ¬¡çš„å•é¡Œå¯¦éš›ä¸Šçš„è§£æ³•ä¸éœ€è¦æ›´å‹•å¤šå°‘ç¨‹å¼ç¢¼ï¼ŒåŸç†ä¹Ÿå¾ˆç°¡å–®ï¼Œä½†è‹¥æ˜¯æ²’æœ‰åƒæˆ‘åŒäº‹é‚£æ¨£é‘½å…¥ç¨‹å¼ç¢¼å»æŸ¥çœ‹ï¼Œå…‰æ˜¯æ†‘é è‡ªå·±çš„é‚è¼¯æ˜¯å¾ˆé›£æ€è€ƒå‡ºä¾†çš„ã€‚æ•´å€‹éç¨‹å­¸ç¿’åˆ°å¾ˆå¤šï¼Œé‡åˆ°é€™å€‹ bug çœŸæ˜¯å¤ªå¥½äº†ï¼ï¼ˆå¥½åƒæ€ªæ€ªçš„...ï¼‰</p>\n<h3 id=\"è³‡æ–™ä¾†æº\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"è³‡æ–™ä¾†æº permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è³‡æ–™ä¾†æº</h3>\n<ol>\n<li><a href=\"https://styled-components.com/docs/advanced\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">styled-component website</a></li>\n<li><a href=\"https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/sheet\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">styled-component source code</a></li>\n</ol>","id":"342141e0-0a2e-53ff-8ba8-a915956520a3","fields":{"slug":"styld-component-prerendering-issue"},"frontmatter":{"date":"2020-08-15T13:37:30.000Z","title":"å¦ä¸€å€‹èˆ‡ styled-components ç›¸é—œçš„ debug ç´€éŒ„","tags":["web","styled-components","server-side generated page","react"],"type":"tech","slug":"styld-component-prerendering-issue"},"timeToRead":13},"next":{"excerpt":"å¥½æ­Œåˆ†äº«ï¼šSunset Rollercoaster - Candlelight feat. OHHYUK","html":"<blockquote>\n<p>å¥½æ­Œåˆ†äº«ï¼š<a href=\"https://youtu.be/kb0whVogBkI\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sunset Rollercoaster - Candlelight feat. OHHYUK</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/kb0whVogBkI\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h2 id=\"å‰è¨€\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"å‰è¨€ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å‰è¨€</h2>\n<p>Airbnb ä¸€å‘åœ¨å‰ç«¯èˆ‡è¨­è¨ˆä¸Šæœ‰æ·±åˆ»è‘—å¢¨ï¼Œç¸½èƒ½æ¨å‡ºè³ªæ„Ÿå¾ˆå¥½çš„å·¥å…·çµ¦ç›¸é—œäººå“¡ä½¿ç”¨ï¼Œè€Œåœ¨ä¸Šå€‹æœˆä»–å€‘é‡‹å‡ºäº† v1.0 ç‰ˆæœ¬çš„è³‡æ–™è¦–è¦ºåŒ–å¥—ä»¶ - <a href=\"https://github.com/airbnb/visx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">visx</a>ï¼Œå¼·èª¿ç‰¹è‰²æ˜¯æ¶æ§‹åœ¨ React ä¸Šï¼Œæä¾›èˆ‡é¡ä¼¼ D3 çš„åº•å±¤ API ä¾†è£½ä½œåœ–è¡¨ã€‚ç„¶è€Œçµåˆ React èˆ‡ D3 çš„å¥—ä»¶ä½•å…¶å¤šï¼ŒAirbnb å‡ºå“çš„ visx èˆ‡å…¶å®ƒç”¢å“çš„å·®ç•°æ˜¯ä»€éº¼ï¼Œä½¿ç”¨èµ·ä¾†çš„æ„Ÿè¦ºåˆæ˜¯å¦‚ä½•ï¼Œä»Šå¤©è¶è‘—é›™åé€£å‡ï¼Œå˜—è©¦å¯¦éš›å¯«å¯«çœ‹ï¼Œä¸¦è·Ÿå¤§å®¶åˆ†äº«ã€‚</p>\n<p>ç…§ä¾‹å…ˆå±•ç¤ºå€‹æœ€çµ‚ç¯„ä¾‹ï¼š</p>\n<p><img src=\"/image/visx-final-demo.gif\" alt=\"final demo\"></p>\n<a href=\"https://codesandbox.io/s/simpleradar-aqi-with-tooltip-select-data-react-spring-item3?fontsize=14&amp;hidenavigation=1&amp;theme=dark&amp;view=preview\">\n  <img alt=\"Edit SimpleRadar-AQI (with Tooltip + select data)  (react-spring)\" src=\"https://codesandbox.io/static/img/play-codesandbox.svg\">\n</a>\n<h2 id=\"visx-ç°¡ä»‹\" style=\"position:relative;\"><a href=\"#visx-%E7%B0%A1%E4%BB%8B\" aria-label=\"visx ç°¡ä»‹ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>visx ç°¡ä»‹</h2>\n<p>visx åœ¨ä¸‰å¹´å‰å°±å·²ç¶“é–‹æºäº†ï¼Œç•¶æ™‚å«åš vxï¼Œä¸€ç›´è™•æ–¼ beta çš„ç‹€æ…‹ï¼Œè€Œå¯¦éš›ä¸Šåœ¨ Airbnb å…§éƒ¨å·²ç¶“æ‡‰ç”¨åœ¨å„ç¨®æ­£å¼ç’°å¢ƒçš„å°ˆæ¡ˆä¸Šå…©å¹´å¤šï¼Œä¸­é–“ç¶“éè¨±å¤šæ›´æ–°ä¸¦ä»¥ TypeScript é‡å¯«éï¼Œæ‰åœ¨ä¸Šå€‹æœˆä»¥ 1.0 çš„ç‰ˆæœ¬å†æ¬¡å•ä¸–ã€‚</p>\n<p>å¦‚åŒå‰è¨€æåˆ°çš„ï¼Œå¸‚é¢ä¸Šä¸ä¹æ•´åˆ React èˆ‡ D3 çš„å¥—ä»¶å¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸”å¤§å¤šæ•¸éƒ½ç›¡é‡è¨­è¨ˆå¾—ç°¡å–®æ˜“ç”¨ï¼Œè³‡æ–™å‚³é€²å»ï¼Œä¸€çµ„ Bar Chart å°±å‡ºä¾†äº†ï¼Œç‚ºä»€éº¼ Airbnb è¦åœ¨è‡ªå·±æ‰“é€ ä¸€å¥—å·¥å…·å‘¢ï¼Ÿ</p>\n<p>åœ¨å®˜æ–¹çš„ <a href=\"https://medium.com/airbnb-engineering/introducing-visx-from-airbnb-fd6155ac4658\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">blog</a> ä¸­ä»–å€‘ç¹ªè£½äº†ä¸€å¼µåœ–ç²¾ç°¡çš„è§£é‡‹äº†é€™å€‹å·¥å…·å­˜åœ¨çš„æ„ç¾©ï¼š</p>\n<p><img src=\"https://miro.medium.com/max/700/1*K7IJg1Gd_grQEhnos0XiqQ.png\" alt=\"why visx\">\nï¼ˆå·å·åæ§½ä¸€ä¸‹ï¼Œä»–å€‘çš„ logo æ”¾åœ¨é€™åœ–è£¡æ„Ÿè¦ºåƒæ˜¯åœ¨é‚£æ¬„ç•«äº†ä¸€çš„å¤§å‰å‰...)</p>\n<p>é‚£äº›éš¨æ’å³ç”¨çš„ Chart library ä¹‹æ‰€ä»¥ç„¡æ³•æ’¼å‹• D3 åœ°ä½çš„åŸå› åœ¨æ–¼ç¼ºä¹è¶³å¤ çš„ Expressiveï¼Œä¹Ÿå°±æ˜¯ä¸å¤ åº•å±¤ï¼Œèƒ½å¤ æ“æ§çš„ç¯„åœå—é™ï¼Œç›¸å°çš„ï¼ŒD3 å‰‡æä¾›äº†éå¸¸å¤šçš„åº•å±¤ä»‹é¢è®“ä½ èƒ½ç´°ç·»çš„æ“ä½œè³‡æ–™èˆ‡ç•«é¢çš„æ•´åˆäº’å‹•ã€‚</p>\n<p>ç„¶è€Œ D3 å°æ–¼å‰ç«¯å·¥ç¨‹å¸«ä¾†èªªï¼Œæœ€è®“äººç•æ‡¼çš„å°±æ˜¯å…¶é™¡å³­çš„å­¸ç¿’æ›²ç·šï¼Œå°¤å…¶ç•¶ä½ å˜—è©¦å°‡ D3 ç›´æ¥é‹ç”¨åœ¨ä½ çš„ React å°ˆæ¡ˆå…§æ™‚ï¼Œå…©ç¨®æˆªç„¶ä¸åŒçš„ mental model èˆ‡æ“ä½œ DOM çš„æ–¹å¼ï¼Œç›¸ä¿¡ä¸€å®šæœƒåœ¨ä½ å¿ƒè£¡ç•™æœ‰èŠ¥è’‚ï¼Œç•¶ç„¶ä¹Ÿå®¹æ˜“ç”¢ç”Ÿ Bugã€‚</p>\n<p>å› æ­¤ visx é‡å°é€™å¹¾å€‹å•é¡Œåšäº†è§£æ±ºï¼Œæä¾›ä»¥ä¸‹ä¸»è¦ç‰¹è‰²ï¼š</p>\n<ol>\n<li>\n<p>ä»¥ Typescript èˆ‡ React å¯¦ä½œ</p>\n<ul>\n<li>é€™å€‹ tech stack çµ„åˆæ‡‰è©²æ˜¯ç›®å‰å‰ç«¯ä¸»æµä¹‹ä¸€ï¼ŒAirbnb çš„å®˜æ–¹å‰ç«¯èªè¨€å°±æ˜¯ Typescriptï¼Œç¶²ç«™ä¹Ÿæ˜¯ä»¥ React ç‚ºä¸»ï¼Œä»¥æ­¤çµ„åˆå¯¦ä½œèƒ½é™ä½å‰ç«¯å·¥ç¨‹å¸«è¸å…¥è³‡è¨Šè¦–è¦ºåŒ–å°ˆæ¡ˆçš„é–€æª»ï¼Œç†Ÿæ‚‰çš„æ„Ÿè¦ºæœ€å°å‘³ã€‚</li>\n</ul>\n</li>\n<li>\n<p>ä»¥æ¨¡çµ„åŒ–çš„æ–¹å¼æä¾›è±å¯Œçš„åº•å±¤ã€Œç•«é¢æ“ä½œã€å…ƒä»¶å’Œå°‘è¨±çš„ Layout, interaction, svg, data utilities</p>\n<ul>\n<li>å‰ç«¯åœ¨ä¹çš„ä¸å¤–ä¹ç¾è§€ã€æ•ˆç‡èˆ‡å®‰å…¨ï¼Œåœ¨æ“ä½œè³‡è¨Šè¦–è¦ºå°ˆæ¡ˆæ™‚ï¼Œé¢å°å¤§é‡è³‡æ–™ï¼Œé™ä½ Bundle size ä»¥å¢åŠ æ•ˆèƒ½å°±å¾ˆé‡è¦äº†ï¼Œæ¯”èµ·å…¶ä»– Chart libraryï¼Œvisx æä¾›å„ç¨®åº•å±¤å…ƒä»¶è®“ä½ è‡ªå·±é¸æ“‡çµ„è£ï¼Œè¦ä½¿ç”¨çš„åœ¨è¼‰å…¥å³å¯ï¼Œä¸éœ€è¦æ•´åŒ…è£é€²å»ä½ çš„ Bundle å…§ã€‚e.g. <code class=\"language-text\">import { Bar } from '@vx/shape';</code></li>\n</ul>\n</li>\n<li>\n<p>Un-opinionated on purpose</p>\n<ul>\n<li>visx å¾ˆå¤§çš„ä¸€å€‹ç‰¹é»æ˜¯ï¼Œæ‰€æä¾›çš„æ¨¡çµ„èˆ‡å…ƒä»¶éƒ½æ˜¯ä»¥ React ç‚ºåŸºç¤å¯¦ä½œçš„ï¼Œå› æ­¤ç„¡è«–æ˜¯ç‹€æ…‹ç®¡ç†ã€å‹•ç•«æ“ä½œã€CSS solution ç­‰ç­‰ï¼Œä½ éƒ½ä¸éœ€è¦ç‰¹åˆ¥ç‚ºäº† visx å»åšè™•ç†æˆ–æ˜¯é¡å¤–çš„æ•´åˆï¼Œå°±ç•¶ä½œä¸€èˆ¬å¯« React project å³å¯ï¼Œä½ åŸæœ¬å¦‚ä½•åšå‹•ç•«ã€å¦‚ä½• theming, stylingï¼Œéƒ½å¯ä»¥æ²¿ç”¨ã€‚</li>\n</ul>\n</li>\n<li>\n<p>èˆ‡ D3 èƒ½äº’ç›¸æ­é…ä½¿ç”¨</p>\n<ul>\n<li>visx ä¸»è¦æä¾›åº•å±¤æ“ä½œ DOM çš„å…ƒä»¶ï¼Œè®“å‰ç«¯å·¥ç¨‹å¸«èƒ½ç”¨ä¸€å¥— mental modal è™•ç†ç•«é¢ï¼Œè€Œé—œæ–¼ data operation æˆ– scale function ç­‰é‹ç®—ï¼Œvisx è¨­è¨ˆä¸Šå°±æ˜¯å¸Œæœ›èƒ½ç¹¼çºŒåˆ©ç”¨ D3 æ‰€æä¾›çš„å¼·å¤§å‡½å¼åº«ä¾†è™•ç†ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>ç¶œåˆä»¥ä¸Šç‰¹è‰²ï¼Œä½¿ç”¨ visx èˆ‡ä½¿ç”¨ D3 çš„æœ€å¤§å·®ç•°åœ¨æ–¼ï¼Œ<strong>ä½ ä¸å†éœ€è¦äº†è§£ <code class=\"language-text\">d3.select</code>, data join, enter/exit status ç­‰ç­‰å±¬æ–¼ D3 æ ¹æ“š data æ›´æ–° DOM çš„é‚è¼¯æ€è·¯ï¼Œä½†åˆèƒ½ä¿æœ‰ç›¸å° primitives çš„å…ƒä»¶å¯ä½¿ç”¨ï¼Œè€Œä¸”åœ¨é€²è¡Œä¸€äº›å–®ç´”çš„è³‡æ–™é‹ç®—ã€scale å‡½å¼ä¸Šï¼Œä½ ä¹Ÿé‚„æ˜¯èƒ½ä½¿ç”¨ D3 æä¾›çš„ utilsã€‚</strong> å…¶é¤˜çš„ä¸€åˆ‡éƒ½æ˜¯ Reactï¼ŒåŒ…å« Layout responsive ç­‰ç­‰éƒ½æ˜¯ç”± React component ä¾†è² è²¬ã€‚</p>\n<p><img src=\"/image/airbnb-visx-doc.png\" alt=\"visx doc\"></p>\n<h2 id=\"å¯¦éš›æ¼”ç·´---å°ç£å…­éƒ½å³æ™‚ç©ºæ°£å“è³ªæŒ‡æ¨™\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E9%9A%9B%E6%BC%94%E7%B7%B4---%E5%8F%B0%E7%81%A3%E5%85%AD%E9%83%BD%E5%8D%B3%E6%99%82%E7%A9%BA%E6%B0%A3%E5%93%81%E8%B3%AA%E6%8C%87%E6%A8%99\" aria-label=\"å¯¦éš›æ¼”ç·´   å°ç£å…­éƒ½å³æ™‚ç©ºæ°£å“è³ªæŒ‡æ¨™ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å¯¦éš›æ¼”ç·´ - å°ç£å…­éƒ½å³æ™‚ç©ºæ°£å“è³ªæŒ‡æ¨™</h2>\n<p>ç°¡å–®ä»‹ç´¹å®Œ visx çš„ç‰¹è‰²ï¼Œæ¥è‘—å°±ä¾†å¯¦éš›æŠŠç©çœ‹çœ‹ï¼å®˜æ–¹ github é™„æœ‰ä¸€å€‹ç°¡å–®çš„ bar chart åœ–è¡¨ï¼Œä½†æ¯æ¬¡éƒ½ä½¿ç”¨ bar chart åšç¯„ä¾‹å¤ªç„¡è¶£ï¼Œå› æ­¤æŒ‘å€‹ç¨å¾®è¤‡é›œä¸€é»çš„ Radar chartï¼ˆé›·é”åœ–ï¼‰ ä¾†åšç¯„ä¾‹ã€‚</p>\n<p><a href=\"https://vis.baidu.com/chartusage/radar/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">é›·é”åœ–</a>é©åˆç”¨ä¾†å‘ˆç¾å¤šç¶­åº¦çš„è³‡æ–™ï¼Œç”¨ä¾†å±•ç¤ºè‡ºç£å…­éƒ½çš„å¹¾å€‹é‡è¦ç©ºæ°£å“è³ªæŒ‡æ¨™é …ç›®æ„Ÿè¦ºè »é©åˆçš„ï¼ŒåŠ ä¸Šå…¶ API åœ¨ æ”¿åºœ open data ä¸­åˆç®—æ˜¯æ¯”è¼ƒæ–¹ä¾¿å–ç”¨çš„ä¸€å€‹...</p>\n<p>API å–è‡ª <a href=\"https://opendata.epa.gov.tw/Data/Details/AQI/?show=all\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">è¡Œæ”¿é™¢ç’°å¢ƒä¿è­·ç½²ã€‚ç’°å¢ƒè³‡æºè³‡æ–™é–‹æ”¾å¹³è‡º</a>ï¼Œæ¯å°æ™‚æœƒæ›´æ–°ä¸€æ¬¡ã€‚</p>\n<p>ç‚ºäº†é«”é©— visx çš„ç‰¹è‰²ï¼Œé€™æ¬¡ç¯„ä¾‹çš„è£½ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ ¹æ“š API è³‡æ–™ï¼Œåˆ©ç”¨ visx å…ƒä»¶è£½ä½œå‡ºåŸºæœ¬ç•«é¢ï¼ˆäº†è§£åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼‰</li>\n<li>å¢åŠ è³‡æ–™åˆ‡æ›èˆ‡ tooltip ä½¿ç”¨ï¼ˆåŠ ä¸€é»è®ŠåŒ–ï¼‰</li>\n<li>æ¡ç”¨ react-spring å¢åŠ åˆ‡æ›è³‡æ–™æ™‚çš„å‹•ç•«ï¼ˆç¢ºèªæ˜¯å¦ Un-opinionated on animationï¼‰</li>\n<li>æ¡ç”¨ d3-scale ä¾†è™•ç†é¡è‰²è®Šæ›ï¼ˆäº†è§£å¦‚ä½•ä¸€èµ·é‹ç”¨ D3ï¼‰</li>\n</ol>\n<p>å®Œæ•´ç¨‹å¼ç¢¼å¯ä»¥å¾ <a href=\"https://codesandbox.io/s/simpleradar-aqi-with-tooltip-select-data-react-spring-item3?file=/Radar.tsx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CodeSandbox</a> ä¸Šå–å¾—ï¼Œé€™é‚Šåªæœƒæ“·å–é‡è¦éƒ¨åˆ†ã€‚</p>\n<p>é‚£éº¼å°±é–‹å§‹å§ï¼</p>\n<h3 id=\"ç¬¬ä¸€æ­¥ä½¿ç”¨-visx-å…ƒä»¶å †ç–Šå‡ºåŸºæœ¬ç•«é¢\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%B8%80%E6%AD%A5%E4%BD%BF%E7%94%A8-visx-%E5%85%83%E4%BB%B6%E5%A0%86%E7%96%8A%E5%87%BA%E5%9F%BA%E6%9C%AC%E7%95%AB%E9%9D%A2\" aria-label=\"ç¬¬ä¸€æ­¥ä½¿ç”¨ visx å…ƒä»¶å †ç–Šå‡ºåŸºæœ¬ç•«é¢ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨ visx å…ƒä»¶å †ç–Šå‡ºåŸºæœ¬ç•«é¢</h3>\n<p>è€å¯¦èªª visx å®˜ç¶²å…¶å¯¦æ²’ä»€éº¼æ–‡ä»¶ï¼Œéƒ½æ˜¯å¾ˆåŸºæœ¬çš„ props é¡å‹èˆ‡ä»‹ç´¹ï¼Œç¯„ä¾‹å°±ç›´æ¥ä¸Ÿç¨‹å¼ç¢¼çµ¦ä½ ï¼Œå”¯ä¸€ä¸€ç¯‡æ‰‹æŠŠæ‰‹æ•™ä½ å»ºç«‹å‡ºä¸€å€‹ bar chart çš„æ•™å­¸ä¹Ÿæ˜¯<a href=\"https://medium.com/vx-code/getting-started-with-vx-1756bb661410\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ä¸‰å¹´å‰</a>å¯«çš„ã€‚</p>\n<p>åœ¨é€™æ¢ä»¶ä¸‹ï¼Œæœ€å¥½çš„å­¸ç¿’æ–¹å¼ä¹Ÿåªæœ‰å¾ç¯„ä¾‹é–‹å§‹ï¼Œå‰›å¥½åœ¨ visx å®˜ç¶²çš„ Gallery å·²ç¶“æœ‰å€‹é›·é”åœ–çš„<a href=\"https://airbnb.io/visx/radar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ç¯„ä¾‹</a>ï¼Œå¯ä»¥æ ¹æ“šç¯„ä¾‹é€²è¡Œä¿®æ”¹ã€‚</p>\n<p>æœ¬æ­¥é©Ÿçš„çµæœå¯ä»¥å¾é€™å€‹ CodeSandbox å–å¾—ï¼š\n<a href=\"https://codesandbox.io/s/simpleradar-aqi-t1qjl?fontsize=14&hidenavigation=1&theme=dark&view=preview\">\n<img alt=\"Edit SimpleRadar-AQI\" src=\"https://codesandbox.io/static/img/play-codesandbox.svg\">\n</a></p>\n<p>é¦–å…ˆï¼Œè³‡æ–™è¦–è¦ºåŒ–çš„ç¬¬ä¸€æ­¥å°±æ˜¯æº–å‚™å¥½è³‡æ–™ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useDataFetch</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">URI</span> <span class=\"token operator\">=</span>\n    <span class=\"token string\">\"https://opendata.epa.gov.tw/api/v1/AQI?%24skip=0&amp;%24top=1000&amp;%24format=json\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> fallbackData<span class=\"token punctuation\">;</span> <span class=\"token comment\">// await (await fetch(URI)).json();</span>\n        <span class=\"token keyword\">const</span> fileterdData <span class=\"token operator\">=</span> data\n          <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* data process */</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* data process */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>fileterdData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> useDataFetch<span class=\"token punctuation\">;</span></code></pre></div>\n<p>åˆ©ç”¨å…ˆå‰æåˆ°çš„ä¿è­·ç½²é–‹æ”¾è³‡æ–™ API ä¾†å–å¾—å³æ™‚çš„å…­éƒ½ç©ºæ°£å“è³ªè³‡è¨Šã€‚ä¸é API response time å¾ˆä¹…ï¼Œä¸€æ¬¡ request å¯èƒ½è¦ç­‰å€‹åå¹¾äºŒåç§’...æ‰€ä»¥é–‹ç™¼ä¸Šæˆ‘å¤šæ”¾å€‹ fallback data æ“‹è‘—ï¼Œæ‰éƒ¨æœƒä¸€ç›´æ²’æœ‰ç•«é¢å‡ºç¾ã€‚</p>\n<p>é¡Œå¤–è©±ï¼Œvisx ä¹Ÿæä¾›ä¸€äº› mockdata ä¾›ä½ ä½¿ç”¨ï¼Œåƒæ˜¯ apple stock <code class=\"language-text\">import { appleStock } from '@vx/mock-data';</code>ã€‚</p>\n<p>æ¥è‘—æˆ‘å€‘éœ€è¦å®šç¾©ä¸€ä¸‹æ•´å€‹åœ–è¡¨çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯é•·å¯¬ï¼Œä½ å¯ä»¥å®šç¾©å›ºå®šå¤§å°çš„åœ–è¡¨ï¼Œæˆ–æ˜¯ä½¿ç”¨ visx ä¸­ä¸€å€‹å«åš <code class=\"language-text\">@visx/responsive</code> çš„ packageï¼Œè£¡é¢æœ‰ä¸‰ç¨®æ§åˆ¶å…ƒç´ å¤§å°çš„ HOC å¯ä»¥ä½¿ç”¨ï¼š<code class=\"language-text\">ParentSize</code>, <code class=\"language-text\">ScaleSVG</code> å’Œ <code class=\"language-text\">withScreenSize</code>ã€‚å¾åç¨±å¾ˆç°¡å–®å¯ä»¥çœ‹å‡ºåŠŸèƒ½ï¼Œé€™é‚Šæˆ‘æ¡ç”¨ <code class=\"language-text\">ParentSize</code>ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ParentSize</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Radar</span></span> <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>height<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ParentSize</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>åœ¨ <code class=\"language-text\">index.tsx</code> ä¸­ï¼Œç›´æ¥ç”¨ <code class=\"language-text\">ParentSize</code> åŒ…ä½æˆ‘çš„ <code class=\"language-text\">Radar</code> componentï¼Œå°‡å…¶é•·å¯¬å‚³å…¥ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œåªè¦ Parent container size æ”¹è®Šäº†ï¼Œæˆ‘çš„ Radar component å°±æœƒæ ¹æ“šæ–°å‚³å…¥çš„é•·å¯¬å»é€²è¡Œèª¿æ•´ã€‚</p>\n<p>æœ‰äº† Container çš„å¤§å°å¾Œï¼Œæ¥è‘—å®šç¾©é›·é”åœ–çš„åŠå¾‘ã€å¤§å°ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> xMax <span class=\"token operator\">=</span> width <span class=\"token operator\">-</span> margin<span class=\"token punctuation\">.</span>left <span class=\"token operator\">-</span> margin<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> yMax <span class=\"token operator\">=</span> height <span class=\"token operator\">-</span> margin<span class=\"token punctuation\">.</span>top <span class=\"token operator\">-</span> margin<span class=\"token punctuation\">.</span>bottom<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> radius <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>xMax<span class=\"token punctuation\">,</span> yMax<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> radialScale <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">scaleLinear</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  range<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> Math<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  domain<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>degrees<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> yScale <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">scaleLinear</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  range<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> radius<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  domain<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> webs <span class=\"token operator\">=</span> <span class=\"token function\">genAngles</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> points <span class=\"token operator\">=</span> <span class=\"token function\">genPoints</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> radius<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> polygonPoints <span class=\"token operator\">=</span> <span class=\"token function\">genPolygonPoints</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">yScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>é€™é‚ŠåŸºæœ¬ä¸Šåªè¦ç”¨é D3 çš„äººéƒ½æœƒè¦ºå¾—ç†Ÿæ‚‰ï¼Œåœ¨çœŸæ­£æ¸²æŸ“åœ–è¡¨å‰ï¼Œæœƒéœ€è¦ä¾ç…§è³‡æ–™å…§å®¹ã€é•·åº¦ç­‰ç­‰è£½ä½œé©ç•¶çš„ scale å‡½å¼ï¼Œä¾†æ˜ å°„é©ç•¶çš„å…ƒç´ å¤§å°åˆ°åœ–è¡¨ä¸Šã€‚</p>\n<p>é›·é”åœ–éœ€è¦çŸ¥é“çš„ä¸å¤–ä¹æ˜¯è³‡æ–™æ‰€åœ¨çš„è§’åº¦ï¼ˆradialScaleï¼‰èˆ‡åŠå¾‘ä½ç½®ï¼ˆyScaleï¼‰ï¼Œvisx çš„ <code class=\"language-text\">@visx/scale</code> æä¾›å¹¾ç¨® scale å‡½å¼ä¾›ä½ ä½¿ç”¨ï¼ŒåŸºæœ¬ä¸Šä»–å°±æ˜¯åœ¨ <a href=\"https://github.com/d3/d3-scale\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-scale</a> ä¸Šå¤–åŠ ä¸€å±¤ wrapperã€‚</p>\n<p>è€Œé›·é”æœ¬èº«çš„é»èˆ‡ç·šæ®µï¼ˆ<code class=\"language-text\">genAngles</code>, <code class=\"language-text\">genPoints</code>, <code class=\"language-text\">genPolygonPoints</code>ï¼‰ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åŸºæœ¬çš„æ•¸å­¸é‹ç®—ï¼Œè·Ÿ visx æœ¬èº«é—œä¿‚ä¸å¤§ï¼Œé€™é‚Šä¸è©³è¿°ç´°ç¯€ï¼Œå¯ä»¥åˆ°<a href=\"https://codesandbox.io/s/simpleradar-aqi-t1qjl?fontsize=14&hidenavigation=1&theme=dark&view=preview\">\n<img alt=\"Edit SimpleRadar-AQI\" src=\"https://codesandbox.io/static/img/play-codesandbox.svg\">\n</a>æŸ¥çœ‹å¯¦éš›ç¨‹å¼ç¢¼ã€‚</p>\n<p>scale å‡½å¼ä¹Ÿæº–å‚™å°±ç·’å¾Œï¼Œå°±å¯ä»¥ä¾†å‰µå»ºé›·é”åœ–è¡¨æœ¬èº«äº†ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> Radar <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>height<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>visx çš„å…ƒä»¶åŸºæœ¬ä¸Šéƒ½é æœŸä½ å°‡å…¶ render åœ¨ <code class=\"language-text\">svg</code> å…ƒç´ å…§ã€‚</p>\n<p>æ¥è‘—è¼‰å…¥å¹¾å€‹å»ºç«‹é›·é”åœ–éœ€è¦çš„ packagesï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Group <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@visx/group\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Line<span class=\"token punctuation\">,</span> LineRadial <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@visx/shape\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Text <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@visx/text\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">Group</code>, <code class=\"language-text\">Line</code> èˆ‡ <code class=\"language-text\">Text</code> åŸºæœ¬å°æ‡‰ svg å…§çš„ <code class=\"language-text\">g</code>, <code class=\"language-text\">line</code> å’Œ <code class=\"language-text\">text</code>ï¼›<code class=\"language-text\">LineRadial</code> å‰‡æ˜¯ visx æä¾›çš„ <a href=\"https://airbnb.io/visx/docs/shape\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">shape</code> å…ƒä»¶</a>ã€‚</p>\n<p>çµ„åˆèµ·ä¾†çš„ render functionï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>height<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rect</span> <span class=\"token attr-name\">fill</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>background<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>height<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">rx</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">14</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Group</span></span> <span class=\"token attr-name\">top</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> margin<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">left</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>width <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Array</span></span><span class=\"token punctuation\">(</span>levels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LineRadial</span></span>\n        <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">web-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">data</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>webs<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">angle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">radialScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>angle<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">radius</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> levels<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>none<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">stroke</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>silver<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">strokeWidth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">2</span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">strokeOpacity</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">0.8</span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">strokeLinecap</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>round<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Array</span></span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Line</span></span>\n          <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">radar-line-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span>\n          <span class=\"token attr-name\">from</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>zeroPoint<span class=\"token punctuation\">}</span></span>\n          <span class=\"token attr-name\">to</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>points<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span>\n          <span class=\"token attr-name\">stroke</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>silver<span class=\"token punctuation\">}</span></span>\n        <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Text</span></span>\n          <span class=\"token attr-name\">textAnchor</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>middle<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">verticalAnchor</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>middle<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">dx</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>points<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">}</span></span>\n          <span class=\"token attr-name\">dy</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>points<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">}</span></span>\n        <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Text</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>polygon</span>\n      <span class=\"token attr-name\">points</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>polygonPoints<span class=\"token punctuation\">.</span>pointString<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">fill</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>orange<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">fillOpacity</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">0.3</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">stroke</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>orange<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">strokeWidth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span>polygonPoints<span class=\"token punctuation\">.</span>points<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">point<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>circle</span>\n        <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">radar-point-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">cx</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>point<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">cy</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>point<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">r</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">4</span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">fill</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>pumpkin<span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Group</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>åˆ°é€™é‚Šå¯ä»¥ç™¼ç¾ï¼Œä½ å°±æ˜¯åœ¨å¯« React è€Œå·²ï¼ŒæŠŠ visx æä¾›çš„ component å †ç–Šåˆ° <code class=\"language-text\">svg</code> å…ƒç´ ä¸­ï¼Œç„¶å¾ŒæŠŠ data ç•¶ä½œ props å‚³å…¥å³å¯ï¼Œä¸ç”¨å†å»æ€è€ƒä»€éº¼ <code class=\"language-text\">d3.select</code>ï¼Œæ›´ä¸ç”¨ç†è§£ D3 ä¸­ <code class=\"language-text\">enter/exit</code> ç­‰è³‡æ–™æ›´æ–°ç‹€æ…‹ã€‚</p>\n<p>åˆ°é€™é‚Šç‚ºæ­¢å°±èƒ½ç¹ªè£½å‡ºé€™æ¨£çš„åœ–è¡¨ï¼š</p>\n<p><img src=\"/image/simple-AQI.png\" alt=\"simple-AQI\"></p>\n<h3 id=\"å¢åŠ è³‡æ–™åˆ‡æ›èˆ‡-tooltip-ä½¿ç”¨\" style=\"position:relative;\"><a href=\"#%E5%A2%9E%E5%8A%A0%E8%B3%87%E6%96%99%E5%88%87%E6%8F%9B%E8%88%87-tooltip-%E4%BD%BF%E7%94%A8\" aria-label=\"å¢åŠ è³‡æ–™åˆ‡æ›èˆ‡ tooltip ä½¿ç”¨ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å¢åŠ è³‡æ–™åˆ‡æ›èˆ‡ tooltip ä½¿ç”¨</h3>\n<p>åœ¨ä¸Šä¸€æ­¥ä¸­ï¼Œåªæœ‰ç¹ªè£½ä¸€ä»½è³‡æ–™çš„åœ–è¡¨ï¼Œç¾åœ¨æ˜¯æ™‚å€™æŠŠå…­å€‹ç›´è½„å¸‚çš„è³‡æ–™éƒ½æ”¾é€²ä¾†ï¼Œä¸¦ä¸”åŠ ä¸Š tooltip ä¾†å‘ˆç¾è©³ç´°è³‡è¨Šï¼Œé€™æ¨£æ‰æ˜¯ä¸€å€‹åˆæ ¼çš„è³‡è¨Šåœ–è¡¨ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>apiData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useDataFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selectedIdx<span class=\"token punctuation\">,</span> setSelectedIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> apiData<span class=\"token punctuation\">[</span>selectedIdx<span class=\"token punctuation\">]</span><span class=\"token operator\">?.</span>info <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>æ›´æ–°è³‡æ–™çš„éƒ¨åˆ†ï¼Œç›´æ¥ç”¨ <code class=\"language-text\">useState</code> å»æ›´æ”¹è¦å‚³å…¥çµ¦ component çš„ props å³å¯ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Selector</span></span> <span class=\"token attr-name\">setSelectedIdx</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>setSelectedIdx<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">apiData</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>apiData<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>å¯ä»¥èˆ‡å…¶ä»– react component çµåˆï¼Œé€™é‚Šæˆ‘é¡å¤–å¯¦ä½œä¸€å€‹ selector component ä¾†åˆ‡æ›å…­éƒ½è³‡æ–™ã€‚</p>\n<p>ç•¶è³‡æ–™åˆ‡æ›ï¼Œ<code class=\"language-text\">setSelectedIdx</code> è¢«å‘¼å«ï¼Œcomponent é‡æ–° renderï¼Œæ‰€æœ‰ <code class=\"language-text\">svg</code> å…§æˆ‘å€‘å †ç–Šçš„ component ä¹Ÿéƒ½æœƒé€²è¡Œæ›´æ–°ï¼Œå°±æ˜¯ React çš„é‚è¼¯ã€‚</p>\n<p>è€Œ tooltip çš„éƒ¨åˆ†ï¼Œå¯ä»¥åˆ©ç”¨ <a href=\"https://airbnb.io/visx/docs/tooltip\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">@visx/tooltip</code></a> ä¾†å®Œæˆï¼Œ<code class=\"language-text\">@visx/tooltip</code> è·Ÿç›®å‰ä¸»æµçš„ react å¥—ä»¶ä¸€æ¨£ï¼Œæä¾› hook èˆ‡ HOC å…©ç¨®æ–¹æ³•å¯ä¾›ä½¿ç”¨ï¼š</p>\n<p>Hooks: <code class=\"language-text\">useTooltip()</code>, HOC: <code class=\"language-text\">withTooltip()</code></p>\n<p>é€™æ¬¡çš„ç¯„ä¾‹æˆ‘æ¡ç”¨ Hooksï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    tooltipData<span class=\"token punctuation\">,</span>\n    tooltipLeft<span class=\"token punctuation\">,</span>\n    tooltipTop<span class=\"token punctuation\">,</span>\n    tooltipOpen<span class=\"token punctuation\">,</span>\n    showTooltip<span class=\"token punctuation\">,</span>\n    hideTooltip\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useTooltip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> handleMouseOver <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">coords<span class=\"token punctuation\">,</span> datum</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">showTooltip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        tooltipLeft<span class=\"token operator\">:</span> coords<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span>\n        tooltipTop<span class=\"token operator\">:</span> coords<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span>\n        tooltipData<span class=\"token operator\">:</span> datum\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>showTooltip<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">useTooltip()</code> å›å‚³ tooltip å…§çš„è³‡æ–™ã€ä½ç½®ã€ç¾åœ¨é–‹å•Ÿèˆ‡å¦ï¼Œä»¥åŠæ§åˆ¶é¡¯ç¤ºèˆ‡éš±è— tooltip çš„å‡½å¼ã€‚æ­é…ä¸€äº› event handler å°±èƒ½è¼•é¬†é”æˆ tooltip åŠŸèƒ½ã€‚</p>\n<p>è‡³æ–¼ tooltip æœ¬èº«çš„å…ƒä»¶ï¼Œä¸¦ä¸æ˜¯ç”± Hooks å›å‚³ï¼Œå¾—å¾ <code class=\"language-text\">@visx/tooltip</code> ä¸­è¼‰å…¥ <code class=\"language-text\">Tooltip</code>ã€‚æ­¤å¤–ï¼Œé€™å€‹ <code class=\"language-text\">Tooltip</code> å…ƒä»¶å…¶å¯¦è »é›·çš„ï¼Œä»–è·Ÿå…¶ä»–çš„ visx component ä¸åŒï¼Œä¸æ˜¯è®“ä½ ç¹ªè£½åœ¨ <code class=\"language-text\">svg</code> å…§ï¼Œè€Œæ˜¯ render å‡ºä¸€å€‹ <code class=\"language-text\">div</code>ï¼Œè¦å°å¿ƒä¸è¦è·Ÿå…¶ä»– component ä¸€èµ·æ”¾åˆ° <code class=\"language-text\">svg</code> å…§äº†ã€‚</p>\n<p>å¦å¤–ï¼Œ<code class=\"language-text\">Tooltip</code> ä½¿ç”¨ <code class=\"language-text\">position: absolute</code> ä¾†æ§åˆ¶ä½ç½®ï¼Œé€™ä»£è¡¨è‘—ä½ å¿…é ˆéœ€è¦æä¾›ä»–ä¸€å€‹ Wrapper æ˜¯ <code class=\"language-text\">position: relatieve</code>ï¼Œæ‰èƒ½æ­£ç¢ºåœ°é¡¯ç¤ºç›¸å°ä½ç½®ï¼Œé€™ä¸¦ä¸æ˜¯é€™éº¼å¥½èª¿æ•´ï¼Œç®—æ˜¯ visx æˆ‘ä½¿ç”¨èµ·ä¾†è¦ºå¾—æœ‰å¾…æ”¹å–„çš„éƒ¨åˆ†ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> position<span class=\"token operator\">:</span> <span class=\"token string\">'relative'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* other components */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span>tooltipOpen <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tooltip</span></span>\n      <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">top</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>tooltipTop <span class=\"token operator\">+</span> height <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">left</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>tooltipLeft <span class=\"token operator\">+</span> width <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>tooltipStyles<span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>strong</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>tooltipData<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>strong</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Tooltip</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>æ­¤æ­¥é©Ÿæˆæœå¦‚ä¸‹ï¼š</p>\n<p><img src=\"/image/select-tooltip.png\" alt=\"selector-tooltip\">\n<a href=\"https://codesandbox.io/s/simpleradar-aqi-with-tooltip-select-data-jjb8v?fontsize=14&hidenavigation=1&theme=dark\">\n<img alt=\"Edit SimpleRadar-AQI (with Tooltip + select data) \" src=\"https://codesandbox.io/static/img/play-codesandbox.svg\">\n</a></p>\n<h3 id=\"ä½¿ç”¨-react-spring-è®“ç•«é¢å‹•èµ·ä¾†\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8-react-spring-%E8%AE%93%E7%95%AB%E9%9D%A2%E5%8B%95%E8%B5%B7%E4%BE%86\" aria-label=\"ä½¿ç”¨ react spring è®“ç•«é¢å‹•èµ·ä¾† permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ä½¿ç”¨ react-spring è®“ç•«é¢å‹•èµ·ä¾†</h3>\n<p>åŸºæœ¬åŠŸèƒ½éƒ½å®Œæˆå¾Œï¼Œå°±å¾—ä¾†åŠ ä¸Šé»å‹•ç•«ï¼Œé †ä¾¿é«”é©—çœ‹çœ‹ visx æ‰€è¬‚çš„ <strong>un-opinionated on purpose</strong> æ˜¯ä»€éº¼æ„Ÿè¦ºã€‚</p>\n<p>å¦‚æœæ˜¯ç”¨ D3 ç¹ªè£½åœ–è¡¨ï¼Œç•¶ä½ è¦è£½ä½œå‹•ç•«æ™‚ï¼Œå¿…é ˆå¾—æ³¨æ„è³‡æ–™çš„ join ç‹€æ…‹ï¼Œåœ¨æ²’æœ‰äº†è§£ <code class=\"language-text\">enter/exit</code> çš„æ¦‚å¿µå‰ï¼Œè¦è®“ d3 åœ–è¡¨å‹•èµ·ä¾†ï¼Œæœƒæ„Ÿè¦ºæ˜¯ç›²äººæ‘¸è±¡çœ‹ä¸æ¸…ã€‚</p>\n<p>è€Œä½¿ç”¨ visx çš„è©±ï¼ŒåŸºæœ¬ä¸Šä½ è¦æ“æ§çš„å°±æ˜¯å°‡è³‡æ–™ç•¶ä½œ props å‚³å…¥çš„ componentï¼Œè¦å¥—ä¸Šå“ªä¸€å¥— react animation library éƒ½å¯ä»¥ï¼Œæˆ‘æ¡ç”¨ <a href=\"https://www.react-spring.io/docs/hooks/basics\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">react-spring</a> ä¾†å°‡ polygon åœ¨è³‡æ–™åˆ‡æ›æ™‚åšä½ç§»çš„ transformï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useSpring<span class=\"token punctuation\">,</span> animated <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-spring\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>react-spring çš„ç”¨æ³•ä¹Ÿç®—ç°¡å–®ï¼Œæä¾›ä¸€å€‹ <code class=\"language-text\">useSpring</code> Hooks ä¾†ç”¢ç”Ÿä¸€å€‹ springï¼ˆmoves data from a -> bï¼‰ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> polygonPoints <span class=\"token operator\">=</span> <span class=\"token function\">genPolygonPoints</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">yScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> polygonProps <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> points<span class=\"token operator\">:</span> polygonPoints<span class=\"token punctuation\">.</span>pointString <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>æˆ‘å€‘æƒ³è¦è®“ polygon points è®Šå‹•æ™‚æœ‰å‹•ç•«æ•ˆæœï¼Œæ–¹æ³•å°±æ˜¯é€é <code class=\"language-text\">useSpring</code> é‡å° polygon points ç”Ÿæˆä¸€å€‹ springï¼Œç„¶å¾Œå°‡è©² spring å‚³å…¥ä»¥ <code class=\"language-text\">animated.polygon</code> å–ä»£çš„ polygon ä¸­ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>&lt;animated.polygon\n<span class=\"token prefix inserted\">+</span> points={polygonProps.points}\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>&lt;polygon\n<span class=\"token prefix deleted\">-</span> points={polygonPoints.pointString}\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> fill={polygonColor}\n<span class=\"token prefix unchanged\"> </span> fillOpacity={0.3}\n<span class=\"token prefix unchanged\"> </span> stroke={polygonColor}\n<span class=\"token prefix unchanged\"> </span> strokeWidth={1}\n</span>/></code></pre></div>\n<p>æ¯ç•¶è³‡æ–™åˆ‡æ›ï¼Œcomponent é‡æ–° render æ™‚ï¼Œæ–°ç”¢ç”Ÿçš„ spring å°±æœƒè¢«å‚³çµ¦ <code class=\"language-text\">animated.polygon</code>ï¼Œ<code class=\"language-text\">react-spring</code> å°±æœƒå¹«æˆ‘å€‘é€²è¡Œå…¶ä¸­çš„è£œé–“å‹•ç•«ã€‚å®Œå…¨ä¸éœ€è¦æ€è€ƒä»€éº¼ data enter, data exitï¼Œå°±æ˜¯å–®ç´”çš„ react component animationï¼š</p>\n<p><img src=\"/image/visx-final-demo.gif\" alt=\"final demo\"></p>\n<h3 id=\"æ­é…-d3-scale-é€²è¡Œè³‡æ–™èˆ‡é¡è‰²é‹ç®—\" style=\"position:relative;\"><a href=\"#%E6%90%AD%E9%85%8D-d3-scale-%E9%80%B2%E8%A1%8C%E8%B3%87%E6%96%99%E8%88%87%E9%A1%8F%E8%89%B2%E9%81%8B%E7%AE%97\" aria-label=\"æ­é… d3 scale é€²è¡Œè³‡æ–™èˆ‡é¡è‰²é‹ç®— permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>æ­é… d3-scale é€²è¡Œè³‡æ–™èˆ‡é¡è‰²é‹ç®—</h3>\n<p>æœ€å¾Œå†åŠ ä¸Šä¸€é»é¡è‰²è®ŠåŒ–ï¼Œä¹Ÿè©¦è©¦çœ‹ D3 èˆ‡ visx çš„æ­é…ã€‚</p>\n<p>ä»¥ d3-scale ä¾†è² è²¬é¡è‰²çš„é‹ç®—ï¼Œè®“ visx è² è²¬åœ–è¡¨å…ƒä»¶çš„æ¸²æŸ“ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> scaleSequential <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"d3-scale\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> max <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"d3-array\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> interpolateOrRd <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"d3-scale-chromatic\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ä½¿ç”¨ <code class=\"language-text\">scaleSequential</code> æ­é… <code class=\"language-text\">interpolateOrRd</code> ä¾†å°æ‡‰ä¸åŒ AQI çš„æ•¸å€¼é¡è‰²ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> AQIvalue <span class=\"token operator\">=</span> apiData<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">acc<span class=\"token punctuation\">,</span> prev</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  acc<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> acc<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> colorScale <span class=\"token operator\">=</span> <span class=\"token function\">scaleSequential</span><span class=\"token punctuation\">(</span>interpolateOrRd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">domain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>AQIvalue<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> polygonColor <span class=\"token operator\">=</span> <span class=\"token function\">colorScale</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å¾ä¸Šé¢çš„ç¨‹å¼ç¢¼å¯ä»¥çœ‹å‡ºï¼Œé€™é‚Šæˆ‘å€‘å–®ç´”çš„é‹ç”¨è³‡æ–™èˆ‡ d3 packages é€²è¡Œé‹ç®—ï¼Œç”¢å‡ºçš„é¡è‰²ç›´æ¥ç•¶ä½œ props å‚³å…¥ visx å…ƒä»¶å³å¯å®Œæˆæˆ‘å€‘æƒ³è¦çš„æ•ˆæœï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>animated.polygon</span>\n  <span class=\"token attr-name\">points</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>polygonProps<span class=\"token punctuation\">.</span>points<span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">fill</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>polygonColor<span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">fillOpacity</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">0.3</span><span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">stroke</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>polygonColor<span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">strokeWidth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>å¦‚æ­¤ä¸€ä¾†å°±å¤§åŠŸå‘Šæˆå•¦ï¼å®Œæ•´ç‰ˆç¨‹å¼ç¢¼è«‹åƒè€ƒï¼š</p>\n<iframe src=\"https://codesandbox.io/embed/simpleradar-aqi-with-tooltip-select-data-react-spring-item3?fontsize=14&hidenavigation=1&theme=dark&view=preview\"\n  style=\"width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;\"\n  title=\"SimpleRadar-AQI (with Tooltip + select data)  (react-spring)\"\n  allow=\"accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking\"\n  sandbox=\"allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts\"\n></iframe>\n<h2 id=\"çµè«–\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"çµè«– permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>çµè«–</h2>\n<p>visx çš„ä½¿ç”¨é«”é©—è »å¥½çš„ï¼Œæä¾›åº•å±¤çš„å…ƒä»¶è®“ä½ è‡ªå·±çµ„è£ï¼Œæ­é…ä¸Š d3 æ–¹ä¾¿çš„è³‡æ–™è™•ç†å¥—ä»¶ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç”¨ä¾†å»ºé€ å±¬æ–¼ä½ å€‘è‡ªå·± team å…§çš„ chart libraryã€‚</p>\n<p>é›–ç„¶å·²ç¶“é–‹ç™¼ä¸‰å¹´ï¼Œä½†æ„Ÿè¦ºå¾—å‡ºä¾†é‚„æ˜¯æœ‰ä¸å°‘åŠŸèƒ½éœ€è¦åŠ å…¥æˆ–æ”¹å–„ï¼Œä»–å€‘çš„ maintainer ç›®å‰é‚„ç®—è »ç©æ¥µåœ¨å›æ‡‰ issueï¼Œè‹¥æ˜¯çœ‹åˆ°é€™é‚Šçš„è®€è€…æœ‰èˆˆè¶£ï¼Œæ­¡è¿å»ç©ç©çœ‹ï¼Œç¿»ç¿»ä»–å€‘çš„ç¨‹å¼ç¢¼ï¼Œèªªä¸å®šä¹Ÿæœ‰ä½ èƒ½è²¢ç»çš„åœ°æ–¹ï¼</p>\n<!-- è³‡æ–™ä¾†æº -->\n<h2 id=\"è³‡æ–™ä¾†æº\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"è³‡æ–™ä¾†æº permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>è³‡æ–™ä¾†æº</h2>\n<ol>\n<li><a href=\"https://github.com/airbnb/visx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">visx</a></li>\n<li><a href=\"https://medium.com/airbnb-engineering/introducing-visx-from-airbnb-fd6155ac4658\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Introducing visx from Airbnb</a></li>\n<li><a href=\"https://vis.baidu.com/chartusage/radar/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ECharts æ•¸æ“šå¯è¦–åŒ–å¯¦é©—å®¤</a></li>\n</ol>","id":"c53702ba-6ae8-5070-be74-c3f9a8386736","fields":{"slug":"datavis-visx"},"frontmatter":{"date":"2020-10-10T13:41:40.000Z","title":"ä½¿ç”¨ visx è£½ä½œè³‡æ–™åœ–è¡¨-å°ç£å…­éƒ½å³æ™‚ç©ºæ°£å“è³ªæŒ‡æ¨™","tags":["data visualization","visx","Airbnb","javascript","AQI"],"type":"tech","slug":"datavis-visx"},"timeToRead":14},"type":"tech"}},"staticQueryHashes":["2123680655"]}