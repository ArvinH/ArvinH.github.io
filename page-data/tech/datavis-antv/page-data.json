{"componentChunkName":"component---src-templates-post-tsx","path":"/tech/datavis-antv","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>好歌分享：<a href=\"https://youtu.be/Nm0HTbO5HhM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">四季</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/Nm0HTbO5HhM\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>隨著年齡增長，多少開始會遇到家人或親戚需要長期照護，入住療養院或醫院的狀況，接者就會發現許多照護中心可是一位難求，院中的照服人員或是醫護人員也得以一擋百，讓我很想知道目前台灣整體來說，老年人口、長照機構與照服人員的比例失衡有多嚴重。而剛好在前陣子 <a href=\"https://medium.com/@hulitw\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">@huli</a> 大大介紹了<a href=\"https://blog.techbridge.cc/2018/04/28/antd-and-admin-website/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ant design</a>，讓我再次注意到同樣為螞蟻金服出品的 <a href=\"https://antv.alipay.com/zh-cn/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AntV</a>，稍微研究之下發現它使用起來非常簡單快速，並且一樣有 React、Angular 與 Vue 的版本。所以今天這篇文章想藉由實作台灣老年人口與長照機構供需比的資料圖表，順便介紹 AntV 這套資料視覺化的套件。</p>\n<p>對了，報導者有發表過一系列專輯 - <a href=\"https://www.twreporter.org/topics/nursing-home-truth\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">長照機構裡的大象——10萬老人被照顧的真相</a>，說明台灣長照產業的現況，如果懶得看我長篇大論的技術文章，拜託至少在離開前去看一下報導者的專輯，這樣我也算功德一件，讓更多人知道長照產業的重要性，或許也就有那麼一些人有辦法解決這個鮮少被提起的問題。</p>\n<p>先看個成果：</p>\n<p data-height=\"379\" data-theme-id=\"29194\" data-slug-hash=\"OZxNbO\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"總體台灣老年人口與長照機構供需比 - AntV - demo\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/OZxNbO/\">總體台灣老年人口與長照機構供需比 - AntV - demo</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<!--\n解釋範例內容\n-->\n<p>我依照 <a href=\"https://zh.wikipedia.org/wiki/%E5%8F%B0%E6%B9%BE%E5%9C%B0%E7%90%86%E5%8C%BA%E5%88%92\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Wiki 上的台灣地理區劃分</a>將資料北、中、南、東與外島五個區塊，並加上兩個按鈕，可以把資料量較少的外島去除，用來展示 G2 在處理資料切換時的順暢感。</p>\n<p>看得出來其實就是個非常簡單用 Excel 也畫得出來的分組長條圖，但實際上你會發現，透過 AntV 製作完全不會比用 Excel 麻煩，還支援 RWD 與資料的切換動畫！真的非常適合我這次想要快速拉出一個比較圖表的狀況！</p>\n<h1 id=\"antv\" style=\"position:relative;\"><a href=\"#antv\" aria-label=\"antv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AntV</h1>\n<p><img src=\"/image/antv-cover.png\" alt=\"AntV 官網\"></p>\n<p>AntV 其實包含了三個不同應用情境的套件：G2、G6、F2。</p>\n<ol>\n<li>G2: 包含各種圖表元素的集成，大多數的應用場景都可以從 G2 中找到對應合適的元件。</li>\n<li>G6: 主要是針對流程圖與關聯性分析的圖表元件，甚至能利用 G2 繪製資料庫的 ER Diagram 與時序圖。</li>\n<li>F2: 針對 Mobile 的使用情境來特別加強圖表在 performance 上的表現，主要繪製在 <code class=\"language-text\">canvas</code> 上。</li>\n</ol>\n<h2 id=\"今天我們使用-g2-來開發\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%A4%A9%E6%88%91%E5%80%91%E4%BD%BF%E7%94%A8-g2-%E4%BE%86%E9%96%8B%E7%99%BC\" aria-label=\"今天我們使用 g2 來開發 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今天我們使用 G2 來開發</h2>\n<p>這幾套由螞蟻金服開發的視覺化套件，除了遵照 Antd 的設計語言外，針對圖表的設計製作上，深受 <a href=\"https://www.amazon.com/Grammar-Graphics-Statistics-Computing/dp/0387245448\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">The Grammar of Graphics</a> 這本巨作的影響，也是 G2 的名稱的由來。</p>\n<blockquote>\n<p>G2 的強大是由其背後的一套圖形語法所支撐的，它基於《The Grammar of Graphics》(Leland Wilkinson 著)一書，是一套用來描述所有統計圖形深層特性的語法規則，該語法回答了『什麼是統計圖形』這一問題，以自底向上的方式組織最基本的元素形成更高級的元素。由此，G2 所建構出的圖表是由一系列獨立的圖形語法元素組合而成的 -- <a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/the-grammar-of-graphics.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AntV G2 官網</a></p>\n</blockquote>\n<p>我並沒有看過那本書，也沒有仔細研究 G2 的原始碼，但這敘述聽起來就超厲害的，整個工具是建構在一套完整的理論基礎上頭。</p>\n<p>在 G2 的世界中，並沒有明確定義一般的圖表類型，像是長條圖、折線圖等等，是依照一系列的圖形語法元素組合成的結果來決定其類型。</p>\n<p>所謂的圖形語法元素大概就是包含：</p>\n<ul>\n<li><strong>DataSet 資料集操作</strong></li>\n<li><strong>Scale 度量</strong></li>\n<li><strong>Geom 幾何標記（point, line, area, shape, etc）</strong></li>\n<li><strong>Attr 圖形屬性</strong></li>\n<li><strong>Coord 座標系</strong></li>\n<li><strong>Axis 座標軸</strong></li>\n<li><strong>Legend 圖例</strong></li>\n<li><strong>Tooltip 提示訊息</strong></li>\n<li><strong>Guide 輔助元素</strong></li>\n<li><strong>Facet 分面 （將一份資料按照某個維度分隔成若干子集）</strong></li>\n<li><strong>Label 標籤</strong></li>\n<li><strong>Theme 主題</strong></li>\n<li><strong>Event 圖表事件</strong></li>\n</ul>\n<p>在<a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文件上</a>上針對不同的元素都有非常詳細的說明與範例，而且都有中文文件（雖然是簡體...），是 AntV 的絕大優點之一。</p>\n<p>透過操作這些不同元素的組合，可以很容易的切換圖表類型，以 <strong>Coord</strong> 為例：</p>\n<p><code class=\"language-text\">chart.coord('coordType'[, cfg]);</code></p>\n<p>在同樣的資料集上，透過上述的方式來轉換座標軸，馬上就可以從層疊長條圖切換為圓餅圖：</p>\n<p><img src=\"/image/g2_coord.png\" alt=\"Different coord on same chart\"> <a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/coord.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">圖片來源</a></p>\n<p>或是透過自定義 <code class=\"language-text\">Shape</code>，快速將一般的長條圖，改變成三角形的形狀：</p>\n<p data-height=\"458\" data-theme-id=\"29194\" data-slug-hash=\"deVMmN\" data-default-tab=\"js,result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"AntV-G2-demo\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/deVMmN/\">AntV-G2-demo</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>由於這樣的設計理念與基礎，G2 比起其他一樣提供較為高階視覺化語法的套件來說，彈性大了不少。</p>\n<h2 id=\"開始進行實作視覺化總要有個方向走我們先從資料搜集開始\" style=\"position:relative;\"><a href=\"#%E9%96%8B%E5%A7%8B%E9%80%B2%E8%A1%8C%E5%AF%A6%E4%BD%9C%E8%A6%96%E8%A6%BA%E5%8C%96%E7%B8%BD%E8%A6%81%E6%9C%89%E5%80%8B%E6%96%B9%E5%90%91%E8%B5%B0%E6%88%91%E5%80%91%E5%85%88%E5%BE%9E%E8%B3%87%E6%96%99%E6%90%9C%E9%9B%86%E9%96%8B%E5%A7%8B\" aria-label=\"開始進行實作視覺化總要有個方向走我們先從資料搜集開始 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>開始進行實作，視覺化總要有個方向，走，我們先從資料搜集開始！</h2>\n<p>首先，要想知道老年人口以及長照機構的比例，我們需要找到依照年齡分組的人口統計資料，這可以從<a href=\"https://www.ris.gov.tw/346\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">內政部的人口資料庫</a>中找到「年底人口數按性別及五歲年齡組分」的資料表，從民國 35 年到 106 年都有，算是蠻齊全的。我們選取 85 ~ 100+ 以上的資料當作老年人口。</p>\n<p>2017 年的部分計算出來後大約是：368,757 人</p>\n<p><img src=\"/image/age_population.png\" alt=\"年底人口數按性別及五歲年齡組分\"></p>\n<p>接著，到<a href=\"https://dep.mohw.gov.tw/DOS/lp-3550-113-xCat-T02.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">衛福部統計處</a>找尋長期照顧機構的相關資料。</p>\n<p>可以找到 2017 年長照與安養機構總數的可供進住人數，大約 57,147 人：</p>\n<p><img src=\"/image/number_of_nursy_building.png\" alt=\"長照與安養機構總數的可供進住人數\"></p>\n<p>以及 2017 年老人長期照顧、安養機構工作人員人數，大約 19,064 人（只計算護理人員與照顧服務人員）：</p>\n<p><img src=\"/image/number_of_workers.png\" alt=\"老人長期照顧、安養機構工作人員人數\"></p>\n<p>上述的資料來源都有個別縣市的統計資料，上面數字是我將各縣市加總的結果，可能多少會有誤差，大家別介意啊...整體比例應該不會差太多。</p>\n<h2 id=\"接著使用-g2-來進行視覺化\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E8%91%97%E4%BD%BF%E7%94%A8-g2-%E4%BE%86%E9%80%B2%E8%A1%8C%E8%A6%96%E8%A6%BA%E5%8C%96\" aria-label=\"接著使用 g2 來進行視覺化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接著使用 G2 來進行視覺化</h2>\n<p>要使用 G2 很簡單，只要在 HTML 中載入 <code class=\"language-text\">&lt;script src=\"https://gw.alipayobjects.com/os/antv/assets/g2/3.0.9/g2.min.js\">&lt;/script></code> 即可。</p>\n<p>接著將剛剛的資料定義好：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> SimpleAll <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'可供進住人數'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">57147</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'長照、養護人員'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">19064</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'老年人口數(85~100+)'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">368757</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>我們就可以透過 <code class=\"language-text\">G2.Chart</code> 來定義圖表：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> chart <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">G2<span class=\"token punctuation\">.</span>Chart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  container<span class=\"token operator\">:</span> <span class=\"token string\">'mountNode'</span><span class=\"token punctuation\">,</span>\n  forceFit<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  height<span class=\"token operator\">:</span> window<span class=\"token punctuation\">.</span>innerHeight\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>我們 new 一個 <code class=\"language-text\">G2.Chart</code> 的 instance，並且同時傳入三個參數給予建構：</p>\n<ul>\n<li>container: 指定你的圖表要掛載在 DOM 中的哪個位置，對應於 HTML 中元素的 id 值。</li>\n<li>forceFit: 超方便的參數，只要設定為 true，你的圖表就能 Responsive，因此也不用再設定寬度。</li>\n<li>height: 可以額外定義需要的圖表高度。</li>\n</ul>\n<p>再來我們把資料與圖表做綁定：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  chart<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>SimpleAll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>接著便能開始設定我們的圖表長相：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">chart\n  <span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name*value'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">adjust</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">'dodge'</span><span class=\"token punctuation\">,</span>\n    marginRatio<span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>先前說過，G2 中沒有區分圖表類型，利用的是各種不同的<strong>幾何標記</strong>來組成圖表，如果要製作長條圖，需要用到的就是 <code class=\"language-text\">ìnterval()</code> 這個幾何標記，G2 還支援：<code class=\"language-text\">point()</code>, <code class=\"language-text\">path()</code>, <code class=\"language-text\">line()</code>, <code class=\"language-text\">area()</code>, <code class=\"language-text\">polygon()</code>, <code class=\"language-text\">edge()</code>, <code class=\"language-text\">schema()</code>, <code class=\"language-text\">heatmap()</code> 這幾種類型，<a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/geom.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官網有更詳細的介紹</a></p>\n<p>宣告我們需要的幾何圖形後，接著就會想知道我們要怎麼將資料映射到對的位置，並且給予不同的顏色區別。</p>\n<p>而這一切在 G2 中都非常的簡單直覺。</p>\n<p>透過 <code class=\"language-text\">position('name*value')</code> 這個 API，我們指定資料欄位的 <code class=\"language-text\">name</code> 要對應到圖表座標軸上的 <code class=\"language-text\">x</code>，而 <code class=\"language-text\">value</code> 對應到 <code class=\"language-text\">y</code>，到這邊為止，我們就能畫出一個擁有完整資訊的圖表：</p>\n<img src=\"/image/g2-simple-bar.png\" width=\"500\" height=\"300\">\n<p>當然這樣還不夠，至少也要用顏色來區別一下不同的資料類別。利用 <code class=\"language-text\">color(name)</code> 來告訴 G2，我們要根據資料的 <code class=\"language-text\">name</code> 欄位，用不同的顏色來區分。</p>\n<img src=\"/image/g2-simple-bar-color.png\" width=\"500\" height=\"300\">\n<p>G2 的 API 通常都能接收一個以上的參數，以 color 為例，除了直接傳入顏色要對應的資料欄位外，也可以直接輸入某個顏色，讓他 apply 到整個圖表；或是傳入 callback，在 callback 中根據欄位數值做邏輯上的著色動作。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 可以參考官網 API Doc https://antv.alipay.com/zh-cn/g2/3.x/api/geom.html#_color</span>\n\nchart<span class=\"token punctuation\">.</span><span class=\"token function\">point</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x*y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使用默認的顏色</span>\nchart<span class=\"token punctuation\">.</span><span class=\"token function\">point</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x*y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">'red'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'blue'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使用傳入的指定顏色</span>\nchart<span class=\"token punctuation\">.</span><span class=\"token function\">point</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x*y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'red'</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token string\">'blue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"接著我們還可以加點東西讓圖表活潑一點\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E8%91%97%E6%88%91%E5%80%91%E9%82%84%E5%8F%AF%E4%BB%A5%E5%8A%A0%E9%BB%9E%E6%9D%B1%E8%A5%BF%E8%AE%93%E5%9C%96%E8%A1%A8%E6%B4%BB%E6%BD%91%E4%B8%80%E9%BB%9E\" aria-label=\"接著我們還可以加點東西讓圖表活潑一點 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接著我們還可以加點東西讓圖表活潑一點。</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">chart<span class=\"token punctuation\">.</span><span class=\"token function\">point</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">shape</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'image'</span><span class=\"token punctuation\">,</span> imageMap<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>我們在原本的 <code class=\"language-text\">interval</code> 幾何圖形上加上另一個幾何圖形 <code class=\"language-text\">point</code>，位置一樣將 <code class=\"language-text\">(name, value)</code> 映射到 <code class=\"language-text\">(x, y)</code>。</p>\n<p>相信眼尖的你會發現，<code class=\"language-text\">position</code> 的參數除了一開始的 <code class=\"language-text\">(name*value)</code> 外，也可以傳遞 array 形式。</p>\n<p>接著設定 size 為 50；在幾何圖形 <code class=\"language-text\">point</code> 中，size 代表原點的半徑，如果是 <code class=\"language-text\">interval</code> 則代表柱體寬度，<code class=\"language-text\">line</code> 則是線段寬度。</p>\n<p>還有個特殊的 <code class=\"language-text\">shape()</code> 函式，他讓我們可以指定特定資料欄位（在這邊我們用 <code class=\"language-text\">name</code>），將其轉換成不同的型態，像是這邊我們就把單純的 <code class=\"language-text\">point</code> mapping 成圖片，而這一切只要透過一個 callback 函數，回傳對應的結果即可！</p>\n<p data-height=\"518\" data-theme-id=\"29194\" data-slug-hash=\"jxZGPV\" data-default-tab=\"js,result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"2017 台灣總體老年人口與長照機構供需比 - AntV - demo\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/jxZGPV/\">2017 台灣總體老年人口與長照機構供需比 - AntV - demo</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>短短幾行 code 就作出一個比一般 Excel 還要特別一些的圖表，真的蠻方便使用的對吧！</p>\n<h2 id=\"但只看全台灣總體的資料好像不太夠啊能不能看一下各縣市的呢\" style=\"position:relative;\"><a href=\"#%E4%BD%86%E5%8F%AA%E7%9C%8B%E5%85%A8%E5%8F%B0%E7%81%A3%E7%B8%BD%E9%AB%94%E7%9A%84%E8%B3%87%E6%96%99%E5%A5%BD%E5%83%8F%E4%B8%8D%E5%A4%AA%E5%A4%A0%E5%95%8A%E8%83%BD%E4%B8%8D%E8%83%BD%E7%9C%8B%E4%B8%80%E4%B8%8B%E5%90%84%E7%B8%A3%E5%B8%82%E7%9A%84%E5%91%A2\" aria-label=\"但只看全台灣總體的資料好像不太夠啊能不能看一下各縣市的呢 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>但只看全台灣總體的資料好像不太夠啊，能不能看一下各縣市的呢？</h2>\n<p>當然可以。</p>\n<p>只是每個縣市如果都要放三根長方體好像太密集了點，不是很適合，所以如同最前面的成品圖，將資料北、中、南、東與外島五個區塊，這樣圖表會比較清晰一點。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'可供進住人數'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'北部'</span><span class=\"token operator\">:</span> <span class=\"token number\">25499</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'中部'</span><span class=\"token operator\">:</span> <span class=\"token number\">11027</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'南部'</span><span class=\"token operator\">:</span> <span class=\"token number\">18684</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'東部'</span><span class=\"token operator\">:</span> <span class=\"token number\">1609</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'外島'</span><span class=\"token operator\">:</span> <span class=\"token number\">328</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'長照、養護人員'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'北部'</span><span class=\"token operator\">:</span> <span class=\"token number\">8994</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'中部'</span><span class=\"token operator\">:</span> <span class=\"token number\">3518</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'南部'</span><span class=\"token operator\">:</span> <span class=\"token number\">5997</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'東部'</span><span class=\"token operator\">:</span> <span class=\"token number\">482</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'外島'</span><span class=\"token operator\">:</span> <span class=\"token number\">73</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'老年人口數(85~100+)'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'北部'</span><span class=\"token operator\">:</span> <span class=\"token number\">162443</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'中部'</span><span class=\"token operator\">:</span> <span class=\"token number\">92071</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'南部'</span><span class=\"token operator\">:</span> <span class=\"token number\">101846</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'東部'</span><span class=\"token operator\">:</span> <span class=\"token number\">10197</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'外島'</span><span class=\"token operator\">:</span> <span class=\"token number\">2200</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"dataset\" style=\"position:relative;\"><a href=\"#dataset\" aria-label=\"dataset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DataSet</h3>\n<p>要想在同一圖表中呈現多組長條圖，我們需引進 G2 中 <code class=\"language-text\">DataSet</code> 的這個概念。</p>\n<p><img src=\"/image/antv-g2-data-set-structure.svg\" alt=\"DataSet 架構圖（取自官網）\">\n<a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/data-set.html#\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官網介紹</a></p>\n<p>這張圖看似複雜，但其實很清楚的介紹了 <code class=\"language-text\">DataSet</code> 在使用 G2 製圖的過程中所扮演的角色：操作資料。</p>\n<p>資料可以經由 <code class=\"language-text\">Connector</code> 傳入 <code class=\"language-text\">DataSet</code> 中，接著利用 <code class=\"language-text\">Transforms</code> 針對數據做處理（排序、統計、資料補齊），最後渲染到 <code class=\"language-text\">DataView</code> 中。</p>\n<p>突然看到一堆名詞感覺有點嚇人？別擔心，待會的範例會慢慢講解，只要先把 <code class=\"language-text\">DataSet</code> 想成是存放資料的資料集，而 <code class=\"language-text\">DataView</code> 就是我們要繪製出來的資料視圖。</p>\n<p>另外，一份 <code class=\"language-text\">DataSet</code> 可以連接多個 <code class=\"language-text\">DataView</code>，並透過更動其中的共用 <code class=\"language-text\">State</code> 來進行連動變更，在我們的範例中沒有使用到，但可以參考<a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/data-set.html#_%E5%9B%BE%E8%A1%A8%E8%81%94%E5%8A%A8%E7%A4%BA%E4%BE%8B\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官網的清楚範例</a></p>\n<p><img src=\"/image/antv2-g2-dataset-state.gif\" alt=\"官網範例示圖\"></p>\n<h3 id=\"回到我們的範例來\" style=\"position:relative;\"><a href=\"#%E5%9B%9E%E5%88%B0%E6%88%91%E5%80%91%E7%9A%84%E7%AF%84%E4%BE%8B%E4%BE%86\" aria-label=\"回到我們的範例來 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>回到我們的範例來</h3>\n<p>跟剛剛的範例不同，我們在進行資料綁定前（<code class=\"language-text\">chart.source(data)</code>），需要先對數據做一些操作，所以要利用 <code class=\"language-text\">DataSet</code> 與 <code class=\"language-text\">transform</code> 兩個 API：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> ds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> dv <span class=\"token operator\">=</span> ds<span class=\"token punctuation\">.</span><span class=\"token function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndv<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'fold'</span><span class=\"token punctuation\">,</span>\n  fields<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">'北部'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'中部'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'南部'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'東部'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'外島'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 展開資料</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'區域'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// key, 設置新的 key/value 值，來對應新數據的含義。</span>\n  value<span class=\"token operator\">:</span> <span class=\"token string\">'區域人數'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// value</span>\n  retains<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">'name'</span> <span class=\"token punctuation\">]</span> <span class=\"token comment\">// 想要保留在 transform 後的資料欄位</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nchart<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>dv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>透過 <code class=\"language-text\">new DataSet()</code> 與 <code class=\"language-text\">createView()</code> 創建出一個擁有 <strong>資料集 &#x3C;-> 資料狀態連接 &#x3C;-> 資料視圖</strong> 關聯性的物件 <code class=\"language-text\">dv</code>，接著利用 <code class=\"language-text\">transform()</code> 函數針對資料進行處理。</p>\n<p>我們的資料是根據 <code class=\"language-text\">可供進住人數'</code>、<code class=\"language-text\">長照、養護人員</code> 與 <code class=\"language-text\">老年人口數</code>來分類，但我們實際上希望的是能夠先依照區域劃分，在每個區域中再分別用這三種類別來比較資料。</p>\n<p>因此在傳入 <code class=\"language-text\">transform</code> 的 option 中，我們選定 <code class=\"language-text\">type</code> 為 <code class=\"language-text\">fold</code>，其意義為：<strong>以指定字段集作為 Key，展開數據。</strong>並且設置新的 key/value 值，來對應新數據的含義。</p>\n<p>直接拿我們的資料來作為例子，比較一下前後結果就會很清楚了：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 原始資料</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">'可供進住人數'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'北部'</span><span class=\"token operator\">:</span> <span class=\"token number\">25499</span><span class=\"token punctuation\">,</span><span class=\"token string\">'中部'</span><span class=\"token operator\">:</span> <span class=\"token number\">11027</span><span class=\"token punctuation\">,</span><span class=\"token string\">'南部'</span><span class=\"token operator\">:</span> <span class=\"token number\">18684</span><span class=\"token punctuation\">,</span><span class=\"token string\">'東部'</span><span class=\"token operator\">:</span> <span class=\"token number\">1609</span><span class=\"token punctuation\">,</span><span class=\"token string\">'外島'</span><span class=\"token operator\">:</span> <span class=\"token number\">328</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">'長照、養護人員'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'北部'</span><span class=\"token operator\">:</span> <span class=\"token number\">8994</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'中部'</span><span class=\"token operator\">:</span> <span class=\"token number\">3518</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'南部'</span><span class=\"token operator\">:</span> <span class=\"token number\">5997</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'東部'</span><span class=\"token operator\">:</span> <span class=\"token number\">482</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'外島'</span><span class=\"token operator\">:</span> <span class=\"token number\">73</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 經過 transform 後</span>\n\n<span class=\"token keyword\">const</span> dataBeenTransformed <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'北部'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">25499</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'可供進住人數'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'北部'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">8994</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'長照、養護人員'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'中部'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">11027</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'可供進住人數'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'中部'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">3518</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'長照、養護人員'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 基本上，transform 後，原有的資料欄位會不見，這邊的 `name` 還保留是因為我有加入 `retains: [ 'name' ]` 這個選項。</span></code></pre></div>\n<p>如此一來，我們在繪製圖表的時候，他就會依照目前的 Key, 將相同的 Key 所對應的值 Group 在一起，讓<code class=\"language-text\">北部</code>這個 Key 對應的三個欄位數值（可供進住人數、長照人員數、老年人口數）一起在同個分類（北部）中顯示。</p>\n<p>不過，還沒有結束。</p>\n<p>將資料分組後，依照先前的繪製方式，會畫出下面這樣的結果：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">chart<span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token string\">'區域*區域人數'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<img src=\"/image/antv2-g2-multiple-set.png\" width=\"500\" height=\"300\">\n<p>雖然分組了，但資料重疊在一起了...囧</p>\n<p>這是因為每個分組中的每個數據都套用到了同樣的 position 設定（區域*區域人數），我們必須要調整一下！</p>\n<p>透過 <code class=\"language-text\">adjust()</code> 函數可以方便做到：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token function\">adjust</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'dodge'</span><span class=\"token punctuation\">,</span>\n  marginRatio<span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>設定 type 為 <code class=\"language-text\">dodge</code>，代表我們要調整的是分組數據，然後給予 margin 比例為 1/5。</p>\n<p data-height=\"297\" data-theme-id=\"29194\" data-slug-hash=\"JvZWQE\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"2017 台灣老年人口與長照機構供需比 - AntV - demo1\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/JvZWQE/\">2017 台灣老年人口與長照機構供需比 - AntV - demo1</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>看起來就正常多了！</p>\n<p>關於 <code class=\"language-text\">transform</code> 的運用，可以參考官方詳解 - <a href=\"https://antv.alipay.com/zh-cn/g2/3.x/api/transform.html#\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Transform</a>\n關於 <code class=\"language-text\">adjust</code> 的運用，目前<a href=\"https://antv.alipay.com/zh-cn/g2/3.x/api/geom.html#_adjust\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">支援四種 type</a>：<code class=\"language-text\">stack</code>, <code class=\"language-text\">dodge</code>, <code class=\"language-text\">jitter</code>, <code class=\"language-text\">symmetric</code>。</p>\n<p>神奇的是，這些不同類型的差異，在擁有豐富文檔的官方網站竟然找不到介紹，所以我其實也不太懂。重點是，不同的資料型態會有各自適合的 type，大家在製作時要記得都嘗試看看效果。</p>\n<h3 id=\"看起來蠻完整的了但圖表沒辦法動態變化怎麼可以\" style=\"position:relative;\"><a href=\"#%E7%9C%8B%E8%B5%B7%E4%BE%86%E8%A0%BB%E5%AE%8C%E6%95%B4%E7%9A%84%E4%BA%86%E4%BD%86%E5%9C%96%E8%A1%A8%E6%B2%92%E8%BE%A6%E6%B3%95%E5%8B%95%E6%85%8B%E8%AE%8A%E5%8C%96%E6%80%8E%E9%BA%BC%E5%8F%AF%E4%BB%A5\" aria-label=\"看起來蠻完整的了但圖表沒辦法動態變化怎麼可以 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>看起來蠻完整的了，但圖表沒辦法動態變化怎麼可以！</h3>\n<p>沒錯，我也覺得不可以。</p>\n<p>還好 AntV G2 讓我們輕鬆利用 <code class=\"language-text\">chart.changeData()</code> 就能同時更新 <code class=\"language-text\">DataSet</code> 與 <code class=\"language-text\">DataView</code>。更棒的是，除了提供 RWD 設計外，資料轉換過程中的動畫他也幫你照顧好好的。</p>\n<p>除此之外，我們也能夠直接操作原有的 <code class=\"language-text\">DataSet</code>，像開頭的範例一樣，點選 button 時，我們透過 <code class=\"language-text\">chart.filter</code> 來過濾原有資料，並且在最後呼叫 <code class=\"language-text\">chart.repaint()</code> 進行 <code class=\"language-text\">DataView</code> 的重繪（一定要重繪才會 trigger <code class=\"language-text\">DataSet</code> 與 <code class=\"language-text\">DataView</code> 間的連動）：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">changeData</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  chart<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'區域'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">val</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'all'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      chart<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span><span class=\"token string\">'區域人數'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        minLimit<span class=\"token operator\">:</span> <span class=\"token number\">73</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    chart<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span><span class=\"token string\">'區域人數'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      minLimit<span class=\"token operator\">:</span> <span class=\"token number\">400</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> val <span class=\"token operator\">!==</span> <span class=\"token string\">'外島'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  chart<span class=\"token punctuation\">.</span><span class=\"token function\">repaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如此一來就能完成開頭的範例啦！</p>\n<p data-height=\"379\" data-theme-id=\"29194\" data-slug-hash=\"OZxNbO\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"總體台灣老年人口與長照機構供需比 - AntV - demo\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/OZxNbO/\">總體台灣老年人口與長照機構供需比 - AntV - demo</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>如同我在前言提及的<a href=\"(https://www.twreporter.org/topics/nursing-home-truth)\">報導者專輯</a>中所呈現的，台灣的長照產業正面臨很大的困境，只要家中有人有這種需求，相信都能有很深的體會。先前也曾有學長以長照產業為創業題目，可惜最終黯然收場，可見這問題真的有其嚴重與困難性存在。</p>\n<p>身為前端開發者，或許目前能做的最大貢獻就是盡量製作出許多一目了然的資訊圖表、網頁專輯，讓更多的人知道問題的嚴重性，透過 AntV G2 這樣的工具，製作互動式圖表真的是越來越方便與容易，希望大家能多加貢獻，讓台灣社會往更好的方向走去！而小魯我能力不足分身乏術...先下台一鞠躬...</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://antv.alipay.com/zh-cn/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AntV</a></li>\n<li><a href=\"https://antv.alipay.com/zh-cn/g2/3.x/tutorial/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">G2</a></li>\n<li><a href=\"https://www.ris.gov.tw/346\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">內政部戶政司人口資料庫</a></li>\n<li><a href=\"https://www.gender.ey.gov.tw/gecdb/Stat_Statistics_DetailData.aspx?sn=%2BwEzRrF1jtJ82VtOVizhxw%3D%3D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">行政院性別平等統計資料庫</a></li>\n<li><a href=\"https://dep.mohw.gov.tw/DOS/lp-3550-113-xCat-T02.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">衛福部統計處-長期照顧統計</a></li>\n<li><a href=\"https://www.twreporter.org/topics/nursing-home-truth\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">長照機構裡的大象——10萬老人被照顧的真相</a></li>\n<li>Icon made by Freepik from www.flaticon.com</li>\n</ol>","fields":{"slug":"datavis-antv"},"frontmatter":{"title":"使用 AntV 製作資料圖表-台灣老年人口與長照機構供需比","date":"05-05-2018","tags":["data visualization","AntV","G2","RWD","javascript"]},"timeToRead":17}},"pageContext":{"slug":"datavis-antv","prev":{"excerpt":"\"The cure for fate is patience.\"","html":"<blockquote>\n<p>\"The cure for fate is patience.\"</p>\n</blockquote>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>上一篇<a href=\"https://blog.techbridge.cc/2018/03/10/deeplearnjs-simple-linear-regression/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文章</a>中，我們利用 Deeplearn.js 學習了 linear regression，從氣溫與紅茶的關聯性中預測銷量，這次就來練習在機器學習中另一個很基本的方法 - Logistic regression（邏輯分析）。</p>\n<p>先來張 Demo 成果圖：</p>\n<p><img src=\"/image/deeplearnjs-logistic.png\" alt=\"Demo\"> </p>\n<p>從成果圖中可以看出，所謂的 Logistic regression 與 Linear regression 最大不同就是，邏輯回歸大多用來進行<strong>分類</strong>，當結果只有兩種時，就是二元分類，當然也有多元分類，這邊以簡單二元分類來做練習。這次的範例參考自 <a href=\"https://blog.csdn.net/ns2250225/article/details/79416651\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">【webAI】deeplearn.js的邏輯回歸</a></p>\n<h2 id=\"出發總要有個方向做實驗總要有個想像\" style=\"position:relative;\"><a href=\"#%E5%87%BA%E7%99%BC%E7%B8%BD%E8%A6%81%E6%9C%89%E5%80%8B%E6%96%B9%E5%90%91%E5%81%9A%E5%AF%A6%E9%A9%97%E7%B8%BD%E8%A6%81%E6%9C%89%E5%80%8B%E6%83%B3%E5%83%8F\" aria-label=\"出發總要有個方向做實驗總要有個想像 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>出發總要有個方向，做實驗總要有個想像</h2>\n<p>還記得小時候剛了解智商的概念時，很喜歡去查查名人們的智商數字，像是愛因斯坦、前美國總統布希等等，想看看這些名人的智商是多少，是不是真的很聰明才能像他們這樣成功。\n今天假設我們有一群人的智商資料，現在想要利用這些資料分割出聰明人與笨蛋兩個分類，讓我們之後可以用來判斷一個人是聰明的率高一些，或是愚昧機率高一點，那我們該怎麼做呢？</p>\n<p>這時候就可以出動 Logistic regression 來幫我們計算出一個預測模型，用來判斷該人的智商屬於哪個分類的機率比較高。</p>\n<p>以迴歸分析來說，我們是希望能由給定一個固定的解釋變數 X，然後求出目標變數 Y 的平均值，是條件期望值的概念，若 Y 的結果是連續性的，我們就能試著透過線性模型去逼近一個剛好符合所有資料的公式。像是上一次的範例中，我們可以用線性模型求出在各種溫度下，紅茶的銷售狀況大約會是多少。</p>\n<p>但有些時候，想求得的目標變數是二元或是多元的變數，像是剛剛例子中的<strong>聰明</strong> 或 <strong>笨蛋</strong>。如果硬要用線性函數去逼近的話，求得的結果通常會很差，像是下圖這般：</p>\n<p><img src=\"/image/logistic-linear-bad.png\" alt=\"linear regression\">\n(<a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">圖片來源</a>)</p>\n<p>所以才有人提出用 <a href=\"https://en.wikipedia.org/wiki/Sigmoid_function\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">sigmoid</code></a> 這個能將數值侷限在 0 與 1 之間的函數來解決這個問題：</p>\n<p><img src=\"/image/deeplearnjs-decision-boundary.png\" alt=\"Decision Boundary\"></p>\n<p>上圖就是一個 <code class=\"language-text\">sigmoid function</code>，假設我們今天判斷智商 180 代表機率 1 的狀況，而大於機率 0.6 時，就可以算是聰明人（黃色區域），而小於 0.6 的則屬於笨蛋（綠色區域），那今天我們的目標就是要找出一個 <code class=\"language-text\">Ｘ</code> 軸上的 <code class=\"language-text\">Z</code> 值，讓我們能根據 input 的 <code class=\"language-text\">X</code> 特徵值來判斷，若是 <code class=\"language-text\">X</code> 大於 <code class=\"language-text\">Z</code> 時，就可說他是聰明人（因為機率高於 0.6）。</p>\n<p>這個讓我們找出 <code class=\"language-text\">Z</code> 值的函數就是我們要找的 <code class=\"language-text\">Decision Boundary</code>，也就是開頭 Demo 圖中的那條黃色線段！</p>\n<p>有關於 Logistion regression 與 Decision Boundary 的詳細內容，我推薦大家閱讀這幾篇 blog，介紹得很簡單易懂：</p>\n<p><a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Machine Learning 學習日記</a>\n<a href=\"https://taweihuang.hpd.io/2017/12/22/logreg101/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">你可能不知道的邏輯迴歸</a></p>\n<h2 id=\"大概了解-logistic-後那就來利用-deeplearnjs-找出-decision-boundary-吧\" style=\"position:relative;\"><a href=\"#%E5%A4%A7%E6%A6%82%E4%BA%86%E8%A7%A3-logistic-%E5%BE%8C%E9%82%A3%E5%B0%B1%E4%BE%86%E5%88%A9%E7%94%A8-deeplearnjs-%E6%89%BE%E5%87%BA-decision-boundary-%E5%90%A7\" aria-label=\"大概了解 logistic 後那就來利用 deeplearnjs 找出 decision boundary 吧 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>大概了解 Logistic 後，那就來利用 deeplearn.js 找出 Decision Boundary 吧!</h2>\n<p>起手式，先來製作個假資料：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 建立假資料，1 代表智商 100 分以上，0 代表智商 100 分以下</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">200</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> tmpX1 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> tmpX2 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n    data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        x<span class=\"token operator\">:</span> tmpX1<span class=\"token punctuation\">,</span>\n        y<span class=\"token operator\">:</span> tmpX2<span class=\"token punctuation\">,</span>\n        c<span class=\"token operator\">:</span> tmpX1 <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> tmpX2 <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我們隨機產生 200 組 training data，<code class=\"language-text\">tmp_x</code> 與 <code class=\"language-text\">tmp_y</code> 可以當作我們要輸入的 Input 特徵 X 向量，代表一個人的智商以及他閱讀的書籍量。</p>\n<p>接著初始 deeplearn.js 的資料結構：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**\n * deeplearn.js 運算\n */</span>\n<span class=\"token keyword\">const</span> x_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> y_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> elem <span class=\"token keyword\">of</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    x_list<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    y_list<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> x_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor2d</span><span class=\"token punctuation\">(</span>x_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> y_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor2d</span><span class=\"token punctuation\">(</span>y_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>再次介紹一下，在 deeplearn.js 中，tensor 是最核心的資料結構，用來表示向量、矩陣或是多維度的資料。</p>\n<p>有許多 utility function 可以輔助創建 tensor 資料結構，像是這邊用的是 <code class=\"language-text\">tensor2d</code>，也就是 2D (2-dimension) 的 tensor。</p>\n<p>一個 tensor 其實包含三個成分，也是創建 tensor 時可以傳入的參數：</p>\n<ul>\n<li>values (TypedArray|Array): tensor 的值。可以是 nested array 或 flat array 的結構。</li>\n<li>shape（number[]）:基本上就是該 tensor 的維度。若創建 tensor 時沒有指定維度，就會繼承傳入的 values 維度。也可以像這邊的範例一樣直接使用 <code class=\"language-text\">tensor${1|2|3|4}d</code> 來創建</li>\n<li>dtype（float32'|'int32'|'bool）：值的型別，當然是 optional。</li>\n</ul>\n<p>由於我們要計算的 X 都是一組向量，所以這邊使用 <code class=\"language-text\">dl.tensor2d</code> 來建置一個二維的 tensor。</p>\n<p>接著定義我們要 training 的係數，這邊取為 <code class=\"language-text\">W</code> 與 <code class=\"language-text\">B</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 權重 W 與偏差 B</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">W</span> <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">zeros</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">B</span> <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">zeros</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dl.variable(initialValue, trainable?, name?, dtype?)</code> 用來創建 training 過程中需要的變數，也可透過參數指定該變數能否在 training 過程中被修改（trainable），預設是 <code class=\"language-text\">true</code>。</p>\n<p>用 <code class=\"language-text\">dl.zeros([1, 2])</code> 來創建一個 <code class=\"language-text\">Shape</code> 為 <code class=\"language-text\">[1,2]</code> 的填滿零值的 tensor 變數當權重 W，以及維度 1 的偏差變數 tensor B。</p>\n<p>再來需要定義目標函數與 loss function：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 定義目標函數 與 loss function （最一般的 mean square）</span>\n<span class=\"token comment\">// logistic regression 模型</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">f</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">x</span> <span class=\"token operator\">=></span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">sigmoid</span><span class=\"token punctuation\">(</span><span class=\"token constant\">W</span><span class=\"token punctuation\">.</span><span class=\"token function\">matMul</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span><span class=\"token function\">transpose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// loss function（log loss）</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loss</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pred<span class=\"token punctuation\">,</span> label</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">mean</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">neg</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">,</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>目標函數的部分其實就是帶入先前所提的 sigmoid function：</p>\n<p><img src=\"/image/deeplearnjs-sigmod.png\" alt=\"目標函數公式\"></p>\n<p><code class=\"language-text\">Z</code> 就是我們要找的 boundary，就是權重與 input X 向量做矩陣乘法，所以這裡需要轉置矩陣 <code class=\"language-text\">x.transpose()</code>。\n<code class=\"language-text\">dl.sigmoid()</code> 就是 deeplearn.js 提供的 sigmoid 函數（如上圖第二行）</p>\n<p>將 <code class=\"language-text\">Z</code> 帶入 <code class=\"language-text\">dl.sigmoid()</code> 後就獲得了目標函數 f。</p>\n<p>而 loss function 的話，一般在 logistic function 都是採用 log loss 的公式，詳細解釋與公式推導推薦閱讀此篇：\n<a href=\"https://www.codelast.com/%E5%8E%9F%E5%88%9B-%E7%94%A8%E4%BA%BA%E8%AF%9D%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84logistic-regression%EF%BC%88%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%EF%BC%89/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">用人話解釋機器學習中的 Logistic Regression</a></p>\n<p>照著公式很容易就可以帶出上述的 <code class=\"language-text\">loss()</code>。</p>\n<p>最後就可以開始 training 我們的 data 啦：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 梯度優化</span>\n<span class=\"token keyword\">const</span> learningRate <span class=\"token operator\">=</span> <span class=\"token number\">0.001</span>\n<span class=\"token keyword\">const</span> optimizer <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">.</span><span class=\"token function\">sgd</span><span class=\"token punctuation\">(</span>learningRate<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Training!</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    optimizer<span class=\"token punctuation\">.</span><span class=\"token function\">minimize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">loss</span><span class=\"token punctuation\">(</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>x_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>跟上一篇 <a href=\"https://blog.techbridge.cc/2018/03/10/deeplearnjs-simple-linear-regression/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">linear regression</a> 相同，我們採用<code class=\"language-text\">dl.train.sgd</code>，是 deeplearn.js 內建的 sgd 演算法模型，接受一個 <code class=\"language-text\">leanring rate</code> 參數。在每一次的迭代中，係數都會不斷被更新，以找出最佳的結果，而這個 <code class=\"language-text\">learningRate</code> 參數是用來控制每一次的更新幅度。因此不能夠設得太大，也不能設得太小。</p>\n<p><code class=\"language-text\">optimizer</code> 可額外輸入兩個參數，分別控制 1. 是否回傳最後的 cost; 2. 限制只更新哪些變數。我們 for loop 1000 次後，利用 <code class=\"language-text\">dataSync()</code> 來將係數從 Tensor 讀出：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 用 dataSync 取得 training 結果</span>\n<span class=\"token keyword\">const</span> wPredict <span class=\"token operator\">=</span> <span class=\"token constant\">W</span><span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bPredict <span class=\"token operator\">=</span> <span class=\"token constant\">B</span><span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>wPredict<span class=\"token punctuation\">,</span> bPredict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dataSync()</code> 是 Synchronously 的，會 block Browser 的 UI thread，直到 data 被你讀出。另外還有個 Asynchronously 的 <code class=\"language-text\">data()</code> method，會回傳 promise，當讀取結束時再呼叫 <code class=\"language-text\">resolves</code>。</p>\n<p>因為接下來要用 Highcharts 畫圖，所以需要採用 <code class=\"language-text\">dataSync()</code> 來 block 著 UI thread 等資料讀出後再繼續。</p>\n<p>取出係數的值後，就能算出一條 <code class=\"language-text\">Decision Boundary</code> 並繪製出來！</p>\n<p>根據算出的係數，畫出線條頭尾兩點：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 計算切割線段</span>\n<span class=\"token keyword\">const</span> data_line <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">180</span> <span class=\"token operator\">*</span> wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">180</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">*</span> wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data_line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>然後用 HighCharts 繪圖：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 繪製圖形</span>\n<span class=\"token keyword\">const</span> data_scatter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data_scatter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> elem <span class=\"token keyword\">of</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>x <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> elem<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        data_scatter1<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        data_scatter2<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n        \n<span class=\"token comment\">// Result</span>\n<span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        text<span class=\"token operator\">:</span> <span class=\"token string\">'deeplearn.js 你是聰明人嗎？'</span>                 \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    xAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> <span class=\"token string\">'智商'</span>                 \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        min<span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        max<span class=\"token operator\">:</span> <span class=\"token number\">180</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    yAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> <span class=\"token string\">'書讀得多寡'</span>                 \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        min<span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        max<span class=\"token operator\">:</span> <span class=\"token number\">180</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Decision Boundary'</span><span class=\"token punctuation\">,</span> \n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#fff600'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_line\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  \n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Smart'</span><span class=\"token punctuation\">,</span> \n            marker<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                symbol<span class=\"token operator\">:</span> <span class=\"token string\">'cross'</span><span class=\"token punctuation\">,</span>  \n                radius<span class=\"token operator\">:</span> <span class=\"token number\">4</span>         \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#FF0000'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_scatter1\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Stupid'</span><span class=\"token punctuation\">,</span>\n            marker<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                symbol<span class=\"token operator\">:</span> <span class=\"token string\">'cross'</span><span class=\"token punctuation\">,</span>  \n                radius<span class=\"token operator\">:</span> <span class=\"token number\">4</span>         \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#6B8E23'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_scatter2\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 图表初始化函数</span>\n<span class=\"token keyword\">const</span> chart <span class=\"token operator\">=</span> Highcharts<span class=\"token punctuation\">.</span><span class=\"token function\">chart</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"最終成果\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%B5%82%E6%88%90%E6%9E%9C\" aria-label=\"最終成果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最終成果</h2>\n<p data-height=\"469\" data-theme-id=\"29194\" data-slug-hash=\"NYwZwv\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"DeeplearnJS-logistic-regression\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/NYwZwv/\">DeeplearnJS-logistic-regression</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>再次使用 deeplearn.js 來實作 Machine Learing 演算法，發現真的要套用這些 library 已經非常容易了，但還是受限於對演算法與數學公式的理解與敏銳度，不過也是透過這樣的實作練習，逼迫自己去嘗試了解這些演算法背後的概念與數學，在過程中也不斷想起以前大學修離散數學的記憶，當時都不太懂要怎麼使用這些數學，現在知道後就能讀得津津有味，也是蠻有意思的！</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://blog.csdn.net/ns2250225/article/details/79416651\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">【webAI】deeplearn.js的邏輯回歸</a></li>\n<li><a href=\"https://github.com/PAIR-code/deeplearnjs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub Deeplearnjs</a></li>\n<li><a href=\"https://deeplearnjs.org/docs/api/index.html#dl.train.sgd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Deeplearn js API doc</a></li>\n<li><a href=\"https://www.codelast.com/%E5%8E%9F%E5%88%9B-%E7%94%A8%E4%BA%BA%E8%AF%9D%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84logistic-regression%EF%BC%88%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%EF%BC%89/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">用人話解釋機器學習中的 Logistic Regression</a></li>\n<li><a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Machine Learning 學習日記</a></li>\n<li><a href=\"https://taweihuang.hpd.io/2017/12/22/logreg101/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">你可能不知道的邏輯迴歸</a></li>\n<li><a href=\"https://medium.com/@chih.sheng.huang821/%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92-%E6%94%AF%E6%92%90%E5%90%91%E9%87%8F%E6%A9%9F-support-vector-machine-svm-%E8%A9%B3%E7%B4%B0%E6%8E%A8%E5%B0%8E-c320098a3d2e\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">機器學習-支撐向量機(support vector machine, SVM)詳細推導</a></li>\n</ol>","id":"9b284547-b3ce-573f-8f98-f23bd33522a3","fields":{"slug":"deeplearnjs-logistic-regression"},"frontmatter":{"date":"2018-03-30T20:00:08.000Z","title":"用 Javascript 進行邏輯迴歸分析","tags":["deeplearnjs","machine learning","logistic-regression","javascript"],"type":"tech","slug":"deeplearnjs-logistic-regression"},"timeToRead":10},"next":{"excerpt":"『強者是不會待在同一個地方太久的。』","html":"<blockquote>\n<p>『強者是不會待在同一個地方太久的。』</p>\n</blockquote>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>在眾多 ES6 提供的新功能上，Proxy 與 Reflect 算是最少被提及的，主要原因我想還是因為瀏覽器的支援度較低，不過在我前陣子看到 <a href=\"https://jack.ofspades.com/frameworkless-javascript-part-3-one-way-data-binding/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Frameworkless JavaScript Part 3: One-Way Data Binding</a> 這篇文章時（好文推薦！很有趣），特意去查了一下才發現目前支援度已經越來越好：</p>\n<p><img src=\"/image/caniuseproxy.png\" alt=\"Can I Use Proxy\"></p>\n<p><img src=\"/image/caniusereflect.png\" alt=\"Can I Use Reflect\"></p>\n<p>常用的瀏覽器幾乎都支援，我想也是可以來好好了解一下這兩個神奇的物件了！</p>\n<p>最後有個參考該篇文章實作的 Todo app 範例，如果懶得看介紹的可以先 <a href=\"#todo-sample\">跳下去</a> 玩玩，但若是對 Proxy 與 Reflect 不了解的人還是建議先看一下。</p>\n<h1 id=\"proxy\" style=\"position:relative;\"><a href=\"#proxy\" aria-label=\"proxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proxy</h1>\n<blockquote>\n<p>Proxy 物件被使用於定義基本操作的自定行為（例如：尋找屬性、賦值、列舉、函式調用等等）。 - <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Proxy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MDN</a></p>\n</blockquote>\n<p>不知道為什麼唸起來有點饒口，但基本上跟其字面意思相同，就是代理（代為管理）物件行為。</p>\n<p>Proxy 是一個函式物件（可被建構），他提供一個機會讓你能介入一般物件的基本操作行為，像是在你 assign 一個值給某個物件時，可以透過 Proxy 先進行一些 validation 等等，藉此讓使用被代理過後的物件之開發者可以專注在其他核心功能上。</p>\n<p>咦？聽起來很像許多 framework 或 helper library 會做的事情？有趣！讓我們繼續看下去。</p>\n<p>使用方法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> proxyObj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">target</code> 就是你想要代理的對象；而 <code class=\"language-text\">handler</code> 則是一個物件，其中定義了所有你想替 target 代為管理的操作定義，包含了：</p>\n<ul>\n<li>construct(target, args) - 代理 Object 的 <code class=\"language-text\">new</code> operator</li>\n<li>get(target, prop, receiver) - 代理 Object getting properties 時的行為</li>\n<li>set(target, prop, value, receiver) - 代理 Object setting properties 時的行為</li>\n<li>apply(target, object, args) - 代理 function call，像是 f.apply()</li>\n<li>has(target, prop) - 代理 <code class=\"language-text\">in</code> operator</li>\n<li>defineProperty(target, propKey, propDesc) - 代理 <code class=\"language-text\">Object.defineProperty</code>.</li>\n<li>deleteProperty(target, prop) - 代理 <code class=\"language-text\">delete</code> operator</li>\n<li>getOwnPropertyDescriptor(target, prop) - 代理 <code class=\"language-text\">Object.getOwnPropertyDescriptor</code>.</li>\n<li>getPrototypeOf(target) - 代理 <code class=\"language-text\">Object.getPrototypeOf</code>.</li>\n<li>setPrototypeOf(target, proto) - 代理 <code class=\"language-text\">Object.setPrototypeOf</code>.</li>\n<li>ownKeys(target) - 代理 <code class=\"language-text\">Object.getOwnPropertyNames</code> 與 <code class=\"language-text\">Object.getOwnPropertySymbols</code>.</li>\n<li>isExtensible(target) - 代理 <code class=\"language-text\">Object.isExtensible</code>.</li>\n<li>preventExtensions(target) - 代理 <code class=\"language-text\">Object.preventExtensions</code>.</li>\n</ul>\n<p><code class=\"language-text\">handler</code> object 所包含的 method 定義可以從 <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Proxy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MDN</a> 看到更多範例與描述。</p>\n<h2 id=\"說了這麼多我們到底能拿-proxy-來做什麼呢直接來點範例吧\" style=\"position:relative;\"><a href=\"#%E8%AA%AA%E4%BA%86%E9%80%99%E9%BA%BC%E5%A4%9A%E6%88%91%E5%80%91%E5%88%B0%E5%BA%95%E8%83%BD%E6%8B%BF-proxy-%E4%BE%86%E5%81%9A%E4%BB%80%E9%BA%BC%E5%91%A2%E7%9B%B4%E6%8E%A5%E4%BE%86%E9%BB%9E%E7%AF%84%E4%BE%8B%E5%90%A7\" aria-label=\"說了這麼多我們到底能拿 proxy 來做什麼呢直接來點範例吧 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>說了這麼多，我們到底能拿 Proxy 來做什麼呢？直接來點範例吧！</h2>\n<h3 id=\"直觀的私有變數\" style=\"position:relative;\"><a href=\"#%E7%9B%B4%E8%A7%80%E7%9A%84%E7%A7%81%E6%9C%89%E8%AE%8A%E6%95%B8\" aria-label=\"直觀的私有變數 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>直觀的私有變數</h3>\n<p>以往在 Javascript 中，我們可能需要透過 <code class=\"language-text\">closure</code> 來實現物件的私有變數，像是：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">FooBar</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>closeTime <span class=\"token operator\">=</span> <span class=\"token string\">'never'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setSecretDrink</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">secret</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> secretDrink <span class=\"token operator\">=</span> secret<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getSecretDrink</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> secretDrink<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> fooBar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FooBar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfooBar<span class=\"token punctuation\">.</span><span class=\"token function\">setSecretDrink</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Jäger Bom'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>fooBar<span class=\"token punctuation\">.</span><span class=\"token function\">getSecretDrink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 'Jäger Bom'</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>fooBar<span class=\"token punctuation\">.</span>closeTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// never</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>fooBar<span class=\"token punctuation\">.</span>secretDrink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// undefined</span></code></pre></div>\n<p>但透過 Proxy，我們可以很直觀地在一個 Object 內達成類似效果：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> FooBar <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  _secretDrink<span class=\"token operator\">:</span> <span class=\"token string\">'Jäger Bom'</span><span class=\"token punctuation\">,</span>\n  closeTime<span class=\"token operator\">:</span> <span class=\"token string\">'never'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nFooBarProxy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 以底線開頭的作為私有變數</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'不能存取私有變數！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 非私有變數，那就回傳原物件的原屬性值</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'不能修改私有變數！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">has</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> prop<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>prop <span class=\"token keyword\">in</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nFooBarProxy<span class=\"token punctuation\">.</span>_secretDrink<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 不能存取私有變數！</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>FooBarProxy<span class=\"token punctuation\">.</span>closeTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// never</span>\nFooBarProxy<span class=\"token punctuation\">.</span>_secretDrink <span class=\"token operator\">=</span> <span class=\"token string\">'Cola'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 不能修改私有變數！</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_secretDrink'</span> <span class=\"token keyword\">in</span> FooBarProxy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// false</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'closeTime'</span> <span class=\"token keyword\">in</span> FooBarProxy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span></code></pre></div>\n<p>眼尖一點的讀者可能會發現，這邊 handler 裡面的 <code class=\"language-text\">get</code>、<code class=\"language-text\">set</code> 好像跟上面定義中的參數不同，少了 <code class=\"language-text\">receiver</code> 這個參數？</p>\n<p>沒錯，這個神奇的第三個參數其實是指向你產生的 Proxy 實例，以上面例子來看就是 <code class=\"language-text\">FooBarProxy</code> 本身，由於範例中用不到，所以不宣告也沒關係，不過晚點在 <code class=\"language-text\">Reflect</code> 的介紹會再度提起。</p>\n<p>另外，若是沒有被你代理到的操作，則會直接 fallback 回原始 target 物件的操作上。</p>\n<h3 id=\"在設置物件屬性前進行-validation\" style=\"position:relative;\"><a href=\"#%E5%9C%A8%E8%A8%AD%E7%BD%AE%E7%89%A9%E4%BB%B6%E5%B1%AC%E6%80%A7%E5%89%8D%E9%80%B2%E8%A1%8C-validation\" aria-label=\"在設置物件屬性前進行 validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>在設置物件屬性前進行 Validation</h3>\n<p>延續剛剛的例子，我們的 FooBar 除了秘密飲料外，也需要紀錄一下基本資訊，像是電話、地址等等，這時候 Proxy 就能為我們帶來另一個好處：驗證屬性值：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> FooBar <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  _secretDrink<span class=\"token operator\">:</span> <span class=\"token string\">'Jäger Bom'</span><span class=\"token punctuation\">,</span>\n  closeTime<span class=\"token operator\">:</span> <span class=\"token string\">'never'</span><span class=\"token punctuation\">,</span>\n  phoneNumber<span class=\"token operator\">:</span> <span class=\"token string\">'02-2849-2839'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nFooBar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prop <span class=\"token operator\">===</span> <span class=\"token string\">'phoneNumber'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// phone number validation</span>\n      <span class=\"token keyword\">var</span> re <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^\\(?\\d{2}\\)?[\\s\\-]?\\d{4}\\-?\\d{4}$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>re<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Cannot set </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>prop<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> to </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>value<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">. Wrong format. Should be xx-xxxx-xxxx</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">//..</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><img src=\"/image/proxy-validationexample.png\" alt=\"proxy example validation\"></p>\n<p>只要你設置的 <code class=\"language-text\">phoneNumber</code> 不符合 regex 的規則，就會拋出一個 Error 告訴開發者，此物件的 <code class=\"language-text\">phoneNumber</code> 屬性值是有固定 format 的。</p>\n<p>當然，javascript 充滿彈性，你也可以有彈性一點的寫法，把 validator 抽離出來：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> BarValidator <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">_secretDrink</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'cola'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'lame...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">phoneNumber</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> re <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^\\(?\\d{2}\\)?[\\s\\-]?\\d{4}\\-?\\d{4}$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>re<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Cannot set phoneNumber to </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>value<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">. Wrong format. Should be xx-xxxx-xxxx</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nFooBar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    BarValidator<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">//..</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"用來設定屬性預設值\" style=\"position:relative;\"><a href=\"#%E7%94%A8%E4%BE%86%E8%A8%AD%E5%AE%9A%E5%B1%AC%E6%80%A7%E9%A0%90%E8%A8%AD%E5%80%BC\" aria-label=\"用來設定屬性預設值 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>用來設定屬性預設值</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 實際上沒有這個屬性</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">.</span>revenue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// undefined</span>\n\n<span class=\"token comment\">// 但經過 Proxy 後</span>\nFooBar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>prop <span class=\"token operator\">===</span> <span class=\"token string\">'revenue'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">'None of your business'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">//..</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 可以讀取到我們設定的預設值</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">.</span>revenue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 'None of your business'</span></code></pre></div>\n<h3 id=\"複寫原有物件讓測試更加順利mock-object\" style=\"position:relative;\"><a href=\"#%E8%A4%87%E5%AF%AB%E5%8E%9F%E6%9C%89%E7%89%A9%E4%BB%B6%E8%AE%93%E6%B8%AC%E8%A9%A6%E6%9B%B4%E5%8A%A0%E9%A0%86%E5%88%A9mock-object\" aria-label=\"複寫原有物件讓測試更加順利mock object permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>複寫原有物件，讓測試更加順利（mock object）</h3>\n<p>寫測試的時候很常會需要 mock object，像是 function 中若有讀取 <code class=\"language-text\">document.location.href</code> 的部分，在你開發機上基本上都會是 <code class=\"language-text\">localhost</code>，這時候就會需要把這個值 mock 掉。</p>\n<p>這時我們就可以將 <code class=\"language-text\">document.location</code> 委託給 proxy 代理：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mockDocument <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  location<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> prop</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prop <span class=\"token operator\">==</span> <span class=\"token string\">\"href\"</span><span class=\"token punctuation\">)</span>\n              <span class=\"token keyword\">return</span> <span class=\"token string\">\"your-website-com\"</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"location href: \"</span><span class=\"token punctuation\">,</span> mockLocation<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// https://blog.arvinh.info</span></code></pre></div>\n<h3 id=\"看到這邊想必很多人都會想到我們可以實作-observe-function\" style=\"position:relative;\"><a href=\"#%E7%9C%8B%E5%88%B0%E9%80%99%E9%82%8A%E6%83%B3%E5%BF%85%E5%BE%88%E5%A4%9A%E4%BA%BA%E9%83%BD%E6%9C%83%E6%83%B3%E5%88%B0%E6%88%91%E5%80%91%E5%8F%AF%E4%BB%A5%E5%AF%A6%E4%BD%9C-observe-function\" aria-label=\"看到這邊想必很多人都會想到我們可以實作 observe function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>看到這邊想必很多人都會想到，我們可以實作 Observe function！</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> property<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>property<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      target<span class=\"token punctuation\">[</span>property<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> FooBar <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> open<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> FooBarObserver <span class=\"token operator\">=</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">property<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  property <span class=\"token operator\">===</span> <span class=\"token string\">'open'</span> <span class=\"token operator\">&amp;&amp;</span> value <span class=\"token operator\">?</span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'FooBar is open!!!'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keep waiting'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nFooBarObserver<span class=\"token punctuation\">.</span>open <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"不是什麼都可以被代理的\" style=\"position:relative;\"><a href=\"#%E4%B8%8D%E6%98%AF%E4%BB%80%E9%BA%BC%E9%83%BD%E5%8F%AF%E4%BB%A5%E8%A2%AB%E4%BB%A3%E7%90%86%E7%9A%84\" aria-label=\"不是什麼都可以被代理的 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>不是什麼都可以被代理的</h3>\n<p>不知道大家會不會有個疑問，難道所有物件都能被 proxy 代理嗎？有沒有辦法限制我的某個物件就是不希望被他人代理？</p>\n<p>當然有！</p>\n<p>如果你的物件擁有 <code class=\"language-text\">configurable: false</code> 與 <code class=\"language-text\">writable: false</code> 的屬性，那該物件就無法被 proxy 代理：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  FooBar<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    writable<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'???'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> proxy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nproxy<span class=\"token punctuation\">.</span>FooBar\n<span class=\"token comment\">// Uncaught TypeError: 'get' on proxy: property 'FooBar' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected 'undefined' but got '???')</span></code></pre></div>\n<h3 id=\"小結論\" style=\"position:relative;\"><a href=\"#%E5%B0%8F%E7%B5%90%E8%AB%96\" aria-label=\"小結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>小結論</h3>\n<p>這邊我只列了幾個我覺得比較能凸顯 Proxy 用途的範例，而其他 handler 可以介入的操作如果大家也想了解並看看例子的話，阮一峰的 <a href=\"http://es6.ruanyifeng.com/#docs/proxy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ECMAScript 6 入門</a> 中有針對每個操作給予例子做解析，可以參考。</p>\n<h1 id=\"reflect\" style=\"position:relative;\"><a href=\"#reflect\" aria-label=\"reflect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reflect</h1>\n<p>接著我們來看看 Reflect。Reflect 不能建構實例，就像 Math 一樣，單純包含了一系列的靜態方法。</p>\n<h2 id=\"reflect-與-proxy-的完美搭配\" style=\"position:relative;\"><a href=\"#reflect-%E8%88%87-proxy-%E7%9A%84%E5%AE%8C%E7%BE%8E%E6%90%AD%E9%85%8D\" aria-label=\"reflect 與 proxy 的完美搭配 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reflect 與 Proxy 的完美搭配</h2>\n<p>網路上許多文章都說 Reflect 是因應 Proxy 才增加的規範，最明確的連結是，Reflect 所定義的靜態方法包含了 Proxy Handler 能處理的所有代理操作，但他提供的是呼叫原始物件的操作，舉例來說：</p>\n<p><code class=\"language-text\">Reflect.get(target, name);</code> 效果等同於 <code class=\"language-text\">target[name];</code></p>\n<p>所以我們在 Proxy 中，如果需要 target 物件的預設操作，使用 Reflect 會更合理更清楚：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> loggedObj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"主要的理由在於reflect-讓我們對物件的操作可以用函數來處理\" style=\"position:relative;\"><a href=\"#%E4%B8%BB%E8%A6%81%E7%9A%84%E7%90%86%E7%94%B1%E5%9C%A8%E6%96%BCreflect-%E8%AE%93%E6%88%91%E5%80%91%E5%B0%8D%E7%89%A9%E4%BB%B6%E7%9A%84%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8%E5%87%BD%E6%95%B8%E4%BE%86%E8%99%95%E7%90%86\" aria-label=\"主要的理由在於reflect 讓我們對物件的操作可以用函數來處理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>主要的理由在於，Reflect 讓我們對物件的操作可以用函數來處理</h3>\n<p>例如在判斷物件有無特定屬性，或是刪除物件屬性時，以往我們會這樣做：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'_secretDrink'</span> <span class=\"token keyword\">in</span> FooBar<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">delete</span> Object<span class=\"token punctuation\">.</span>_secretDrink<span class=\"token punctuation\">;</span></code></pre></div>\n<p>有了 Reflect 我們可以這樣做：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token string\">'_secretDrink'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nReflect<span class=\"token punctuation\">.</span><span class=\"token function\">deleteProperty</span><span class=\"token punctuation\">(</span>FooBar<span class=\"token punctuation\">,</span> <span class=\"token string\">'_secretDrink'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>因此，在 Proxy 中，比起使用 <code class=\"language-text\">delete target[name]</code>, <code class=\"language-text\">Reflect.deleteProperty</code> 更能保持一制性：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> loggedObj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">deleteProperty</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// instead of `delete target[name]...</span>\n    <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">deleteProperty</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"控制被-proxy-代理的函數之-this-參考對象\" style=\"position:relative;\"><a href=\"#%E6%8E%A7%E5%88%B6%E8%A2%AB-proxy-%E4%BB%A3%E7%90%86%E7%9A%84%E5%87%BD%E6%95%B8%E4%B9%8B-this-%E5%8F%83%E8%80%83%E5%B0%8D%E8%B1%A1\" aria-label=\"控制被 proxy 代理的函數之 this 參考對象 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>控制被 Proxy 代理的函數之 this 參考對象</h3>\n<p>這個例子比較難懂，但這是說明為何 Reflect 是因應 Proxy 而生的好例子(<a href=\"https://stackoverflow.com/questions/35276559/benefits-of-es6-reflect-api\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source</a>)：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>bar<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    bar<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> propertyKey<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propertyKey <span class=\"token operator\">===</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Reflect.get '</span><span class=\"token punctuation\">,</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> propertyKey<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// this in foo getter references Proxy instance; logs 2</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'target[propertyKey] '</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">[</span>propertyKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// this in foo getter references \"target\" - logs 3</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 2</span>\nobj<span class=\"token punctuation\">.</span>foo<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Reflect.get  2</span>\n<span class=\"token comment\">// target[propertyKey]  3</span></code></pre></div>\n<p><a class=\"jsbin-embed\" href=\"http://jsbin.com/bimadip/2/embed?js,console\">JS Bin on jsbin.com</a><script src=\"http://static.jsbin.com/js/embed.min.js?4.1.4\"></script></p>\n<p>假設你的 object target 有一個 getter 函數 foo()，現在你透過 Proxy 代理 get 函數，當今天你呼叫 <code class=\"language-text\">obj.bar</code> 時，會印出 <code class=\"language-text\">2</code>，因為 Proxy handler 攔截並代理了原始 target 物件的 get 函數；接著，若你呼叫 <code class=\"language-text\">obj.foo</code>，會出現兩個結果: <code class=\"language-text\">Reflect.get  2</code> 與 <code class=\"language-text\">target[propertyKey]  3</code>。</p>\n<p>為什麼？</p>\n<p>這是因為只有透過 <code class=\"language-text\">Reflect.get()</code> 的第三個參數 <code class=\"language-text\">receiver</code>，將指向 Proxy 本身的實例傳進去原始物件的 get 呼叫，才能夠真的呼叫到 Proxy.get。</p>\n<p>若是直接透過 <code class=\"language-text\">target['foo']</code>，則原本在 <code class=\"language-text\">foo</code> 中的 this，就會指向原始的 target 本身，而不會觸發 Proxy 的 get。</p>\n<p>這邊概念真的比較難懂，若我有任何錯誤地方歡迎指正，我相信大家多看幾次範例後都能悟道的。</p>\n<p>除了與 Proxy 匹配的優勢外，Reflect 還帶來了一些好處（source: <a href=\"https://goo.gl/9v9STM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Benefits of ES6 Reflect API</a>, <a href=\"https://github.com/tvcutsem/harmony-reflect/wiki\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Harmony-reflect</a>)：</p>\n<h3 id=\"更優雅更好用的回傳值\" style=\"position:relative;\"><a href=\"#%E6%9B%B4%E5%84%AA%E9%9B%85%E6%9B%B4%E5%A5%BD%E7%94%A8%E7%9A%84%E5%9B%9E%E5%82%B3%E5%80%BC\" aria-label=\"更優雅更好用的回傳值 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>更優雅、更好用的回傳值</h3>\n<p>以往使用 <code class=\"language-text\">Object.defineProperty(obj, name, desc);</code> 時，若成功，會回傳 obj，失敗則有可能會拋出 Error。而使用 <code class=\"language-text\">Reflect.defineProperty(obj, name, desc)</code> 的話，則會回傳 boolean 值，讓失敗或成功的結果有統一的格式。</p>\n<!-- 介紹其他更多好處 https://github.com/tvcutsem/harmony-reflect/wiki-->\n<h3 id=\"更可靠的-code-classlanguage-textapplycode\" style=\"position:relative;\"><a href=\"#%E6%9B%B4%E5%8F%AF%E9%9D%A0%E7%9A%84-code-classlanguage-textapplycode\" aria-label=\"更可靠的 code classlanguage textapplycode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>更可靠的 <code class=\"language-text\">apply</code></h3>\n<p>在 es5 時，大家都很習慣透過 <code class=\"language-text\">f.apply(obj, args)</code> 的方式來 apply 函數到物件上頭，但很有可能在某些情況下，<code class=\"language-text\">f.apply</code> 被串改了，這時候就會有不預期的結果。</p>\n<p>Senior 一點的會知道可以利用 <code class=\"language-text\">Function.prototype.apply.call(f, obj, args)</code> 來呼叫，至少 prototype 不會騙你，但這種方式總是不夠優雅。</p>\n<p>現在有了 Reflect 後，就不需要擔心這種事情，透過 <code class=\"language-text\">Reflact.apply(obj, args)</code> 就能輕鬆達到一樣效果。</p>\n<h3 id=\"接受可變參數的-constructor\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E5%8F%97%E5%8F%AF%E8%AE%8A%E5%8F%83%E6%95%B8%E7%9A%84-constructor\" aria-label=\"接受可變參數的 constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接受可變參數的 Constructor</h3>\n<p>這個優點只有跟 ES5 比較時才有優勢。主要是讓你能透過：<code class=\"language-text\">const obj = Reflect.construct(FooBar, args)</code> 來在建構物件實例時，傳遞可變參數；若是在 ES5 的世界，只有 <code class=\"language-text\">FooBar.apply</code> 或 <code class=\"language-text\">FooBar.call</code> 能夠接受變動參數，但是在 <code class=\"language-text\">new</code> 物件實例時，並沒有 <code class=\"language-text\">apply</code> 或 <code class=\"language-text\">call</code> 可以使用。</p>\n<p>而現在透過 ES6 的 spread syntax，我們可以在建構物件實例時，直接傳遞可變參數：<code class=\"language-text\">const obj = new FooBar(...args)</code>。</p>\n<!-- 最後說明 https://jack.ofspades.com/frameworkless-javascript-part-3-one-way-data-binding/ 中 data binding 的實作-->\n<p><span id=\"todo-sample\"></span></p>\n<h2 id=\"最終範例利用-proxy-與-reflect-完成-one-way-data-binding\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%B5%82%E7%AF%84%E4%BE%8B%E5%88%A9%E7%94%A8-proxy-%E8%88%87-reflect-%E5%AE%8C%E6%88%90-one-way-data-binding\" aria-label=\"最終範例利用 proxy 與 reflect 完成 one way data binding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最終範例：利用 Proxy 與 Reflect 完成 one way data binding</h2>\n<p>在了解完 Proxy 與 Reflect 的基本使用方式後，想分享一個很有趣的應用，也就是我開頭提到，激發我研究 Proxy 的範例：frameworkless js one way data binding.</p>\n<p>結合先前提過的 Observe function，來實作一個簡單 Todo App：</p>\n<p data-height=\"339\" data-theme-id=\"dark\" data-slug-hash=\"LrpOEw\" data-default-tab=\"js,result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"Oneway-data-binding-js-proxy-reflect\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/LrpOEw/\">Oneway-data-binding-js-proxy-reflect</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>基本上是結合了上述介紹的 Proxy 與 Reflect 特性，並融合[這篇文章]((<a href=\"https://jack.ofspades.com/frameworkless-javascript-part-3-one-way-data-binding/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://jack.ofspades.com/frameworkless-javascript-part-3-one-way-data-binding/</a>)的範例所製作的，如果大家有看完前面的介紹，對於這段 code 應該不難理解。</p>\n<p>主要是透過 Proxy 來代理 Object 的 <code class=\"language-text\">set</code> 與 <code class=\"language-text\">deleteProperty</code> 操作，讓 Todo list 的變動能夠被代理。</p>\n<p>此外，在先前的介紹中，都是以 Object 為主，但 todo app 範例中被 Proxy 代理的是 Array。</p>\n<p>最大的差別在於，當你 push 一個新 item 進入 Array 時，<code class=\"language-text\">set</code> 會被呼叫兩次，一次是新的 item 被塞入陣列時，一次是 Array 的 <code class=\"language-text\">length</code> property 加一時。所以要特別濾掉 <code class=\"language-text\">length</code> 更動的那次代理操作。</p>\n<p>最後，只要在代理的操作中，想辦法把 DOM 做對應的修改，如同上面程式中的 <code class=\"language-text\">line 22 ~ line 40</code>，定義一些 render template 的 function 來更新 DOM 即可。</p>\n<!-- 最終結論 -->\n<h1 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h1>\n<p>Javascript 的變動總是快於瀏覽器支援度，所以常常造成一些新的 Spec 我們不熟悉、不知如何運用，這次的研究學習了不少，而上面的 Todo App 是個簡陋不嚴謹的範例，不過也足以展現 Proxy 與 Reflect 在實際運用上的情境，並帶給我們另一種思考方向，很多時候不用一開始就套用 Framework，透過越來越進步的瀏覽器與 ES 版本，我們也能達到一樣目的。雖然比不上 framework 包山包海的優化，但或許能讓我們更了解實際要解決的問題是什麼，以及解決方法背後的概念。</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://jack.ofspades.com/frameworkless-javascript-part-3-one-way-data-binding/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Frameworkless JavaScript Part 3: One-Way Data Binding</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Proxy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MDN Proxy</a></li>\n<li><a href=\"https://www.jianshu.com/p/34f0e6abe312\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ES6 之 Proxy 介绍</a></li>\n<li><a href=\"http://es6.ruanyifeng.com/#docs/proxy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ECMAScript 6 入门</a></li>\n</ol>","id":"393df517-f9fc-527c-b09f-770cb56ee625","fields":{"slug":"js-proxy-reflect"},"frontmatter":{"date":"2018-05-27T23:20:17.000Z","title":"一起來了解 Javascript 中的 Proxy 與 Reflect","tags":["javascript","es6","proxy","reflect","frameworkless"],"type":"tech","slug":"js-proxy-reflect"},"timeToRead":15},"type":"tech"}},"staticQueryHashes":["2123680655"]}