{"componentChunkName":"component---src-templates-post-tsx","path":"/tech/deeplearnjs-simple-linear-regression","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>好歌分享：<a href=\"https://youtu.be/CZ95wRScgvU\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">鈴木雅之　恋人</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/CZ95wRScgvU\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>約莫兩個月前，我利用 <a href=\"https://github.com/ITPNYU/p5-deeplearn-js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">p5-deeplearn-js</a> 這套工具在 Chrome extension 中玩了一下機器學習的應用 (請參閱<a href=\"https://blog.techbridge.cc/2018/01/13/p5ML-deeplearnjs/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">前端也能玩 Deepleaning - 以 p5-deeplearn-js 為例</a>)，當時雖然有去看他們的 source code，但對於底層 deeplearnjs 的部分並沒有仔細去了解，畢竟還是要對 ML 有根本的了解，才能讀得懂。</p>\n<p>而隨著 Google 發布 <a href=\"https://developers.google.com/machine-learning/crash-course/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Machine Learning Crash Course</a>，再度讓我有了研究 deeplearn.js 的念頭，但萬事起頭難，一開始不能太勉強自己，所以本文就先從最簡單的 linear regression 實作開始，來熟悉一下基本操作！</p>\n<p>照慣例先來張 Demo 成果圖：</p>\n<p><img src=\"/image/deeplearnjs-demo-img.png\" alt=\"Demo\"> </p>\n<p>範例是從 <a href=\"https://ithelp.ithome.com.tw/articles/10186905\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">這篇文章</a> 中獲得的靈感，假資料也是取自該處。</p>\n<h2 id=\"先進入假想情境\" style=\"position:relative;\"><a href=\"#%E5%85%88%E9%80%B2%E5%85%A5%E5%81%87%E6%83%B3%E6%83%85%E5%A2%83\" aria-label=\"先進入假想情境 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>先進入假想情境！</h2>\n<p>想像一下你是一間飲料店老闆，在經濟不景氣的情況下，你需要嚴格控管你的進貨成本，因此，聰明的你開始觀察各種可能，最後發現天氣的變化與你的飲料銷售量有很大的關聯！</p>\n<p>然而，氣象資料很好取得，但你需要的是能夠預測在哪種天氣下，你需要進多少貨，以此來控管每一次的進貨量。</p>\n<p>也就是說，你需要一個公式！</p>\n<p>這個公式要能夠讓你輸入一個特徵 X（也就是氣溫度數），接著透過運算後產生一個目標變數 Y（也就是飲料銷售量）。</p>\n<p>能當到老闆，想必數學不會太差，整理一下後發現，我們只有一個自變量 <code class=\"language-text\">X</code>，以及因變量 <code class=\"language-text\">Y</code>，因此可以嘗試用一個簡單的線性函數來逼近這公式：</p>\n<p><code class=\"language-text\">Y = aX + b</code></p>\n<p>問題就來了，要怎麼樣找出適合的係數 <code class=\"language-text\">a</code> 與 <code class=\"language-text\">b</code> 呢？</p>\n<h2 id=\"先別急讓我們先把資料整理一下\" style=\"position:relative;\"><a href=\"#%E5%85%88%E5%88%A5%E6%80%A5%E8%AE%93%E6%88%91%E5%80%91%E5%85%88%E6%8A%8A%E8%B3%87%E6%96%99%E6%95%B4%E7%90%86%E4%B8%80%E4%B8%8B\" aria-label=\"先別急讓我們先把資料整理一下 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>先別急，讓我們先把資料整理一下</h2>\n<p>資料分析的第一步一定是先取得資料，身為飲料店老闆，要取得銷售資量應該不難，再上網查個氣象資訊就好，因此可以得到如下資料：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 建構資料 （當然是假的）</span>\n<span class=\"token keyword\">const</span> degrees <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">33</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> salesVolume <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">77</span><span class=\"token punctuation\">,</span> <span class=\"token number\">62</span><span class=\"token punctuation\">,</span> <span class=\"token number\">93</span><span class=\"token punctuation\">,</span> <span class=\"token number\">84</span><span class=\"token punctuation\">,</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token number\">75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">58</span><span class=\"token punctuation\">,</span> <span class=\"token number\">91</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span><span class=\"token punctuation\">,</span> <span class=\"token number\">73</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">84</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>資料是成對關係，<code class=\"language-text\">氣溫 29 度</code>，<code class=\"language-text\">冰紅茶銷售量 77</code>。</p>\n<p>接著我們可以先利用 HighCharts 把資料先視覺化出來，你就會很有感覺我們該做什麼。</p>\n<p data-height=\"468\" data-theme-id=\"dark\" data-slug-hash=\"PRweww\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"DeeplearnJS-simple-linear-dataset\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/PRweww/\">DeeplearnJS-simple-linear-dataset</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>嗯...看起來這些點似乎真的可以用一個線性函數去逼近呢！而且更棒的是，透過這些過往資料，應該是有助於我們找出公式中最棒的係數的！</p>\n<h2 id=\"接著就該-linear-regression-就登場了\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E8%91%97%E5%B0%B1%E8%A9%B2-linear-regression-%E5%B0%B1%E7%99%BB%E5%A0%B4%E4%BA%86\" aria-label=\"接著就該 linear regression 就登場了 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接著就該 Linear regression 就登場了！</h2>\n<p>在機器學習的領域中，像我們這樣依靠大量資料來輔助學習的，稱作監督式學習。</p>\n<p>而當公式中的目標變數（也就是 y）是連續型（continuous）的變數時，這樣的學習問題會稱為回歸（regression）問題。</p>\n<p>那一個線性函數的回歸問題，就是線性迴歸 (linear regression) 了。</p>\n<p>關於 Linear regression 的一些數學公式推導等等，我推薦大家閱讀這篇文章：<a href=\"https://blog.gtwang.org/statistics/standford-machine-learning-1/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">史丹佛大學機器學習（Machine Learning）上課筆記（一）</a></p>\n<p>裡面解釋得淺顯易懂，絕對比我解釋得還好...</p>\n<p>就算不清楚線性迴歸，光看公式應該也知道，我們可以透過大量的迭代測試，不斷輸入 <code class=\"language-text\">X</code>，然後調整 <code class=\"language-text\">a</code> 與 <code class=\"language-text\">b</code> 來求出 <code class=\"language-text\">Y</code>，然後找出在所有 input 中，能得到與所有真實資料差距最小的一對係數即可。</p>\n<p>用線性回歸的概念來解釋，就是我們需要有一個 cost function（或稱 loss function），藉由不同係數的輸入，從公式得出的值來與實際資料比較，想辦法找出結果差距最小的係數。</p>\n<p>一般來說，cost function 會用 LMS（least mean squares）演算法來處理，可以先猜一個初始係數值，然後藉由 LMS 來不斷更新係數，直到找出最小差距的情況。</p>\n<p>但這是單一 training sample 的狀況，當有多個 training sample 時，通用的演算法稱為 stochastic gradient descent (sgd)，概念雷同，就像是根據每一筆 training sample 去跑一次 LMS。</p>\n<p>一樣，還是請大家去閱讀 <a href=\"https://blog.gtwang.org/statistics/standford-machine-learning-1/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">史丹佛大學機器學習（Machine Learning）上課筆記（一）</a>，獲得更正確的概念。畢竟這次主要是練習如何用 deeplearnjs 來實作。</p>\n<h2 id=\"解法都有了那就來看看到底怎麼用-javascript-實作吧\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B3%95%E9%83%BD%E6%9C%89%E4%BA%86%E9%82%A3%E5%B0%B1%E4%BE%86%E7%9C%8B%E7%9C%8B%E5%88%B0%E5%BA%95%E6%80%8E%E9%BA%BC%E7%94%A8-javascript-%E5%AF%A6%E4%BD%9C%E5%90%A7\" aria-label=\"解法都有了那就來看看到底怎麼用 javascript 實作吧 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解法都有了，那就來看看到底怎麼用 Javascript 實作吧！</h2>\n<p>要使用 deeplearn.js，只需要從 cdn 載入即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span>script src<span class=\"token operator\">=</span><span class=\"token string\">\"https://unpkg.com/deeplearn@latest\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></code></pre></div>\n<p>接著，我們要先初始化資料：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 建構資料</span>\n<span class=\"token keyword\">const</span> degrees <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">33</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> salesVolume <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">77</span><span class=\"token punctuation\">,</span> <span class=\"token number\">62</span><span class=\"token punctuation\">,</span> <span class=\"token number\">93</span><span class=\"token punctuation\">,</span> <span class=\"token number\">84</span><span class=\"token punctuation\">,</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token number\">75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">58</span><span class=\"token punctuation\">,</span> <span class=\"token number\">91</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span><span class=\"token punctuation\">,</span> <span class=\"token number\">73</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">84</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 運用 Deeplearn.js 結構化資料</span>\n<span class=\"token comment\">// dl 就是 deeplearn.js 的 global 變數</span>\n<span class=\"token keyword\">const</span> degrees_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor1d</span><span class=\"token punctuation\">(</span>degrees<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> salesVolume_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor1d</span><span class=\"token punctuation\">(</span>salesVolume<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>在 deeplearn.js 中，tensor 是最核心的資料結構，用來表示向量、矩陣或是多維度的資料。</p>\n<p>有許多 utility function 可以輔助創建 tensor 資料結構，像是這邊用的是 <code class=\"language-text\">tensor1d</code>，也就是 1D (1-dimension) 的 tensor。</p>\n<p>一個 tensor 其實包含三個成分，也是創建 tensor 時可以傳入的參數：</p>\n<ul>\n<li>values (TypedArray|Array): tensor 的值。可以是 nested array 或 flat array 的結構。</li>\n<li>shape（number[]）:基本上就是該 tensor 的維度。若創建 tensor 時沒有指定維度，就會繼承傳入的 values 維度。也可以像這邊的範例一樣直接使用 <code class=\"language-text\">tensor${1|2|3|4}d</code> 來創建</li>\n<li>dtype（float32'|'int32'|'bool）：值的型別，當然是 optional。</li>\n</ul>\n<p>初始化好 deeplearn.js 的資料結構後，接著定義我們要 training 的係數，這邊取為 <code class=\"language-text\">aw</code> 與 <code class=\"language-text\">ba</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 要 train 的參數 aw, ba</span>\n<span class=\"token keyword\">const</span> aw <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">scalar</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ba <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">scalar</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dl.variable(initialValue, trainable?, name?, dtype?)</code> 用來創建 training 過程中需要的變數，也可透過參數指定該變數能否在 training 過程中被修改（trainable），預設是 <code class=\"language-text\">true</code>。</p>\n<p>其中 <code class=\"language-text\">initialValue</code> 可以是一個 Tensor，也可以像我們這邊一樣，傳入 <code class=\"language-text\">dl.scalar</code>。</p>\n<p><code class=\"language-text\">dl.scalar</code> 是維度為 0 的 tensor，基本上 0 維就是一個點，由於我們只需要亂數產生一個初值給 <code class=\"language-text\">aw</code> 與 <code class=\"language-text\">ba</code>，因此用 <code class=\"language-text\">dl.scalar</code> 即可。</p>\n<p>再來，我們定義目標函數與 loss function</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 定義目標函數 與 loss function （最一般的 mean square）</span>\n<span class=\"token comment\">// f = aw * X + ba</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">f</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">x</span> <span class=\"token operator\">=></span> aw<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>ba<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loss</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pred<span class=\"token punctuation\">,</span> label</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> pred<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">square</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>在 deeplearn.js 中，函數的建構蠻直覺的，<code class=\"language-text\">y = a * x + b</code> 可以直接寫成 <code class=\"language-text\">y = x => a.mul(x).add(b)</code></p>\n<p>loss function 則是接收兩個參數的函式，<code class=\"language-text\">pred</code> 就是 training data 中的自變因 <code class=\"language-text\">x</code> 透過目標函數 <code class=\"language-text\">f</code>，計算出的值，而 label 是 training data 中的答案 <code class=\"language-text\">y</code>。</p>\n<p>然後，定義我們的 Optimizer，也就是用來最佳化 loss function 結果的演算法，這邊採用 <code class=\"language-text\">stochastic gradient descent (sgd)</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 採用 stochastic gradient descent 來做最佳化 </span>\n<span class=\"token comment\">// learning rate 這邊不能設太大</span>\n<span class=\"token keyword\">const</span> learningRate <span class=\"token operator\">=</span> <span class=\"token number\">0.0005</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> optimizer <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">.</span><span class=\"token function\">sgd</span><span class=\"token punctuation\">(</span>learningRate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dl.train.sgd</code> 是 deeplearn.js 內建的 sgd 演算法模型，接受一個 <code class=\"language-text\">leanring rate</code> 參數。在每一次的迭代中，係數都會不斷被更新，以找出最佳的結果，而這個 <code class=\"language-text\">learningRate</code> 參數是用來控制每一次的更新幅度。因此不能夠設得太大，也不能設得太小。</p>\n<p>利用定義好的目標函數 <code class=\"language-text\">f</code>、<code class=\"language-text\">loss function</code> 與 <code class=\"language-text\">optimizer</code>，我們可以就開始 training modal 了！</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// training</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> cost <span class=\"token operator\">=</span> optimizer<span class=\"token punctuation\">.</span><span class=\"token function\">minimize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">loss</span><span class=\"token punctuation\">(</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>degrees_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> salesVolume_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>aw<span class=\"token punctuation\">,</span> ba<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cost'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  cost<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aw'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  aw<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ba'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  ba<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最核心的就是這一行：</p>\n<p><code class=\"language-text\">const cost = optimizer.minimize(() => loss(f(degrees_data), salesVolume_data), true, [aw, ba])</code></p>\n<p>使用 <code class=\"language-text\">optimizer</code> 的方式如上所示，輸入執行 <code class=\"language-text\">loss function</code> 的函示，並可額外輸入兩個參數，分別控制 1. 是否回傳最後的 cost; 2. 限制只更新哪些變數。</p>\n<p>我們簡單 for loop 30 次（因為資料量很少...你要 train 一百次也行，但這邊結果不會有什麼差別）</p>\n<p>過程中若想要 debug，可以像我一樣用 <code class=\"language-text\">tensor.print()</code> 的方式把 traning 過程的係數變化 log 出來。</p>\n<p>最後，當 training 結束後，透過 <code class=\"language-text\">dataSync()</code> 將最終係數從 Tensor 中讀出：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 利用 dataSync() 取出 training 後得到的係數</span>\n<span class=\"token keyword\">const</span> awPredict <span class=\"token operator\">=</span> aw<span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> baPredict <span class=\"token operator\">=</span> ba<span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>很容易看出 <code class=\"language-text\">dataSync()</code> 是 Synchronously 的，會 block Browser 的 UI thread，直到 data 被你讀出。另外還有個 Asynchronously 的 <code class=\"language-text\">data()</code> method，會回傳 promise，當讀取結束時再呼叫 <code class=\"language-text\">resolves</code>。</p>\n<p>在我們的範例中，因為接下來要用 Highcharts 畫圖，我們需要 block 著 UI thread 等資料讀出後再繼續，因此採用 <code class=\"language-text\">dataSync()</code>。</p>\n<p>取出係數的值後，就能夠畫圖啦～</p>\n<p>根據算出的係數，畫出線條頭尾兩點：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> dataLine <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token number\">22</span> <span class=\"token operator\">*</span> awPredict <span class=\"token operator\">+</span> baPredict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">35</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token number\">35</span> <span class=\"token operator\">*</span> awPredict <span class=\"token operator\">+</span> baPredict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>然後用 HighCharts 繪圖：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        text<span class=\"token operator\">:</span> <span class=\"token string\">'deeplearn.js  最高溫與紅茶銷售量'</span>                 \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    xAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        text<span class=\"token operator\">:</span> <span class=\"token string\">'氣溫'</span>                 \n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      min<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n      max<span class=\"token operator\">:</span> <span class=\"token number\">40</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    yAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        text<span class=\"token operator\">:</span> <span class=\"token string\">'銷售量'</span>                 \n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      min<span class=\"token operator\">:</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span>\n      max<span class=\"token operator\">:</span> <span class=\"token number\">100</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'predict line'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> dataLine\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  \n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'dataset'</span><span class=\"token punctuation\">,</span>\n            marker<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                symbol<span class=\"token operator\">:</span> <span class=\"token string\">'cross'</span><span class=\"token punctuation\">,</span>  \n                radius<span class=\"token operator\">:</span> <span class=\"token number\">4</span>         \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> dataset\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// 繪製圖表</span>\n<span class=\"token keyword\">const</span> chart <span class=\"token operator\">=</span> Highcharts<span class=\"token punctuation\">.</span><span class=\"token function\">chart</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"最終成果\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%B5%82%E6%88%90%E6%9E%9C\" aria-label=\"最終成果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最終成果</h2>\n<p data-height=\"472\" data-theme-id=\"dark\" data-slug-hash=\"dmPZdj\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"DeeplearnJS-simple-linear\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/dmPZdj/\">DeeplearnJS-simple-linear</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>初次使用 deeplearn.js 其實主要門檻還是在於對 Machine Learning 的了解不夠，我有稍微比對一下用 python 與 R 的做法，其實都很雷同，包含資料向量的概念都是，加上很多演算法在這些語言的 library 中都有內建，相信對 ML 與 DL 有深入了解的人來學習 deeplearn.js 會更得心應手。deeplearn.js 畢竟有 Google 支持，也支援 TensorFlow 的 modal，還是很值得投資學習的，想想未來能用別人的 browser 來 training 你的 modal 有多好啊！喔不，是想想未來 Web 能因此有更多的發展潛力，多好呀！</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://github.com/PAIR-code/deeplearnjs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub Deeplearnjs</a></li>\n<li><a href=\"https://deeplearnjs.org/docs/api/index.html#dl.train.sgd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Deeplearn js API doc</a></li>\n<li><a href=\"https://ithelp.ithome.com.tw/articles/10186905\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">機器學習 玩具資料與線性迴歸</a></li>\n<li><a href=\"https://blog.gtwang.org/statistics/standford-machine-learning-1/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">史丹佛大學機器學習（Machine Learning）上課筆記</a></li>\n<li><a href=\"http://blog.csdn.net/ns2250225/article/details/79414790\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">deeplearn.js的線性迴歸</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s/X0k2JPze7x8nkSxkoHtWnw\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">8 大JavaScript 機器學習框架之探索</a></li>\n</ol>","fields":{"slug":"deeplearnjs-simple-linear-regression"},"frontmatter":{"title":"用 Javascript 進行簡單線性迴歸分析","date":"03-10-2018","tags":["deeplearnjs","machine learning","linear-regression","javascript"]},"timeToRead":10}},"pageContext":{"slug":"deeplearnjs-simple-linear-regression","prev":{"excerpt":"好歌分享：Oh Girl","html":"<blockquote>\n<p>好歌分享：<a href=\"https://youtu.be/IjSHmuEY9OQ\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Oh Girl</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/IjSHmuEY9OQ\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>身為工程師，想辦法提高自己的工作效率是一件很重要的事情，<del>畢竟這樣才有多餘的時間打電動</del>，除了平時加強各種知識與累積經驗外，撰寫工具的能力也值得培養。剛好在前不久，公司舉辦了一次內部的 hackday，我就利用這個時間針對公司內部的 framework 寫了一個簡單的 chrome devtools 的 extension，增加開發上的便利性。而在開發的過程中，發現關於 Chrome devtools extension 的文章並不是很多，中文的更少。總之，雖然<a href=\"https://developer.chrome.com/extensions/devtools\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文件</a>該有的都有，但跟 vscode extension 的文件比起來就是差了很多，光是排版就讓人不太想閱讀...\n因此希望藉此篇文章介紹開發 chrome devtools extension 的方法與一些注意事項。（註：可能需要先有點 Chrome extension 的相關知識會比較好懂） </p>\n<p>先給大家看其中一個範例（共有兩個），主要是能自動將 DOM 物件的 element inline style 轉化為 <a href=\"https://acss.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Atomic CSS</a> 的 class 名稱（<a href=\"https://blog.techbridge.cc/2017/04/29/css-methodology-atomiccss/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">不知道 Atomic CSS 的可以看這篇</a>），如此一來，在 Inspector 中調整完 style 後，就能直接將轉換好的 Atomic CSS 複製貼上到 code 當中，省去一次自己轉換的時間（有時還會忘記 class name...）</p>\n<p><img src=\"/image/devtools-acss-demo.gif\" alt=\"Sidebar Demo\"></p>\n<h1 id=\"chrome-devtools-extension-基本介紹\" style=\"position:relative;\"><a href=\"#chrome-devtools-extension-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9\" aria-label=\"chrome devtools extension 基本介紹 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chrome devtools extension 基本介紹</h1>\n<p>有開發過 Chrome extension 的人應該都知道，我們會有所謂的 <code class=\"language-text\">Content Script</code> 與 <code class=\"language-text\">Background page</code> 兩種不同的 context 存在於我們的 extension 中，而 <code class=\"language-text\">Devtools page</code> 也是一個獨立的 context，從下面這張官方圖可以很清楚的看到其之間的差異：</p>\n<p><img src=\"/image/devtools-extension-overview.png\" alt=\"官方圖片\"></p>\n<ul>\n<li>Content Script: 可以存取實際頁面的 DOM 物件與事件。</li>\n<li>Background page: 可以調用多數 extension API，像是 <code class=\"language-text\">chrome.runtime.*</code> 與 <code class=\"language-text\">chrome.tabs.onUpdated</code>，並負責 extension 與 Content script、Devtools page 之間的溝通。</li>\n<li>Devtools page: 可以調用 <code class=\"language-text\">chrome.extensions.*</code> 與 <code class=\"language-text\">chrome.devtools.*</code> Devtools API，其他的就都無法存取。可以透過 <code class=\"language-text\">chrome.devtools.inspectedWindow.eval</code> 能與目前開啟 inspector 的頁面互動。</li>\n</ul>\n<p>與一般 Extension 不同的地方就在於多了 Devtools API 需要了解，而主要的 Devtools API 其實也只有三種：</p>\n<h3 id=\"1-chromedevtoolsinspectedwindow\" style=\"position:relative;\"><a href=\"#1-chromedevtoolsinspectedwindow\" aria-label=\"1 chromedevtoolsinspectedwindow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. chrome.devtools.inspectedWindow</h3>\n<p>透過 <code class=\"language-text\">inspectedWindow.eval</code> 可以在當前開啟 inspector 的頁面 context 執行 javascript：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"window.$0.style.cssText\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// result 為 window.$0.style.cssText</span>\n    <span class=\"token comment\">// 在當前頁面的 context 下支執行結果 </span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"2-chromedevtoolsnetwork\" style=\"position:relative;\"><a href=\"#2-chromedevtoolsnetwork\" aria-label=\"2 chromedevtoolsnetwork permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. chrome.devtools.network</h3>\n<p>network api 可以取得你在 <code class=\"language-text\">Network panel</code> 看到的資訊。\n<img src=\"/image/devtools-networkpanel.png\" alt=\"network panel\"></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 取得當前開啟 inspector 的頁面所發出的 request 中，bodySize > 40*1024 的 url</span>\nchrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>network<span class=\"token punctuation\">.</span>onRequestFinished<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>bodySize <span class=\"token operator\">></span> <span class=\"token number\">40</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n              <span class=\"token string\">'console.log(\"Large request: \" + unescape(\"'</span> <span class=\"token operator\">+</span>\n              <span class=\"token function\">escape</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\"))'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"3-chromedevtoolspanels\" style=\"position:relative;\"><a href=\"#3-chromedevtoolspanels\" aria-label=\"3 chromedevtoolspanels permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. chrome.devtools.panels</h3>\n<p>panels api 應該是最重要的一塊了，因為我們必須透過它來創建 Panel 或 Sidebar。</p>\n<p><img src=\"/image/devtools-panel&#x26;sidebar.png\" alt=\"panel-sidebar\"></p>\n<p>Chrome devtools 的 extension UI 基本上就是分為上面這兩種類型，與上方 <code class=\"language-text\">Elements</code>、<code class=\"language-text\">Network</code> 和 <code class=\"language-text\">Sources</code> 同 Level 的稱為 Panel，而在每個 Panel 底下還可以另外創建 Sidebar，像是 Elements panel 右邊的 <code class=\"language-text\">style sidebar</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>panels<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Simple Panel\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"logo.png\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Panel.html\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">panel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// code invoked on panel creation</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>看完這些 API 應該也是一頭霧水，也不清楚到底要在哪裡呼叫，別急，接下來會針對這兩種 UI 個別實作一個範例來說明。</p>\n<h1 id=\"chrome-devtools-extension---sidebar-實作\" style=\"position:relative;\"><a href=\"#chrome-devtools-extension---sidebar-%E5%AF%A6%E4%BD%9C\" aria-label=\"chrome devtools extension   sidebar 實作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chrome devtools extension - Sidebar 實作</h1>\n<p>開頭的範例中，就是採取 Sidebar 的 UI，屬於 <code class=\"language-text\">ElementPanel</code> 底下的 sidebar。</p>\n<p>接著先看一下我們的檔案結構：</p>\n<img src=\"/image/devtools-foldr-structure.png\" style=\"width:50%;height:50%\">\n<p>很簡單，重點只有三個檔案，ruleMap.js 是跟 Atomic CSS 相關的 mapping 檔案，這邊不需要理會：</p>\n<h3 id=\"1-manifestjson\" style=\"position:relative;\"><a href=\"#1-manifestjson\" aria-label=\"1 manifestjson permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. manifest.json</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Atomic CSS Devtool\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"devtool extension for making Acss users happier\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"devtools_page\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"devtools.html\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"manifest_version\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>  跟一般 extension 一樣，要在 manifest.json 中做相對應設定，既然是開發 Devtools extension，自然就要註冊 <code class=\"language-text\">devtools_page</code>，指定為 devtools.html，這份 html 就是用來載入相關 js 的入口頁面。</p>\n<h3 id=\"2-devtoolshtml\" style=\"position:relative;\"><a href=\"#2-devtoolshtml\" aria-label=\"2 devtoolshtml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. devtools.html</h3>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ruleMap.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>devtools.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>  內容非常簡單，載入整個 devtools extension 需要的 javascript 檔案。如果你在 devtools.js 中有其他需要使用的 lib，也請記得在這個地方進行載入，像是 lodash 等等。\n但若你要載入非本地端的 javascript（透過 cdn 之類），會遇到 CSP(content security policy) 的錯誤，在 <a href=\"#notice\">注意事項</a> 中我會再說明解法。</p>\n<h3 id=\"3-devtoolsjs\" style=\"position:relative;\"><a href=\"#3-devtoolsjs\" aria-label=\"3 devtoolsjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. devtools.js</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>panels<span class=\"token punctuation\">.</span>elements<span class=\"token punctuation\">.</span><span class=\"token function\">createSidebarPane</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">\"acss class\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sidebar</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// The function below is executed in the context of the inspected page.</span>\n        <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">page_generateAtomicClass</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">selectedElementCssText</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// generate Atomic CSS</span>\n          <span class=\"token comment\">// 略...</span>\n          <span class=\"token keyword\">return</span> styleMap<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">function</span> <span class=\"token function\">updateElementProperties</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">acssClass</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          sidebar<span class=\"token punctuation\">.</span><span class=\"token function\">setObject</span><span class=\"token punctuation\">(</span>acssClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">getAcssClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"window.$0.style.cssText\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> isException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">const</span> selectedElementCssText <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">const</span> acssClass <span class=\"token operator\">=</span> <span class=\"token function\">page_generateAtomicClass</span><span class=\"token punctuation\">(</span>selectedElementCssText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">updateElementProperties</span><span class=\"token punctuation\">(</span>acssClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>panels<span class=\"token punctuation\">.</span>\n          elements<span class=\"token punctuation\">.</span>onSelectionChanged<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>getAcssClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">getAcssClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>devtool.js 就比較複雜了，所有主要功能都發生在這裡。</p>\n<p>首先，我們利用 <code class=\"language-text\">chrome.devtools.panels.elements.createSidebarPane(sidebarTitle, callbackFunc)</code> 來創建 Sidebar，在 callback 中我們會拿到一個 <code class=\"language-text\">sidebar</code> 物件，此物件是我們與右邊這個 sidebar 區塊互動的媒介，有四種 method 可以使用：</p>\n<ul>\n<li>\n<p>sidebar.setObject()\n我們範例中就是使用 <code class=\"language-text\">setObject()</code> 來將運算完的資料（轉換後的 atomic css classname）傳到 sidebar 顯示，他會將傳入的 Object 展開：</p>\n<p><img src=\"/image/devtools-setobj.png\" alt=\"setObject\"></p>\n</li>\n<li>\n<p>sidebar.setPage() 與 sidebar.setHeight()\n若是覺得光是顯示 JS 的 Object 太單調，你也可以利用 <code class=\"language-text\">setPage()</code> 搭配 <code class=\"language-text\">setHeight()</code> 來在 sidebar 中塞入一個 html。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>panels<span class=\"token punctuation\">.</span>elements<span class=\"token punctuation\">.</span><span class=\"token function\">createSidebarPane</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Atomic Css\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sidebar</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sidebar<span class=\"token punctuation\">.</span><span class=\"token function\">setPage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sidebar.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sidebar<span class=\"token punctuation\">.</span><span class=\"token function\">setHeight</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"8ex\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Sidebar.html 中，可以自由繪製畫面，但要注意的是，你是在 sidebar 的 context 中，不能取得當前頁面的 DOM 物件資料，需要的話得透過 background.js 以 <code class=\"language-text\">postMessage</code> 來傳遞，我們最後還會提到。</p>\n</li>\n<li>\n<p>sidebar.setExpression()\n除了 <code class=\"language-text\">setObject</code> 以外，我們也能夠過 <code class=\"language-text\">setExpression</code> 直接 <code class=\"language-text\">eval()</code> js code 到當前的 inspected page。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  sidebar<span class=\"token punctuation\">.</span><span class=\"token function\">setExpression</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(\"</span> <span class=\"token operator\">+</span> page_generateAtomicClass<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\")()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>使用方法有點特殊，因為是 eval 的方式，你需要把函式 toString() 後再傳入，此外，在傳入的 <code class=\"language-text\">page_generateAtomicClass()</code> 中，你可以取得當前 inspected 頁面的資訊！\n例如：$0 (Chrome devtools 中特殊的變數，等同於 Element panel 中你目前選取的元素 DOM)。\n官方文件中 setExpression 還能傳入一個 callback，但是我怎麼傳都會有 Error 就是了...</p>\n</li>\n</ul>\n<p>接著，我用 <code class=\"language-text\">chrome.devtools.inspectedWindow.eval(\"window.$0.style.cssText\", callback);</code> 的方式去取得 selected element 的 css 資訊，接著在 callback 中將其傳給 <code class=\"language-text\">page_generateAtomicClass()</code> 做運算，最後用 <code class=\"language-text\">sidebar.setObject()</code> 將結果輸出。</p>\n<p>等等，你不是說 <code class=\"language-text\">sidebar.setExpression</code> 就能直接取得 <code class=\"language-text\">$0</code> 了嗎？何必多此一舉？</p>\n<p>原因很簡單，因為在 <code class=\"language-text\">setExpression</code> 傳入的 function 中，你取不到 devtools.js 中的 context，所有你在 devtools.html 中 include 的 js 都無法取得，像是我需要用來轉換 Atomic css 的 <code class=\"language-text\">ruleMap.js</code> 就無法拿到，只好採此作法。在實作時需要特別注意 context 的問題！</p>\n<p>最後，我們註冊一個 <code class=\"language-text\">onSelectionChanged</code> 監聽事件 <code class=\"language-text\">chrome.devtools.panels.elements.onSelectionChanged.addListener(getAcssClass);</code>，只要選擇別的 elements 時就重新執行。</p>\n<p>到這邊為止，你就能夠做出如同一開始範例所展現功能的 Devtools extension 了！</p>\n<h1 id=\"chrome-devtools-extension---panel-實作\" style=\"position:relative;\"><a href=\"#chrome-devtools-extension---panel-%E5%AF%A6%E4%BD%9C\" aria-label=\"chrome devtools extension   panel 實作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chrome devtools extension - Panel 實作</h1>\n<p>這個範例是實作 Panel UI 的 extension，這邊我將功能降之最低，單純抓出目前頁面的 Page title，目的在展示如何將不同 context 的資訊呈現在 Devtools 的 Panel 中。</p>\n<p><img src=\"/image/devtools-panel-demo.gif\" alt=\"Panel Demo\"></p>\n<p>一樣先來看檔案結構：</p>\n<img src=\"/image/devtools-panel-structure.png\" style=\"width:50%;height:50%\">\n<p>可以看到基本上跟前一個範例差不多，只是多了 <code class=\"language-text\">Panel.html</code> 與 <code class=\"language-text\">background.js</code> 兩個檔案。</p>\n<p>另外的差別在於 <code class=\"language-text\">devtools.js</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"document.title\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> isException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isException <span class=\"token operator\">&amp;&amp;</span> result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>panels<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Panel Demo\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"logo.png\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"Panel.html\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">panel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// code invoked on panel creation</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>有別於前一個範例我們都將程式邏輯寫在 <code class=\"language-text\">devtools.js</code> 中，這次我們只在這邊進行創建 panel 的程式，可以從上面程式碼中看到，我們創建了一個 Title 叫做 \"Panel Demo\" 的 panel，並告訴 chrome devtool 是要用 <code class=\"language-text\">Panel.html</code> 這份檔案。</p>\n<p>在 <code class=\"language-text\">Panel.html</code> 中，我們載入主要程式邏輯 <code class=\"language-text\">getPageTitle.js</code>，你也可以看到，這邊就是繪製 Panel 的地方，因此可以載入 bootstrap 等 css style 來輔助。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">integrity</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">crossorigin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>anonymous<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>app<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>container mt-3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>getPageTitle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>接著來看主要程式邏輯，<code class=\"language-text\">getPageTitle.js</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 與 background.js 建立 channel 連結</span>\n  <span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> chrome<span class=\"token punctuation\">.</span>extension<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      name<span class=\"token operator\">:</span> <span class=\"token string\">\"Devtools.js Communication\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> inspectedWindowId <span class=\"token operator\">=</span> chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span>tabId<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Listen to messages from the background page</span>\n  port<span class=\"token punctuation\">.</span>onMessage<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>action <span class=\"token operator\">===</span> <span class=\"token string\">\"reloadExtension\"</span> <span class=\"token operator\">&amp;&amp;</span> message<span class=\"token punctuation\">.</span>updatedTabId <span class=\"token operator\">===</span> inspectedWindowId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> appNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">removeHTMLChilds</span><span class=\"token punctuation\">(</span>appNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">getPageTitle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">getPageTitle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      chrome<span class=\"token punctuation\">.</span>devtools<span class=\"token punctuation\">.</span>inspectedWindow<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">\"document.title\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">,</span> isException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> appNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> titleWrapper <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> title <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n              titleWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              appNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">removeHTMLChilds</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">HTMLNode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>HTMLNode<span class=\"token punctuation\">.</span>firstChild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          HTMLNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>HTMLNode<span class=\"token punctuation\">.</span>firstChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// init</span>\n  <span class=\"token function\">getPageTitle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>我們利用 <code class=\"language-text\">chrome.devtools.inspectedWindow.eval()</code> 來執行 <code class=\"language-text\">document.title</code>，取得 page title 資訊，並利用 <code class=\"language-text\">document.createElement</code> 等原生 Web API 來將資訊呈現在頁面上。</p>\n<p>接著這邊我們用到了 <code class=\"language-text\">port.onMessage.addListener()</code>，原因是我們想要 monitor 頁面的變化，像是 page reload 或是 page update。而這些資訊都只能透過 <code class=\"language-text\">content script</code> 或是 <code class=\"language-text\">Background.js</code> 才能取得，因此我們必須建立一個 messaging 的 channel，讓 <code class=\"language-text\">background.js</code> 告訴我們頁面是否更新了，若更新就重新繪製 <code class=\"language-text\">Panel.html</code> 的內容。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsbackground.js\"><pre class=\"language-jsbackground.js\"><code class=\"language-jsbackground.js\">chrome.runtime.onConnect.addListener(function (port) {\n    chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {\n        if (changeInfo.status === &#39;complete&#39;) {\n            reloadExtension(port, tabId);\n        }\n    });\n    function reloadExtension(port, tabId) {\n        const message = { action: &quot;reloadExtension&quot;, updatedTabId: tabId };\n        port.postMessage(message);\n    }\n});\n// `background.js` 透過 `chrome.runtime.onConnect.addListener`\n// 在與 devtools page 的 script 連接到後，監聽 `chrome.tabs.onUpdated` 事件，\n// 當 update status 為 complete 後，`postMessage()` 給 `Panel.html` 中的 `getPageTitle.js`。</code></pre></div>\n<p>此外，由於 <code class=\"language-text\">Background.js</code> 存在於整個 Browser 中，因此在 <code class=\"language-text\">getPageTitle.js</code> 中，需要透過 <code class=\"language-text\">const inspectedWindowId = chrome.devtools.inspectedWindow.tabId;</code> 取得當前 inspected page 的 tab id 來過濾其他 tab 的 event change。</p>\n<p>就這樣我們就完成了一個可以取得頁面 Title 的 Devtools extension！雖然功能超廢但要是希望讓大家有個概念，知道要怎麼開始。\n基本上所有程式碼都在這邊了，但如果還是想直接載範例 code 來看的話可以移駕至 github，但只是 demo 用就是了...<a href=\"https://github.com/ArvinH/acss_devtool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Demo 1</a> <a href=\"https://github.com/ArvinH/chrome-devtools-extension-panelDemo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Demo 2</a>\n<span id=\"notice\"></span></p>\n<h1 id=\"注意事項\" style=\"position:relative;\"><a href=\"#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85\" aria-label=\"注意事項 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>注意事項</h1>\n<p>在 hackday 開發內部工具時其實踩到不少雷，而在上述的範例中比較難去說明，因此在文章的最後額外與大家分享：</p>\n<ol>\n<li>\n<p>載入外部檔案的方式\n雖然在 <code class=\"language-text\">devtools.html</code> 或 <code class=\"language-text\">Panel.html</code> 中可以載入除了 <code class=\"language-text\">devtools.js</code> 外的檔案，但若是載入的檔案中存有 <code class=\"language-text\">eval()</code> 或著是透過 web 下載的 js，都會出現 CSP(content ecurity policy) 錯誤，而解法是在 <code class=\"language-text\">manifest.json</code> 中加上一行：\n\"content<em>security</em>policy\": \"script-src 'self' 'unsafe-eval'; object-src 'self'\"\n這樣就能解決 js 中存有 <code class=\"language-text\">eval()</code> 或是 <code class=\"language-text\">setTimeout()</code> 所造成的 CSP error </p>\n<p>而若要載外部資源，則還要另外將其 domain 也加進去，當作 white list\n\"content<em>security</em>policy\": \"script-src 'self' 'unsafe-eval' <a href=\"https://maps.googleapis.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://maps.googleapis.com/</a>; object-src 'self'\"</p>\n</li>\n<li>chrome.devtools.inspectedWindow.eval 長度限制\n在製作內部工具時，其實是需要從 inspected page 的 context 中取出大量資料到 Panel.html 中進行處理，而透過 <code class=\"language-text\">inspectedWindow.eval</code> 的方式並沒有辦法傳送太大量的 JSON object，因此我是先將其 <code class=\"language-text\">JSON.stringify()</code> 後才往後傳的。 eg. <code class=\"language-text\">chrome.devtools.inspectedWindow.eval( \"JSON.stringify(context.getStore())\"</code>。</li>\n</ol>\n<h1 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h1>\n<p>今天透過兩種範例介紹了如何用最主要的 Devtools API 來搭建 Devtools extension，但當然還有許多 API 或是 Event 沒有介紹到，像 panels 就有 <code class=\"language-text\">onShown</code>, <code class=\"language-text\">onHide</code> 等監聽 devtools 是否有開啟的事件可以用，不過很難從一次的範例中全部介紹到，有需要的話還是得去查看官方文件。至少希望能讓大家對於製作增加自己工作效率的工具有一個初步的開始方向，有任何問題也歡迎提出指教！</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://developer.chrome.com/extensions/devtools\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google offical doc</a></li>\n<li><a href=\"https://div.io/topic/1669\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Chrome Extension CSP 開發小記</a></li>\n<li><a href=\"http://www.360doc.com/content/17/1212/14/26662048_712402137.shtml\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Chrome 插件(擴展)全攻略</a></li>\n</ol>","id":"4828b7b5-f26b-5561-8545-bf6db284bc7c","fields":{"slug":"chrome-devtool-extension"},"frontmatter":{"date":"2018-02-10T11:04:27.000Z","title":"Chrome devtools extension 實作介紹","tags":["Chrome","devtools","extension"],"type":"tech","slug":"chrome-devtool-extension"},"timeToRead":11},"next":{"excerpt":"\"The cure for fate is patience.\"","html":"<blockquote>\n<p>\"The cure for fate is patience.\"</p>\n</blockquote>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>上一篇<a href=\"https://blog.techbridge.cc/2018/03/10/deeplearnjs-simple-linear-regression/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文章</a>中，我們利用 Deeplearn.js 學習了 linear regression，從氣溫與紅茶的關聯性中預測銷量，這次就來練習在機器學習中另一個很基本的方法 - Logistic regression（邏輯分析）。</p>\n<p>先來張 Demo 成果圖：</p>\n<p><img src=\"/image/deeplearnjs-logistic.png\" alt=\"Demo\"> </p>\n<p>從成果圖中可以看出，所謂的 Logistic regression 與 Linear regression 最大不同就是，邏輯回歸大多用來進行<strong>分類</strong>，當結果只有兩種時，就是二元分類，當然也有多元分類，這邊以簡單二元分類來做練習。這次的範例參考自 <a href=\"https://blog.csdn.net/ns2250225/article/details/79416651\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">【webAI】deeplearn.js的邏輯回歸</a></p>\n<h2 id=\"出發總要有個方向做實驗總要有個想像\" style=\"position:relative;\"><a href=\"#%E5%87%BA%E7%99%BC%E7%B8%BD%E8%A6%81%E6%9C%89%E5%80%8B%E6%96%B9%E5%90%91%E5%81%9A%E5%AF%A6%E9%A9%97%E7%B8%BD%E8%A6%81%E6%9C%89%E5%80%8B%E6%83%B3%E5%83%8F\" aria-label=\"出發總要有個方向做實驗總要有個想像 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>出發總要有個方向，做實驗總要有個想像</h2>\n<p>還記得小時候剛了解智商的概念時，很喜歡去查查名人們的智商數字，像是愛因斯坦、前美國總統布希等等，想看看這些名人的智商是多少，是不是真的很聰明才能像他們這樣成功。\n今天假設我們有一群人的智商資料，現在想要利用這些資料分割出聰明人與笨蛋兩個分類，讓我們之後可以用來判斷一個人是聰明的率高一些，或是愚昧機率高一點，那我們該怎麼做呢？</p>\n<p>這時候就可以出動 Logistic regression 來幫我們計算出一個預測模型，用來判斷該人的智商屬於哪個分類的機率比較高。</p>\n<p>以迴歸分析來說，我們是希望能由給定一個固定的解釋變數 X，然後求出目標變數 Y 的平均值，是條件期望值的概念，若 Y 的結果是連續性的，我們就能試著透過線性模型去逼近一個剛好符合所有資料的公式。像是上一次的範例中，我們可以用線性模型求出在各種溫度下，紅茶的銷售狀況大約會是多少。</p>\n<p>但有些時候，想求得的目標變數是二元或是多元的變數，像是剛剛例子中的<strong>聰明</strong> 或 <strong>笨蛋</strong>。如果硬要用線性函數去逼近的話，求得的結果通常會很差，像是下圖這般：</p>\n<p><img src=\"/image/logistic-linear-bad.png\" alt=\"linear regression\">\n(<a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">圖片來源</a>)</p>\n<p>所以才有人提出用 <a href=\"https://en.wikipedia.org/wiki/Sigmoid_function\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">sigmoid</code></a> 這個能將數值侷限在 0 與 1 之間的函數來解決這個問題：</p>\n<p><img src=\"/image/deeplearnjs-decision-boundary.png\" alt=\"Decision Boundary\"></p>\n<p>上圖就是一個 <code class=\"language-text\">sigmoid function</code>，假設我們今天判斷智商 180 代表機率 1 的狀況，而大於機率 0.6 時，就可以算是聰明人（黃色區域），而小於 0.6 的則屬於笨蛋（綠色區域），那今天我們的目標就是要找出一個 <code class=\"language-text\">Ｘ</code> 軸上的 <code class=\"language-text\">Z</code> 值，讓我們能根據 input 的 <code class=\"language-text\">X</code> 特徵值來判斷，若是 <code class=\"language-text\">X</code> 大於 <code class=\"language-text\">Z</code> 時，就可說他是聰明人（因為機率高於 0.6）。</p>\n<p>這個讓我們找出 <code class=\"language-text\">Z</code> 值的函數就是我們要找的 <code class=\"language-text\">Decision Boundary</code>，也就是開頭 Demo 圖中的那條黃色線段！</p>\n<p>有關於 Logistion regression 與 Decision Boundary 的詳細內容，我推薦大家閱讀這幾篇 blog，介紹得很簡單易懂：</p>\n<p><a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Machine Learning 學習日記</a>\n<a href=\"https://taweihuang.hpd.io/2017/12/22/logreg101/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">你可能不知道的邏輯迴歸</a></p>\n<h2 id=\"大概了解-logistic-後那就來利用-deeplearnjs-找出-decision-boundary-吧\" style=\"position:relative;\"><a href=\"#%E5%A4%A7%E6%A6%82%E4%BA%86%E8%A7%A3-logistic-%E5%BE%8C%E9%82%A3%E5%B0%B1%E4%BE%86%E5%88%A9%E7%94%A8-deeplearnjs-%E6%89%BE%E5%87%BA-decision-boundary-%E5%90%A7\" aria-label=\"大概了解 logistic 後那就來利用 deeplearnjs 找出 decision boundary 吧 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>大概了解 Logistic 後，那就來利用 deeplearn.js 找出 Decision Boundary 吧!</h2>\n<p>起手式，先來製作個假資料：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 建立假資料，1 代表智商 100 分以上，0 代表智商 100 分以下</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">200</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> tmpX1 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> tmpX2 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n    data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        x<span class=\"token operator\">:</span> tmpX1<span class=\"token punctuation\">,</span>\n        y<span class=\"token operator\">:</span> tmpX2<span class=\"token punctuation\">,</span>\n        c<span class=\"token operator\">:</span> tmpX1 <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> tmpX2 <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我們隨機產生 200 組 training data，<code class=\"language-text\">tmp_x</code> 與 <code class=\"language-text\">tmp_y</code> 可以當作我們要輸入的 Input 特徵 X 向量，代表一個人的智商以及他閱讀的書籍量。</p>\n<p>接著初始 deeplearn.js 的資料結構：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**\n * deeplearn.js 運算\n */</span>\n<span class=\"token keyword\">const</span> x_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> y_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> elem <span class=\"token keyword\">of</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    x_list<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    y_list<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> x_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor2d</span><span class=\"token punctuation\">(</span>x_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> y_data <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">tensor2d</span><span class=\"token punctuation\">(</span>y_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>再次介紹一下，在 deeplearn.js 中，tensor 是最核心的資料結構，用來表示向量、矩陣或是多維度的資料。</p>\n<p>有許多 utility function 可以輔助創建 tensor 資料結構，像是這邊用的是 <code class=\"language-text\">tensor2d</code>，也就是 2D (2-dimension) 的 tensor。</p>\n<p>一個 tensor 其實包含三個成分，也是創建 tensor 時可以傳入的參數：</p>\n<ul>\n<li>values (TypedArray|Array): tensor 的值。可以是 nested array 或 flat array 的結構。</li>\n<li>shape（number[]）:基本上就是該 tensor 的維度。若創建 tensor 時沒有指定維度，就會繼承傳入的 values 維度。也可以像這邊的範例一樣直接使用 <code class=\"language-text\">tensor${1|2|3|4}d</code> 來創建</li>\n<li>dtype（float32'|'int32'|'bool）：值的型別，當然是 optional。</li>\n</ul>\n<p>由於我們要計算的 X 都是一組向量，所以這邊使用 <code class=\"language-text\">dl.tensor2d</code> 來建置一個二維的 tensor。</p>\n<p>接著定義我們要 training 的係數，這邊取為 <code class=\"language-text\">W</code> 與 <code class=\"language-text\">B</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 權重 W 與偏差 B</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">W</span> <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">zeros</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">B</span> <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">variable</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">zeros</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dl.variable(initialValue, trainable?, name?, dtype?)</code> 用來創建 training 過程中需要的變數，也可透過參數指定該變數能否在 training 過程中被修改（trainable），預設是 <code class=\"language-text\">true</code>。</p>\n<p>用 <code class=\"language-text\">dl.zeros([1, 2])</code> 來創建一個 <code class=\"language-text\">Shape</code> 為 <code class=\"language-text\">[1,2]</code> 的填滿零值的 tensor 變數當權重 W，以及維度 1 的偏差變數 tensor B。</p>\n<p>再來需要定義目標函數與 loss function：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 定義目標函數 與 loss function （最一般的 mean square）</span>\n<span class=\"token comment\">// logistic regression 模型</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">f</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">x</span> <span class=\"token operator\">=></span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">sigmoid</span><span class=\"token punctuation\">(</span><span class=\"token constant\">W</span><span class=\"token punctuation\">.</span><span class=\"token function\">matMul</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span><span class=\"token function\">transpose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// loss function（log loss）</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loss</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pred<span class=\"token punctuation\">,</span> label</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">mean</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">neg</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>dl<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">,</span> dl<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>目標函數的部分其實就是帶入先前所提的 sigmoid function：</p>\n<p><img src=\"/image/deeplearnjs-sigmod.png\" alt=\"目標函數公式\"></p>\n<p><code class=\"language-text\">Z</code> 就是我們要找的 boundary，就是權重與 input X 向量做矩陣乘法，所以這裡需要轉置矩陣 <code class=\"language-text\">x.transpose()</code>。\n<code class=\"language-text\">dl.sigmoid()</code> 就是 deeplearn.js 提供的 sigmoid 函數（如上圖第二行）</p>\n<p>將 <code class=\"language-text\">Z</code> 帶入 <code class=\"language-text\">dl.sigmoid()</code> 後就獲得了目標函數 f。</p>\n<p>而 loss function 的話，一般在 logistic function 都是採用 log loss 的公式，詳細解釋與公式推導推薦閱讀此篇：\n<a href=\"https://www.codelast.com/%E5%8E%9F%E5%88%9B-%E7%94%A8%E4%BA%BA%E8%AF%9D%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84logistic-regression%EF%BC%88%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%EF%BC%89/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">用人話解釋機器學習中的 Logistic Regression</a></p>\n<p>照著公式很容易就可以帶出上述的 <code class=\"language-text\">loss()</code>。</p>\n<p>最後就可以開始 training 我們的 data 啦：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 梯度優化</span>\n<span class=\"token keyword\">const</span> learningRate <span class=\"token operator\">=</span> <span class=\"token number\">0.001</span>\n<span class=\"token keyword\">const</span> optimizer <span class=\"token operator\">=</span> dl<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">.</span><span class=\"token function\">sgd</span><span class=\"token punctuation\">(</span>learningRate<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Training!</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    optimizer<span class=\"token punctuation\">.</span><span class=\"token function\">minimize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">loss</span><span class=\"token punctuation\">(</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>x_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>跟上一篇 <a href=\"https://blog.techbridge.cc/2018/03/10/deeplearnjs-simple-linear-regression/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">linear regression</a> 相同，我們採用<code class=\"language-text\">dl.train.sgd</code>，是 deeplearn.js 內建的 sgd 演算法模型，接受一個 <code class=\"language-text\">leanring rate</code> 參數。在每一次的迭代中，係數都會不斷被更新，以找出最佳的結果，而這個 <code class=\"language-text\">learningRate</code> 參數是用來控制每一次的更新幅度。因此不能夠設得太大，也不能設得太小。</p>\n<p><code class=\"language-text\">optimizer</code> 可額外輸入兩個參數，分別控制 1. 是否回傳最後的 cost; 2. 限制只更新哪些變數。我們 for loop 1000 次後，利用 <code class=\"language-text\">dataSync()</code> 來將係數從 Tensor 讀出：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 用 dataSync 取得 training 結果</span>\n<span class=\"token keyword\">const</span> wPredict <span class=\"token operator\">=</span> <span class=\"token constant\">W</span><span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bPredict <span class=\"token operator\">=</span> <span class=\"token constant\">B</span><span class=\"token punctuation\">.</span><span class=\"token function\">dataSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>wPredict<span class=\"token punctuation\">,</span> bPredict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">dataSync()</code> 是 Synchronously 的，會 block Browser 的 UI thread，直到 data 被你讀出。另外還有個 Asynchronously 的 <code class=\"language-text\">data()</code> method，會回傳 promise，當讀取結束時再呼叫 <code class=\"language-text\">resolves</code>。</p>\n<p>因為接下來要用 Highcharts 畫圖，所以需要採用 <code class=\"language-text\">dataSync()</code> 來 block 著 UI thread 等資料讀出後再繼續。</p>\n<p>取出係數的值後，就能算出一條 <code class=\"language-text\">Decision Boundary</code> 並繪製出來！</p>\n<p>根據算出的係數，畫出線條頭尾兩點：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 計算切割線段</span>\n<span class=\"token keyword\">const</span> data_line <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">180</span> <span class=\"token operator\">*</span> wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">180</span><span class=\"token punctuation\">,</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">*</span> wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bPredict<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>wPredict<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data_line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>然後用 HighCharts 繪圖：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 繪製圖形</span>\n<span class=\"token keyword\">const</span> data_scatter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data_scatter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> elem <span class=\"token keyword\">of</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>x <span class=\"token operator\">></span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> elem<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        data_scatter1<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        data_scatter2<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>elem<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n        \n<span class=\"token comment\">// Result</span>\n<span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        text<span class=\"token operator\">:</span> <span class=\"token string\">'deeplearn.js 你是聰明人嗎？'</span>                 \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    xAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> <span class=\"token string\">'智商'</span>                 \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        min<span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        max<span class=\"token operator\">:</span> <span class=\"token number\">180</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    yAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> <span class=\"token string\">'書讀得多寡'</span>                 \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        min<span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        max<span class=\"token operator\">:</span> <span class=\"token number\">180</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Decision Boundary'</span><span class=\"token punctuation\">,</span> \n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#fff600'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_line\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  \n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Smart'</span><span class=\"token punctuation\">,</span> \n            marker<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                symbol<span class=\"token operator\">:</span> <span class=\"token string\">'cross'</span><span class=\"token punctuation\">,</span>  \n                radius<span class=\"token operator\">:</span> <span class=\"token number\">4</span>         \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#FF0000'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_scatter1\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n            type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">'Stupid'</span><span class=\"token punctuation\">,</span>\n            marker<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                symbol<span class=\"token operator\">:</span> <span class=\"token string\">'cross'</span><span class=\"token punctuation\">,</span>  \n                radius<span class=\"token operator\">:</span> <span class=\"token number\">4</span>         \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            color<span class=\"token operator\">:</span> <span class=\"token string\">'#6B8E23'</span><span class=\"token punctuation\">,</span>\n            data<span class=\"token operator\">:</span> data_scatter2\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 图表初始化函数</span>\n<span class=\"token keyword\">const</span> chart <span class=\"token operator\">=</span> Highcharts<span class=\"token punctuation\">.</span><span class=\"token function\">chart</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"最終成果\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%B5%82%E6%88%90%E6%9E%9C\" aria-label=\"最終成果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最終成果</h2>\n<p data-height=\"469\" data-theme-id=\"29194\" data-slug-hash=\"NYwZwv\" data-default-tab=\"result\" data-user=\"arvin0731\" data-embed-version=\"2\" data-pen-title=\"DeeplearnJS-logistic-regression\" class=\"codepen\">See the Pen <a href=\"https://codepen.io/arvin0731/pen/NYwZwv/\">DeeplearnJS-logistic-regression</a> by Arvin (<a href=\"https://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"https://codepen.io\">CodePen</a>.</p>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>再次使用 deeplearn.js 來實作 Machine Learing 演算法，發現真的要套用這些 library 已經非常容易了，但還是受限於對演算法與數學公式的理解與敏銳度，不過也是透過這樣的實作練習，逼迫自己去嘗試了解這些演算法背後的概念與數學，在過程中也不斷想起以前大學修離散數學的記憶，當時都不太懂要怎麼使用這些數學，現在知道後就能讀得津津有味，也是蠻有意思的！</p>\n<!-- 資料來源 -->\n<h2 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h2>\n<ol>\n<li><a href=\"https://blog.csdn.net/ns2250225/article/details/79416651\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">【webAI】deeplearn.js的邏輯回歸</a></li>\n<li><a href=\"https://github.com/PAIR-code/deeplearnjs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub Deeplearnjs</a></li>\n<li><a href=\"https://deeplearnjs.org/docs/api/index.html#dl.train.sgd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Deeplearn js API doc</a></li>\n<li><a href=\"https://www.codelast.com/%E5%8E%9F%E5%88%9B-%E7%94%A8%E4%BA%BA%E8%AF%9D%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84logistic-regression%EF%BC%88%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%EF%BC%89/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">用人話解釋機器學習中的 Logistic Regression</a></li>\n<li><a href=\"https://medium.com/@ken90242/machine-learning%E5%AD%B8%E7%BF%92%E6%97%A5%E8%A8%98-coursera%E7%AF%87-week-3-1-logistic-12346f40c6d6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Machine Learning 學習日記</a></li>\n<li><a href=\"https://taweihuang.hpd.io/2017/12/22/logreg101/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">你可能不知道的邏輯迴歸</a></li>\n<li><a href=\"https://medium.com/@chih.sheng.huang821/%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92-%E6%94%AF%E6%92%90%E5%90%91%E9%87%8F%E6%A9%9F-support-vector-machine-svm-%E8%A9%B3%E7%B4%B0%E6%8E%A8%E5%B0%8E-c320098a3d2e\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">機器學習-支撐向量機(support vector machine, SVM)詳細推導</a></li>\n</ol>","id":"9b284547-b3ce-573f-8f98-f23bd33522a3","fields":{"slug":"deeplearnjs-logistic-regression"},"frontmatter":{"date":"2018-03-30T20:00:08.000Z","title":"用 Javascript 進行邏輯迴歸分析","tags":["deeplearnjs","machine learning","logistic-regression","javascript"],"type":"tech","slug":"deeplearnjs-logistic-regression"},"timeToRead":10},"type":"tech"}},"staticQueryHashes":["2123680655"]}