{"componentChunkName":"component---src-templates-tag-tsx","path":"/tags/google-calendar-api","result":{"pageContext":{"posts":[{"excerpt":"好歌分享：Surfing day feat.秋僧","html":"<blockquote>\n<p>好歌分享：<a href=\"https://youtu.be/DaBdf8ULeiA\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Surfing day feat.秋僧</a></p>\n</blockquote>\n<iframe width=\"100%\" height=\"315\" src=\"https://www.youtube.com/embed/DaBdf8ULeiA\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n<!-- more -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>大概是在 2016 年底的時候，我整個人的心理狀態很糟，一直覺得自己對生活的掌控力非常低落，庸庸碌碌的過著每一天，卻不曉得自己的目標在哪，對什麼都興致缺缺，似乎把生活遺失了。</p>\n<p>我試著想從過往日常生活中的所作所為來找出一些癥結點，結果發現記憶有限，越想越覺得自己好像什麼都沒完成，接著就進入無止盡的負面迴圈...</p>\n<p>為了打破這樣的心理狀態，我從 2017 年的一月開始記錄自己每天的生活，將一整天所做的事項記錄在 Google Calendar 中，有了這樣的紀錄後，我每週都會回顧一下自己這一整個星期所做的事情，花在工作、運動、娛樂、學習等等的時間如何，讓自己在負面情緒滿漲時，能看看自己其實還是達成了不少事，同時也能隨時警惕自己在時間管理與各種事項間的分配是否有需要調整的部分。</p>\n<p>好啦，說穿了就是用 Google Calendar 寫日記。</p>\n<p>而現在又接近年底了，在這近乎一年的紀錄中，我想應該可以來做個 Year End Review，利用 D3 來幫助我將記錄在 Google Calendar 上的資料視覺化出來！</p>\n<p>大致的想法是將不同分類的資料整理出來，然後看看 <strong><em>我在這一年當中，每一天花在每一個類別的事項的 Heat Map</em></strong> 會是長什麼樣子，並加上簡單的 Select box 方便切換。</p>\n<p>成果截圖如下：</p>\n<p><img src=\"/image/arvin-yerr-calendar.png\" alt=\"YERR\"></p>\n<p>有興趣的可以連結到 <a href=\"https://bl.ocks.org/ArvinH/56909246bd584743fa5ee7ad148ad1ac\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bl.ocks 看 Demo 與完整的程式碼</a></p>\n<h1 id=\"資料視覺化的第一步當然是取得資料\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E8%A6%96%E8%A6%BA%E5%8C%96%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AD%A5%E7%95%B6%E7%84%B6%E6%98%AF%E5%8F%96%E5%BE%97%E8%B3%87%E6%96%99\" aria-label=\"資料視覺化的第一步當然是取得資料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料視覺化的第一步，當然是取得資料</h1>\n<p>Google 存了多少資料想必大家都心知肚明，而他老大哥也是願意把我們的資料還給我們，只要連結到 <a href=\"https://takeout.google.com/settings/takeout\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Takeout</a> 就可以將你在 Google 服務上的資料副本下載下來：</p>\n<p><img src=\"/image/google-takeout.png\" alt=\"Google Takeout\"></p>\n<p>既然我要視覺化我在 Google Calendar 上的資料，當然就是選取 Calendar 來下載：</p>\n<p><img src=\"/image/google_calendar_details.png\" alt=\"Google Calendar download\"></p>\n<p>或著，你也能直接從 Google Calendar 匯出你的日曆：</p>\n<p><img src=\"/image/google_calendar_export.png\" alt=\"Export from Google Calendar\"></p>\n<p>仔細看一下，這兩種方式下載到的資料其格式都是 <a href=\"https://zh.wikipedia.org/wiki/ICalendar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">iCalendar</code></a>。</p>\n<p>是 <code class=\"language-text\">iCalendar</code> 又如何呢？通用的標準格式不是很好嗎？代表我之後若換成 Apple 的 iCal，我這次的專案也能套用上去耶！</p>\n<p>But!</p>\n<p>在我當初紀錄日曆時，我每一項 item 的資訊很少，就只是單純的填入 Summary，並且依照分類給予顏色。</p>\n<p>而在 <code class=\"language-text\">iCalendar</code> 的標準中，並沒有 Google Calendar 的顏色資訊，所以我只好忍痛放棄這條方便的道路...（這告訴我們做事還是不能太懶）</p>\n<p>iCalendar 的內容大概長這樣，以 <code class=\"language-text\">BEGIN:VEVENT</code> 開始，<code class=\"language-text\">END:VEVENT</code> 為止：</p>\n<div class=\"gatsby-highlight\" data-language=\"ics\"><pre class=\"language-ics\"><code class=\"language-ics\">BEGIN:VEVENT\nDTSTART;VALUE=DATE:20171209\nDTEND;VALUE=DATE:20171210\nDTSTAMP:20171210T075750Z\nUID:839skadkfcd03812j3f0c030s0s@google.com\nCREATED:20171210T024308Z\nDESCRIPTION:\nLAST-MODIFIED:20171210T024310Z\nLOCATION:\nSEQUENCE:0\nSTATUS:CONFIRMED\nSUMMARY:運動（主：背）\nTRANSP:TRANSPARENT\nBEGIN:VALARM\nACTION:DISPLAY\nDESCRIPTION:This is an event reminder\nTRIGGER:-F0AB0H30C0D\nEND:VALARM\nBEGIN:VALARM\nACTION:EMAIL\nDESCRIPTION:This is an event reminder\nSUMMARY:Alarm notification\nATTENDEE:mailto:arvin0731@gmail.com\nTRIGGER:-F0AB0H30C0D\nEND:VALARM\nEND:VEVENT</code></pre></div>\n<h2 id=\"既然是-google就會有-api\" style=\"position:relative;\"><a href=\"#%E6%97%A2%E7%84%B6%E6%98%AF-google%E5%B0%B1%E6%9C%83%E6%9C%89-api\" aria-label=\"既然是 google就會有 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>既然是 Google，就會有 API</h2>\n<p>沒辦法直接載到資料，那就從 API 取得吧！</p>\n<p>Google 最棒的一點就是有一堆 API，而為人詬病的剛好是這些 API 常常沒有完善的 Doc。</p>\n<p>幸運的是，Google Calendar API 的文件還蠻好懂的，因為給了一個<a href=\"https://developers.google.com/google-apps/calendar/quickstart/nodejs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">直接可以複製來用的範例 Sample</a>（笑</p>\n<p>直接照著步驟做就可以了，他有很多實作版本，我是用熟悉的 Node.js 來幫我爬取資料。</p>\n<p>唯一要注意的是步驟一中的 <a href=\"https://console.developers.google.com/start/api?id=calendar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this wizard</a> 要好好照著說明執行，即便他步驟看起來有些匪夷所思，像是要你到某一頁後按下 <code class=\"language-text\">Cancel</code> button (eg. On the Add credentials to your project page, click the Cancel button.)</p>\n<p>當你設定好一切，取得 OAuth2 需要的 credentials 後，可以參照他下面的範例依據你想要的資料作修改，比較關鍵的程式是這幾行：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">    <span class=\"token keyword\">var</span> calendar <span class=\"token operator\">=</span> google<span class=\"token punctuation\">.</span><span class=\"token function\">calendar</span><span class=\"token punctuation\">(</span><span class=\"token string\">'v3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> queryOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        auth<span class=\"token operator\">:</span> auth<span class=\"token punctuation\">,</span>\n        calendarId<span class=\"token operator\">:</span> <span class=\"token string\">'primary'</span><span class=\"token punctuation\">,</span>\n        timeMax<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        singleEvents<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        orderBy<span class=\"token operator\">:</span> <span class=\"token string\">'startTime'</span><span class=\"token punctuation\">,</span>\n        maxResults<span class=\"token operator\">:</span> <span class=\"token number\">2500</span> <span class=\"token comment\">// 不給 maxResults 的話，預設值就是 2500</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pageToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        queryOptions<span class=\"token punctuation\">.</span>pageToken <span class=\"token operator\">=</span> pageToken<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    calendar<span class=\"token punctuation\">.</span>events<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span>queryOptions<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ... 從 response 中取得需要的資料</span>\n        <span class=\"token comment\">// var events = response.items;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>我們使用的是 v3 的 google calendar api，利用 <code class=\"language-text\">calendar.events.list</code> 可以取得某個 Calendar 的 events 列表，在 <code class=\"language-text\">queryOptions</code> 中，比較重要的有下面幾個:</p>\n<p><code class=\"language-text\">auth</code> 就是你在 <a href=\"https://console.developers.google.com/start/api?id=calendar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this wizard</a> 中產生的 credentials，你在頁面上就能找到下載 json 的連結：</p>\n<p><img src=\"/image/googleapi-credentials.png\" alt=\"download credentials\"></p>\n<p><code class=\"language-text\">calendarId</code> 是你想抓取的 Calendar 名稱，primary 指的是你登入帳號的主要日曆。</p>\n<p><code class=\"language-text\">timeMax</code> (or <code class=\"language-text\">timeMin</code>) 可以用來規範你想抓取哪段時間內的 events。</p>\n<p>最後是 <code class=\"language-text\">pageToken</code>，由於 Google Calendar API 有限制，你一次最多只能抓取 2500 個 events，即便你有設定 <code class=\"language-text\">maxResults</code> 這個參數也一樣。因此你會需要透過每次 API request 回傳的 <code class=\"language-text\">nextPageToken</code> 來進行下一頁的 Query。（沒錯，response 回來的是 <code class=\"language-text\">nextPageToken</code>，但你下 Query 時帶的是 <code class=\"language-text\">pageToken</code>，請注意！）</p>\n<p>可以設定的參數還非常多，可以從 Google 提供的 <a href=\"https://developers.google.com/apis-explorer/#p/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API Explorer</a> 中選取 <code class=\"language-text\">Calendar API</code> 來測試看看哪樣的參數是你需要的！每個參數都有對應的說明，還算清楚。</p>\n<p>我在這部分的實作放在 <a href=\"https://gist.github.com/ArvinH/a46f9af2df4316651d2056e610ba68b1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Gist</a> 上，有興趣可以參考，寫得很暴力簡陋，畢竟這不是這次的重點～</p>\n<p>主要是依照日曆中每筆 Event 的時間與顏色做分類與統計，依照不同顏色（也就是不同類別）分別存放到不同檔案。</p>\n<p>資料格式也很簡單：</p>\n<div class=\"gatsby-highlight\" data-language=\"csv\"><pre class=\"language-csv\"><code class=\"language-csv\"><span class=\"token value\">date</span><span class=\"token punctuation\">,</span><span class=\"token value\">colorIdNum</span>\n<span class=\"token value\">2017-10-10</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">2017-10-11</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">2017-10-12</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">2017-10-13</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">2017-10-14</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">2017-10-15</span><span class=\"token punctuation\">,</span><span class=\"token value\">1</span>\n<span class=\"token value\">...</span>\n<span class=\"token value\">..</span>\n<span class=\"token value\">.</span></code></pre></div>\n<h1 id=\"資料有了終於能開始畫圖了\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E6%9C%89%E4%BA%86%E7%B5%82%E6%96%BC%E8%83%BD%E9%96%8B%E5%A7%8B%E7%95%AB%E5%9C%96%E4%BA%86\" aria-label=\"資料有了終於能開始畫圖了 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料有了終於能開始畫圖了！</h1>\n<p>主要參考 <a href=\"https://bl.ocks.org/mbostock/4063318\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Mike Bostock 大神的作品</a>，改成只繪製單一年度圖表，並加上切換資料後的動畫。</p>\n<p>接下來是手把手說明：</p>\n<p>我們總共需要三個 Function：<code class=\"language-text\">DrawCalendar</code>、<code class=\"language-text\">UpdateCalendar</code> 與 <code class=\"language-text\">changeDataSrc</code>，分別用來繪製圖表、更新圖表與更新資料。</p>\n<p>最主要的當然就是 <code class=\"language-text\">DrawCalendar</code>。繪製日曆又可分為三個步驟：</p>\n<h3 id=\"steps-i-設定日曆基本外觀大小顏色svg-container\" style=\"position:relative;\"><a href=\"#steps-i-%E8%A8%AD%E5%AE%9A%E6%97%A5%E6%9B%86%E5%9F%BA%E6%9C%AC%E5%A4%96%E8%A7%80%E5%A4%A7%E5%B0%8F%E9%A1%8F%E8%89%B2svg-container\" aria-label=\"steps i 設定日曆基本外觀大小顏色svg container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps I: 設定日曆基本外觀（大小、顏色、svg container）</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">DrawCalendar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataSrc</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> width <span class=\"token operator\">=</span> <span class=\"token number\">960</span><span class=\"token punctuation\">,</span>\n      height <span class=\"token operator\">=</span> <span class=\"token number\">136</span><span class=\"token punctuation\">,</span>\n      cellSize <span class=\"token operator\">=</span> <span class=\"token number\">17</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> formatPercent <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> color <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">scaleQuantize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">domain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"#006837\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#1a9850\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#66bd63\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#a6d96a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d9ef8b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffffbf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#fee08b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#fdae61\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f46d43\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d73027\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#a50026\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// ..</span>\n  <span class=\"token comment\">// .</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面這段很單純的就是設置好圖表的基本資訊，包含寬、高與日曆中每\"天\"的格子大小，利用 <code class=\"language-text\">d3.scaleQuantize()</code> 創建一個 color 函數，用來將之後的資料映射到對應的顏色。</p>\n<p>這邊有個 <code class=\"language-text\">d3.format(\"d\")</code> 的函數，其實在這邊用不到，但還是想介紹一下。\n<code class=\"language-text\">d3.format()</code> 是個方便你正規化資料數值的函式，例如你想將數值侷限在小數點後兩位，就可以用 <code class=\"language-text\">d3.format(\"2f\")</code>，或是想轉換成百分比，可以用 <code class=\"language-text\">d3.format(\".2%\")</code>，這樣會將你輸入的數值乘上 100 後，再加上百分比符號，並依照 % 前的數字來決定小數點後的位數。</p>\n<p>eg. d3.format(\".2%\")(0.234) === 20.34% <a href=\"http://www.oxxostudio.tw/articles/201501/svg-d3-12-formatting.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">(可參考此網站說明)</a></p>\n<p>接著是繪製主要的 calendar chart svg container：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> svg <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#calendar-chart\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"svg\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>d3<span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2017</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2018</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"svg\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"width\"</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"g\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transform\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"translate(\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>width <span class=\"token operator\">-</span> cellSize <span class=\"token operator\">*</span> <span class=\"token number\">53</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\",\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>height <span class=\"token operator\">-</span> cellSize <span class=\"token operator\">*</span> <span class=\"token number\">7</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  svg<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transform\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"translate(-6,\"</span> <span class=\"token operator\">+</span> cellSize <span class=\"token operator\">*</span> <span class=\"token number\">3.5</span> <span class=\"token operator\">+</span> <span class=\"token string\">\") rotate(-90)\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"font-family\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"sans-serif\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"font-size\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"text-anchor\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"middle\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/d3/d3-array#range\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">d3.range()</code></a> 會回傳根據你傳入的區間，回傳一段連續數值陣列。</p>\n<p>我們利用 <code class=\"language-text\">d3.range(2017, 2018)</code> 取得陣列資料，會回傳長度為一，包含 2017 這個數值的陣列 <code class=\"language-text\">[2017]</code>。</p>\n<p>你可能會想，為什麼我要這樣做？</p>\n<p>只需要一年的資料，就直接 append svg 就好呀，何必 binding 2017 這個值到 svg 的 <code class=\"language-text\">__data__</code> 裡面呢？</p>\n<p>賣個關子，待會看到 Steps II 你就會知道了！</p>\n<p>而剩下的部分就是利用 <code class=\"language-text\">transform</code> 來位移 svg，為整個圖表保留空間，並加上文字標記。</p>\n<h3 id=\"steps-ii-繪製日曆中的每一天也就是每個小格子啦\" style=\"position:relative;\"><a href=\"#steps-ii-%E7%B9%AA%E8%A3%BD%E6%97%A5%E6%9B%86%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%80%E5%A4%A9%E4%B9%9F%E5%B0%B1%E6%98%AF%E6%AF%8F%E5%80%8B%E5%B0%8F%E6%A0%BC%E5%AD%90%E5%95%A6\" aria-label=\"steps ii 繪製日曆中的每一天也就是每個小格子啦 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps II: 繪製日曆中的每一天（也就是每個小格子啦～）</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> rect <span class=\"token operator\">=</span> svg<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"g\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fill\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stroke\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ccc\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rect\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">timeDays</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rect\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"width\"</span><span class=\"token punctuation\">,</span> cellSize<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> cellSize<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d3<span class=\"token punctuation\">.</span>timeWeek<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>d3<span class=\"token punctuation\">.</span><span class=\"token function\">timeYear</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> cellSize<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"y\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">getDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> cellSize<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">datum</span><span class=\"token punctuation\">(</span>d3<span class=\"token punctuation\">.</span><span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%Y-%m-%d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  svg<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"g\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fill\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stroke\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#000\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">timeMonths</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d\"</span><span class=\"token punctuation\">,</span> pathMonth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>要繪製出一年中的 \"每一天\"，我們可以直接 for loop 跑 365 次，或是產生 365 筆資料，但更聰明的做法是利用 <a href=\"https://github.com/d3/d3-time#timeDays\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-time 提供的 timeDays 函數</a> 來幫我們產生出特定日期區間的日期資料！</p>\n<p><code class=\"language-text\">d3.timeDays(new Date(d, 0, 1), new Date(d + 1, 0, 1));</code></p>\n<p>其中 <code class=\"language-text\">new Date()</code> 的第一個參數 <code class=\"language-text\">d</code> 代表年，<code class=\"language-text\">0</code> 代表第一個月（月份從 0 開始），<code class=\"language-text\">1</code> 則是第一天，因此這邊會回傳 d 年到 d + 1 年間的每一天。</p>\n<p>好那問題來了，這個 <code class=\"language-text\">d</code> 是什麼呢？</p>\n<p>要回答這個問題，必須先了解一下 d3 中的 <code class=\"language-text\">selection.data()</code>。</p>\n<p>我以前都以為 <code class=\"language-text\">data()</code> 只能夠丟入資料陣列，但是在這次的實作過程中才發現，原來他可以接受函數！</p>\n<p>但他是怎麼運作的呢？我們偷看一下 <a href=\"https://github.com/d3/d3-selection/blob/master/src/selection/data.js#L94\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-selection 的原始碼</a></p>\n<p><img src=\"/image/d3-selection-src.png\" alt=\"d3-selection src\"></p>\n<p>真的蠻有趣的，他其實是先判斷你傳入的 <code class=\"language-text\">value</code> 是不是函數，若不是，會先利用 <code class=\"language-text\">constants()</code> 將你的值包裹過，讓他變成可執行的函數：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsconstants.js\"><pre class=\"language-jsconstants.js\"><code class=\"language-jsconstants.js\">export default function(x) {\n  return function() {\n    return x;\n  };\n}</code></pre></div>\n<p>他會將 <code class=\"language-text\">parent.__data__</code> 傳入該函數中執行，回傳的就會是該 <code class=\"language-text\">selector</code> 的 <code class=\"language-text\">__data__</code>。所以直接傳入 function 也是可行的！</p>\n<p>以我們的例子來說，<code class=\"language-text\">rect</code> 的 parent 就是 <code class=\"language-text\">svg</code>，而你們記得在 Steps I 時，我們 binding 陣列 <code class=\"language-text\">[2017]</code> 到 <code class=\"language-text\">svg</code> 的 <code class=\"language-text\">__data__</code> 中嗎？這邊就派上用場了！在 rect 的 <code class=\"language-text\">data()</code> 中的函數所接收到的 <code class=\"language-text\">d</code> 值就是 <code class=\"language-text\">2017</code>。</p>\n<p>而上述的 <code class=\"language-text\">d3.timeDays(new Date(d, 0, 1), new Date(d + 1, 0, 1));</code> 就會回傳 2017 到 2018 中間 365 筆的日期資料！我們也因此得到 365 個小方塊啦！</p>\n<p>接著，利用類似的概念，使用 <code class=\"language-text\">d3.timeMonths()</code> 產生 12 筆月份資料，接著實作 <code class=\"language-text\">pathMonth()</code> 來畫出 svg path：</p>\n<div class=\"gatsby-highlight\" data-language=\"jspathmonth()\"><pre class=\"language-jspathmonth()\"><code class=\"language-jspathmonth()\">function pathMonth(t0) {\n  var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),\n    d0 = t0.getDay(), w0 = d3.timeWeek.count(d3.timeYear(t0), t0),\n    d1 = t1.getDay(), w1 = d3.timeWeek.count(d3.timeYear(t1), t1);\n  return &quot;M&quot; + (w0 + 1) * cellSize + &quot;,&quot; + d0 * cellSize\n    + &quot;H&quot; + w0 * cellSize + &quot;V&quot; + 7 * cellSize\n    + &quot;H&quot; + w1 * cellSize + &quot;V&quot; + (d1 + 1) * cellSize\n    + &quot;H&quot; + (w1 + 1) * cellSize + &quot;V&quot; + 0\n    + &quot;H&quot; + (w0 + 1) * cellSize + &quot;Z&quot;;\n}</code></pre></div>\n<p>這段邏輯看似複雜，其實很直覺。</p>\n<p><a href=\"https://github.com/d3/d3-time#interval_count\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">d3.timeWeek.count(start, end)</code></a> 可以計算出 start 到 end 這兩個日期間有幾週。</p>\n<p><code class=\"language-text\">t0</code> 是目前傳入的時間，依照 d3.timeMonths() 的產出，會是一個月的第一天，<code class=\"language-text\">t1</code> 則是該月的月底。\n<code class=\"language-text\">d0</code> 與 <code class=\"language-text\">d1</code> 就是單純的 <code class=\"language-text\">t0</code>、<code class=\"language-text\">t1</code> 對應的 day，就是星期幾。\n<code class=\"language-text\">w0</code> 算出從 <code class=\"language-text\">t0</code> 該年的第一天到 <code class=\"language-text\">t0</code> 有幾週，依此類推 <code class=\"language-text\">w1</code> 就是相對於 <code class=\"language-text\">t1</code>。</p>\n<p>用這些數值就能夠 <code class=\"language-text\">M(移動)</code> 到月初的位置，並往下移動 7 天 <code class=\"language-text\">V 7*cellSize</code>，接著在水平位移(H) 到月底的位置，然後垂直位移到月底日期的星期位置<code class=\"language-text\">(d1 +1) * cellSize</code>，最後為到原點把整個月份框起來。</p>\n<p>svg path 的繪製方法可以[參考這篇](<a href=\"http://www.oxxostudio.tw/articles/201406/svg-04-path-1.html%E3%80%82\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://www.oxxostudio.tw/articles/201406/svg-04-path-1.html。</a></p>\n<p>到目前為止可以畫出如下的圖：</p>\n<p><img src=\"/image/months-outline.png\" alt=\"outline\"></p>\n<h3 id=\"steps-iii-該開始-binding-資料了\" style=\"position:relative;\"><a href=\"#steps-iii-%E8%A9%B2%E9%96%8B%E5%A7%8B-binding-%E8%B3%87%E6%96%99%E4%BA%86\" aria-label=\"steps iii 該開始 binding 資料了 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps III: 該開始 Binding 資料了</h3>\n<p>再來算是最後一步了，我們將資料綁定並填入剛剛產生的格子中！</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">d3<span class=\"token punctuation\">.</span><span class=\"token function\">csv</span><span class=\"token punctuation\">(</span>dataSrc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> csv</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> data <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">nest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 將 date 抽到外層當 key</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">key</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 透過 rollup 將 value 設為 colorId</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">rollup</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">+</span>d<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>colorIdNum<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span>csv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  rect<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> d <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 找出有 match 到的日期，表示那天我有做事 XD</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fill\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>d<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> d <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">formatPercent</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>d<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>這邊主要就兩個步驟，第一步先用 <a href=\"https://github.com/d3/d3-collection#nests\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3.nest</a> 來整理資料，我們需要把陣列中每筆資料的 \"date\" 抓出來當 Key，如此一來，在第二步中，我們可以直接利用 <code class=\"language-text\">d in data</code> 的語法在 <code class=\"language-text\">selection.filter()</code> 中進行過濾，選出 365 個格子中，哪些有跟我們真正的 csv 日期資料 match，有 match 到的格子，我們填入顏色！（使用最前面的 color 函數來做映射）</p>\n<p>填入和顏色後：</p>\n<p><img src=\"/image/color-calendar.png\" alt=\"填入資料顏色後的 calendar\"></p>\n<h3 id=\"steps-iv-加入動態切換資料的功能\" style=\"position:relative;\"><a href=\"#steps-iv-%E5%8A%A0%E5%85%A5%E5%8B%95%E6%85%8B%E5%88%87%E6%8F%9B%E8%B3%87%E6%96%99%E7%9A%84%E5%8A%9F%E8%83%BD\" aria-label=\"steps iv 加入動態切換資料的功能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps IV: 加入動態切換資料的功能</h3>\n<p>最後我們實作一下綁定在 <code class=\"language-text\">&lt;select></code> 元素上的 <code class=\"language-text\">onchange</code> 函數來做資料切換，而在圖表方面，我們只需要選取出 <code class=\"language-text\">rect</code> 並重新 <code class=\"language-text\">filter</code> 資料即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 切換資料</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">changeDataSrc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> x <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dataSrcSelector\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">UpdateCalendar</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">calendarData-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>x<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.csv</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 更新圖表，加上 `transition()` 與 `duration()` 讓過程滑順一些</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">UpdateCalendar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataSrc</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// ..</span>\n  d3<span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rect'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> d <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">transition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">duration</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fill\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>d<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  d3<span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rect'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>d <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">transition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">duration</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fill\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"成果\" style=\"position:relative;\"><a href=\"#%E6%88%90%E6%9E%9C\" aria-label=\"成果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>成果</h2>\n<p><img src=\"/image/calendar-d3.gif\" alt=\"final demo\">\n<a href=\"https://bl.ocks.org/ArvinH/56909246bd584743fa5ee7ad148ad1ac\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Demo 與完整的程式碼</a></p>\n<p>嗯～看起來我工作頗認真，不過等等...怎麼好像週末顏色都比較深啊哈哈哈...哈哈..哈..嗚嗚嗚</p>\n<h1 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h1>\n<p>當初開始在 Google Calendar 上紀錄日誌時，並沒有想到可以在年終的時候進行整年的 review，所以每天的紀錄都很隨性，並沒有很完整的進行分類，有些可惜，但還是能透過資料視覺化的結果，看出我在時間分配的掌控度有相當的進步空間，像是花在工作與培養額外興趣（娛樂）的時間有蠻大的落差。</p>\n<p>不管怎麼說，有了這次的經驗，相信明年的 Year End Review 會更好！\n如果你也覺得這樣做有趣，或許可以加入我的行列，也或許想想有什麼方式可以為你自己進行一次年終 Review，相信都會有所收穫！</p>\n<h3 id=\"資料來源\" style=\"position:relative;\"><a href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\" aria-label=\"資料來源 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>資料來源</h3>\n<ol>\n<li><a href=\"http://www.oxxostudio.tw/articles/201501/svg-d3-12-formatting.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3 formatting</a></li>\n<li><a href=\"https://github.com/d3/d3-time\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-time</a></li>\n<li><a href=\"https://github.com/d3/d3-array\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-array</a></li>\n<li><a href=\"https://github.com/d3/d3-collection\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">d3-collection</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Date\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MDN Date</a></li>\n<li><a href=\"https://bl.ocks.org/mbostock/4063318\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mbostock calendar view</a></li>\n<li><a href=\"https://developers.google.com/google-apps/calendar/quickstart/nodejs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Calendar API</a></li>\n</ol>","id":"6b27745a-f793-5c6c-8bf7-d8d3ba7bb33b","fields":{"slug":"d-3-v-4-calendar-yearendreview"},"frontmatter":{"date":"2017-12-12T21:10:27.000Z","title":"一起用 Google Calendar 與 D3.js 進行年終回顧吧！","tags":["google","google calendar api","d3","d3v4","data visualization"],"type":"tech","slug":"d3v4-calendar-yearendreview"},"timeToRead":15}],"tagName":"google calendar api","type":"tech"}},"staticQueryHashes":["2123680655"]}