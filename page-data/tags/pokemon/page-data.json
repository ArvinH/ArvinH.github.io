{"componentChunkName":"component---src-templates-tag-tsx","path":"/tags/pokemon","result":{"pageContext":{"posts":[{"excerpt":"（最近的辦公室日常...）\n\"欸欸欸！ 有乾爹撒花！！\"\n\"有傑尼龜！\"\n\"Gotcha!! 偉哉乾爹！感恩乾爹！\"","html":"<blockquote>\n<p>（最近的辦公室日常...）\n\"欸欸欸！ 有乾爹撒花！！\"\n\"有傑尼龜！\"\n\"Gotcha!! 偉哉乾爹！感恩乾爹！\"</p>\n</blockquote>\n<!-- more -->\n<p>自從 Pokemon Go 在台灣可以玩後，勾起了我許多兒時回憶，因此除了跟著大家一起抓神奇寶貝以外（對我就是不想講寶可夢啊啊啊），我也稍微去追了一下最新版的神奇寶貝動畫，似乎是在打什麼卡洛斯聯盟，也出現了好奇怪的 Mega 進化，會讓神奇寶貝在戰鬥中轉屬性...</p>\n<p>咳咳，等等，再講下去這整篇都是神奇寶貝了...</p>\n<p>總之，看到會轉屬性這件事情就讓我想到，我小時候從來都沒有認真研究過哪種屬性剋哪種屬性，只知道基本的水剋火之類的，於是乎決定來好好研究一下，順便練習已經出來一陣子的 D3 v4，看看差異性在哪。</p>\n<p>幸運的是，當我在搜尋 Pokemon 的 API 時，發現 <a href=\"http://filipekiss.github.io/pokemon-type-chart/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://filipekiss.github.io/pokemon-type-chart/</a> 這個人已經把我想做的做完了 XD 也做得不錯。不過是兩三年前的專案，用的是 D3 v3。雖然點子已經被做完了，但臨摹也是一種學習，所以我們就來把它 Migrate 到 D3 v4，順便看看有哪些值得注意的地方吧！</p>\n<p>想直接看 code 的在這邊... <a href=\"http://bl.ocks.org/arvinh/b30ed888914a2794830ceb023c911a5b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span style=\"color: #c40522;\">成果 與 程式碼</span></a></p>\n<h2 id=\"介紹\" style=\"position:relative;\"><a href=\"#%E4%BB%8B%E7%B4%B9\" aria-label=\"介紹 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>介紹</h2>\n<img src=\"/image/pokemontype.png\" alt=\"pokemon type\" style=\"width: 500px;\"/>\n<p>這張圖乍看之下我原本以為是修改自 Chord Diagram，但其實是來自於 Cluster。想想也對，屬性間的關係的確類似於階層樹狀，也不需要有比例分佈對應。\n( 從程式碼看來，原作者應該是修改自 <a href=\"https://bl.ocks.org/mbostock/7607999\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://bl.ocks.org/mbostock/7607999</a> )</p>\n<p>使用方法很簡單，只要點擊某個屬性，就會列出該屬性對哪些屬性較為強勢 (Strong)、弱勢 (Weak) 或是 免疫 (Immune)，同時點擊兩種屬性的話，就會秀出擁有雙重屬性的結果為何。</p>\n<h2 id=\"解析\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%9E%90\" aria-label=\"解析 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解析</h2>\n<p>由於 D3 v4 的變動幅度很大，為了模組化，將很多 packages 都拆出來，替代以往使用 namespace 的方式，因此最單純的 Migration 方式就是直接重刻並設法 re-use 原來的 code。</p>\n<p>首先，基本的 <code class=\"language-text\">index.html</code> 內定義好圖要畫在哪裡，並加上一個 reset button 來還原圖表狀態：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>typeChart<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>graph<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>button reset<span class=\"token punctuation\">\"</span></span><span class=\"token special-attr\"><span class=\"token attr-name\">onclick</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\"><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>reset<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>接著，我們需要先定義 <code class=\"language-text\">layout</code>，這邊使用 Cluster Layout，在原本的 D3 v3 版本中，使用的方式為：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsv3.js\"><pre class=\"language-jsv3.js\"><code class=\"language-jsv3.js\">  var diameter = 750,\n      radius = diameter / 2,\n      innerRadius = radius - 120;\n  var cluster = d3.layout.cluster()\n      .size([360, innerRadius])\n      .sort(null)\n      .value(function(d) { return d.size; });</code></pre></div>\n<p>然而，v4 模組化後，原本的 namespace 都不需要了，因為實際上是個別存放在一個 lib 底下，以 Layout 來說 會放在 <code class=\"language-text\">d3-hierarchy</code>，而使用方式則變成直接呼叫 <code class=\"language-text\">d3.cluster()</code> 即可，原有的 <code class=\"language-text\">sort()</code>, <code class=\"language-text\">value()</code>等 method 也都移到 <code class=\"language-text\">node</code> 這個層級底下了（後面會在講到 node）：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsv4.js\"><pre class=\"language-jsv4.js\"><code class=\"language-jsv4.js\">  // 定義圖形的基本設定值\n  var diameter = 750,\n      radius = diameter / 2,\n      innerRadius = radius - 120;\n\n  var cluster = d3.cluster()\n      .size([360, innerRadius]);</code></pre></div>\n<p>寫好圖形的基本設定值後，先把我們已知的 svg 放上去吧！\n我們先把剛剛定義好的 <code class=\"language-text\">diameter</code>, <code class=\"language-text\">radius</code> 的值 append 到最外層的 graph div 上，\n接著先把待會會用到的四種 svg group 先記錄起來，分別有 immune (免疫)、weak (弱勢)、strong (強勢)、node (屬性)</p>\n<div class=\"gatsby-highlight\" data-language=\"jsweaknesses-graph.js\"><pre class=\"language-jsweaknesses-graph.js\"><code class=\"language-jsweaknesses-graph.js\">var svg = d3.select(&quot;#typeChart &gt; #graph&quot;).append(&quot;svg&quot;)\n    .attr(&quot;width&quot;, diameter)\n    .attr(&quot;height&quot;, diameter)\n    .append(&quot;g&quot;)\n    .attr(&quot;transform&quot;, &quot;translate(&quot; + radius + &quot;,&quot; + radius + &quot;)&quot;);\n\nvar immune = svg.append(&quot;g&quot;).selectAll(&quot;.immune&quot;),\n    weak = svg.append(&quot;g&quot;).selectAll(&quot;.weak&quot;),\n    strong = svg.append(&quot;g&quot;).selectAll(&quot;.strong&quot;),\n    node = svg.append(&quot;g&quot;).selectAll(&quot;.node&quot;);</code></pre></div>\n<p>我蠻喜歡這樣的寫法，將與資料繪製較無關（相對較固定）的程式碼先寫好，接著再利用 <code class=\"language-text\">d3.json</code> 將資料讀入後去繪製。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsdraw-graph\"><pre class=\"language-jsdraw-graph\"><code class=\"language-jsdraw-graph\">d3.json(&quot;types.json&quot;, function(error, classes) {\n    var nodes = cluster(d3.hierarchy(packageHierarchy(classes))).children;\n    var immunes = typeImmune(nodes);\n    var strengths = typeStrong(nodes);\n    var weaknesses = typeWeak(nodes);\n\n    // draw path\n\n    ......\n    ....\n    ..\n\n    //Make the immune links\n    function typeImmune(nodes) {\n    var map = {},\n        immunes = [];\n\n    nodes.forEach(function(d) {\n        map[d.data.name] = d;\n    });\n\n    nodes.forEach(function(d) {\n        if (d.data.immunes) d.data.immunes.forEach(function(i) {\n            immunes.push({\n                source: map[d.data.name],\n                target: map[i]\n            });\n        });\n    });\n\n        return immunes;\n    }\n    // 以下先省略\n});</code></pre></div>\n<p>解釋一下上面這段程式碼，我們的資料存放在 types.json 中，利用 d3.json 將資料讀出後，\n會先做兩件事情：</p>\n<ol>\n<li>將資料轉化成 hierarchy 格式，並初始化 cluster</li>\n<li>將產生的 nodes 轉化並分類成 immunes, strengths, weaknesses。</li>\n</ol>\n<p>這邊的 <code class=\"language-text\">packageHierarchy</code> 主要是將 raw data 整理成有父子關係的 structure，並且給予每筆資料自己的 <code class=\"language-text\">key</code> 與 <code class=\"language-text\">name</code>。（詳細程式碼可以到最後的連結看，這部分比較跟資料格式相關，就不放在這裡佔版面了）</p>\n<p>在原本 v3 的做法裡，如果我們要把資料轉化成 hierarchy 的格式，可以直接利用 <code class=\"language-text\">cluster.nodes()</code> ，即可一次初始化 cluster 並且得到擁有 x, y 值 的 nodes，但在 v4 中，我們必須先利用 <code class=\"language-text\">d3.hierarchy()</code> 將資料轉化成 hierarchy 格式，建立好父子關係與每個 node 的深度，接著才能丟入 <code class=\"language-text\">cluster</code> 中初始，其回傳值才會是擁有對應 cluster 內 x, y 值的 nodes。</p>\n<p><code class=\"language-text\">window.nodes = cluster(d3.hierarchy(packageHierarchy(classes))).children;</code>\n(這邊取 children 也只是資料格式的關係)</p>\n<p>由於繪製 <code class=\"language-text\">svg path</code> 需要給訂 data 的 source 與 target，因此這邊利用 <code class=\"language-text\">typeImmune</code>, <code class=\"language-text\">typeStrong</code>, <code class=\"language-text\">typeWeak</code> 來作轉換，也將資料分為這三種關係的 path 來繪製。</p>\n<p>接著，轉換好後就能根據 node 的 <code class=\"language-text\">source</code> 與 <code class=\"language-text\">target</code> 繪製 path。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsdraw-path\"><pre class=\"language-jsdraw-path\"><code class=\"language-jsdraw-path\">// 這邊只列出一種\nwindow.immune = immune\n        .data(immunes.map(function(node){\n            return node.source.path(node.target);\n        }))\n        .enter().append(&quot;path&quot;)\n        .each(function(d) {\n            d.source = d[0], d.target = d[d.length - 1];\n        })\n        .attr(&quot;class&quot;, &quot;immune&quot;)\n        .attr(&quot;d&quot;, line);</code></pre></div>\n<p>以往在 v3，我們可以事先定義 <code class=\"language-text\">var bundle = d3.layout.bundle();</code>，然後在上面這段程式碼中的 <code class=\"language-text\">data()</code> 中呼叫 <code class=\"language-text\">bundle(immunes)</code>，他就會幫我們把 source 跟 target 做連接。</p>\n<p>但是在 v4 裡，<code class=\"language-text\">bundle</code> 被 <code class=\"language-text\">node.path()</code> 給取代了。</p>\n<p>注意喔！是 <code class=\"language-text\">node.path()</code>，層級是在 node，因此我們要從剛才分類好的 immunes 中將 node 一個一個抓出來呼叫。</p>\n<p>另外在這邊我們有用一個 <code class=\"language-text\">each()</code> 來將每筆 node 資料都加上 <code class=\"language-text\">d.source = d[0], d.target = d[d.length - 1];</code>\n原因是為了之後我們點擊每個類別的時候，要利用這個來找出對應的點來上色。</p>\n<div class=\"gatsby-highlight\" data-language=\"jscolorpath.js\"><pre class=\"language-jscolorpath.js\"><code class=\"language-jscolorpath.js\">window.colorPath = function(d, l, type) {\n      var type = type || &#39;strong&#39;;\n      if (type == &#39;strong&#39;) {\n        if (l.target === d) return l.source.target = true;\n      }\n      if (type == &#39;weak&#39;) {\n        for (type in d) {\n          if(type !== &quot;size&quot;) {\n            if (l.target === d[type]) return l.source.target = true;\n          }\n        }\n      }\n    }</code></pre></div>\n<p>到目前為止，已經把原本 v3 的 cluster layout 轉移到 v4 了，其餘繪製部分就與版本沒有什麼關聯性，需要注意的是資料格式的變動，像是在原本作者的程式碼內，點擊類別的 <code class=\"language-text\">activate()</code> 函數中，根據 <code class=\"language-text\">d.name</code> 來判斷位置的部分，由於資料格式的變動，要改為 <code class=\"language-text\">d.data.name</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsactivate(d).js\"><pre class=\"language-jsactivate(d).js\"><code class=\"language-jsactivate(d).js\">    window.node\n        .classed(&quot;node--active&quot;, function(target) {\n            return (target === d) || this.classList.contains(&quot;node--active&quot;);\n        })\n        .classed(&quot;node--target&quot;, function(n) {\n            return n.target;\n        })\n        .classed(&quot;immune-node&quot;, function(target, l) {\n            return (this.classList.contains(&#39;immune-node&#39;) || target.data.immunes.indexOf(d.data.name) != -1);\n        })\n        ....\n        ...\n        ..</code></pre></div>\n<p>其餘繪製部分，包含點擊後的上色邏輯（ activate() 函數中），有興趣的讀者就直接看 code 吧，相信會更清楚！</p>\n<p><a href=\"http://bl.ocks.org/arvinh/b30ed888914a2794830ceb023c911a5b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span style=\"font-size: 20px; color: #c40522;\">成果 與 程式碼</span></a></p>\n<p>不過實際上我並沒有完整 Migration 完成，在原本 v3 的 <code class=\"language-text\">d3.svg.line.radial()</code> 這裡，v4 的寫法應該是 <code class=\"language-text\">d3.radialLine()</code>，並搭配上 <code class=\"language-text\">curve()</code> 函數，只是我並沒有嘗試成功，還請高手指教！</p>\n<p>最後，送給大家一隻純 CSS 卡比獸，祝大家早日成為神奇寶貝大師！\n（好啦其實不像XD...畢竟我對 css 的掌控度大概跟我對腰間肥肉的掌控度一樣低落...）</p>\n<p data-height=\"448\" data-theme-id=\"dark\" data-slug-hash=\"dXLvVm\" data-default-tab=\"css,result\" data-user=\"arvin0731\" data-embed-version=\"2\" class=\"codepen\">See the Pen <a href=\"http://codepen.io/arvin0731/pen/dXLvVm/\">Snorlax-pokemon</a> by Arvin (<a href=\"http://codepen.io/arvin0731\">@arvin0731</a>) on <a href=\"http://codepen.io\">CodePen</a>.</p>\n<script async src=\"//assets.codepen.io/assets/embed/ei.js\"></script>","id":"473e535d-2e0b-55bb-8fa9-08d856ed9c3a","fields":{"slug":"d-3-pokemon"},"frontmatter":{"date":"2016-08-19T20:26:11.000Z","title":"用 D3.js v4 看 Pokemon 屬性表","tags":["d3","pokemon","d3v4","data visualization"],"type":"tech","slug":"d3-pokemon"},"timeToRead":7}],"tagName":"pokemon","type":"tech"}},"staticQueryHashes":["2123680655"]}